unit worksheet;

interface

uses
  Windows, Messages, SysUtils, Classes, Graphics, Controls, Forms, Dialogs,
  StdCtrls, Mask, ToolEdit, Db, DBTables, Grids, DBGridEh, Buttons, Menus,
  DBClient, MConnect, SConnect, ComCtrls, ExtCtrls, DBCtrls, Spin, filectrl,
  Variants, shellapi, GridsEh, QExport3, QExport3XLS, ADODB, cxStyles,
  cxCustomData, cxGraphics, cxFilter, cxData, cxDataStorage, cxEdit,
  cxDBData, cxButtonEdit, cxGridLevel, cxGridCustomTableView,
  cxGridTableView, cxGridBandedTableView, cxGridDBBandedTableView,
  cxClasses, cxControls, cxGridCustomView, cxGrid, cxGridCustomPopupMenu,
  cxGridPopupMenu, cxDropDownEdit, siComp;

  function Calcdays(var year,month,day:word):integer;
  function ceiling(var double1:double):integer;
  function calcwkno(var dt1:tdatetime):integer;
  function calcdiffday(var dt1,dt2:tdatetime):integer;

type
  Tworksheet1 = class(TForm)
    DataSource1: TDataSource;
    PopupMenu1: TPopupMenu;
    ClientDataSet1: TClientDataSet;
    tblshedule: TClientDataSet;
    ClientDataSet2: TClientDataSet;
    ClientDataSet3: TClientDataSet;
    tblshedulePline: TStringField;
    tblshedulePlan_date: TDateField;
    tblsheduleArtno: TStringField;
    tblsheduleAcol: TStringField;
    tblsheduleCfksrq: TDateField;
    tblsheduleSeq: TIntegerField;
    tblsheduleWeek: TIntegerField;
    tblsheduleKhzl: TStringField;
    tblsheduleScqty: TIntegerField;
    tblsheduleTmu: TFloatField;
    tblsheduleTrs: TIntegerField;
    tblsheduleFyl: TFloatField;
    tblsheduleXjs: TIntegerField;
    tblsheduleJxjs: TFloatField;
    tblsheduleJhl: TFloatField;
    tblsheduleCfwcrq: TDateField;
    tblsheduleSctd: TIntegerField;
    tblsheduleBcjs: TIntegerField;
    tblshedulePd4: TDateField;
    tblsheduleYsjhl: TFloatField;
    tblsheduleDbxl: TFloatField;
    tblshedulePd8: TDateField;
    tblsheduleBzjs: TIntegerField;
    tblsheduleTzlcrq: TDateField;
    tblsheduleFlag1: TStringField;
    tblsheduleFlag2: TStringField;
    tblsheduleFlag3: TStringField;
    tblsheduleFlag4: TStringField;
    tblsheduleRqxc: TIntegerField;
    tblsheduleQrlcrq: TDateField;
    tblsheduleKdjs: TIntegerField;
    tblsheduleWeek1: TIntegerField;
    tblsheduleFyfs: TStringField;
    tblsheduleFlag5: TStringField;
    N1: TMenuItem;
    tblsheduleCkts: TIntegerField;
    N2: TMenuItem;
    tblsheduleOkhrq: TDateField;
    tblsheduleQrxc: TIntegerField;
    ClientDataSet5: TClientDataSet;
    Panel1: TPanel;
    Label1: TLabel;
    Label2: TLabel;
    SpeedButton1: TSpeedButton;
    Edit1: TEdit;
    Edit2: TEdit;
    Panel2: TPanel;
    BitBtn1: TBitBtn;
    BitBtn2: TBitBtn;
    BitBtn3: TBitBtn;
    BitBtn4: TBitBtn;
    Panel3: TPanel;
    tblsheduleOrdline: TIntegerField;
    tblsheduleSopno: TStringField;
    Label3: TLabel;
    GetTMU1: TMenuItem;
    tblsheduleYzh: TBooleanField;
    tblsheduleJ2_job: TStringField;
    tblsheduleJ_no: TStringField;
    tblsheduleXS: TIntegerField;
    Label5: TLabel;
    Edit4: TEdit;
    tblsheduleTSHOP: TStringField;
    tblshedulePFLAG1: TStringField;
    BitBtn5: TBitBtn;
    tblsheduleCSTYLE: TStringField;
    tblsheduleDBZS: TStringField;
    tblsheduleFLAG6: TStringField;
    tblsheduleFCCS: TStringField;
    Label6: TLabel;
    Edit5: TEdit;
    tblsheduleTPLANT: TStringField;
    Label7: TLabel;
    Edit6: TEdit;
    tblsheduleJHRS: TStringField;
    tblshedulePLAN_W: TStringField;
    tblsheduleYQ_W: TStringField;
    tblsheduleTZ_W: TStringField;
    tblsheduleRWO: TStringField;
    tblsheduleRID: TIntegerField;
    tblsheduleHC: TIntegerField;
    tblsheduleLFLAG: TStringField;
    tblsheduleLSTRS: TFloatField;
    tblsheduleNSHJS: TIntegerField;
    tblsheduleZJS: TFloatField;
    tblshedulePHISZJS: TFloatField;
    tblsheduleZHJS: TFloatField;
    tblsheduleZKTD: TFloatField;
    tblsheduleSCLHJS: TFloatField;
    tblsheduleSHJS: TFloatField;
    tblsheduleQYJS: TFloatField;
    tblsheduleLEARN: TFloatField;
    tblsheduleUNBAL: TFloatField;
    tblsheduleXC1: TSmallintField;
    tblsheduleXC2: TSmallintField;
    tblsheduleXC3: TSmallintField;
    tblsheduleYQLCRQ: TDateTimeField;
    tblsheduleSJRS: TFloatField;
    DataSource2: TDataSource;
    tblsheduleSJYC: TFloatField;
    tblsheduleCKJS: TFloatField;
    BitBtn7: TBitBtn;
    BitBtn8: TBitBtn;
    Label8: TLabel;
    ComboBox1: TComboBox;
    Label9: TLabel;
    ComboBox2: TComboBox;
    Label10: TLabel;
    ComboBox3: TComboBox;
    Label11: TLabel;
    Edit7: TEdit;
    Label4: TLabel;
    ComboBox4: TComboBox;
    Query1: TClientDataSet;
    Label12: TLabel;
    Edit3: TEdit;
    Label13: TLabel;
    ComboBox5: TComboBox;
    tblsheduleGRP: TStringField;
    tblsheduleRQXC1: TIntegerField;
    tblsheduleQTY: TIntegerField;
    tblsheduleTBU: TFloatField;
    tblsheduleCPLAN: TDateField;
    tblsheduleXC4: TIntegerField;
    BitBtn6: TBitBtn;
    chk2: TCheckBox;
    BitBtn9: TBitBtn;
    BitBtn10: TBitBtn;
    tblsheduleCFKSJS: TFloatField;
    tblsheduleCFWCJS: TFloatField;
    ClientDataSet4: TClientDataSet;
    Cancelx1: TMenuItem;
    Cancels1: TMenuItem;
    chk3: TCheckBox;
    tblsheduleLTC_D: TFloatField;
    tblsheduleLTC_R: TFloatField;
    tblsheduleLTC_A: TFloatField;
    tblsheduleLTC_RM: TStringField;
    tblsheduleLTC_KSRQ: TDateField;
    tblsheduleLTC_KSJS: TFloatField;
    tblsheduleDSQN: TStringField;
    tblsheduleFLAG7: TStringField;
    BitBtn11: TBitBtn;
    chk4: TCheckBox;
    WIPTransit1: TMenuItem;
    Label14: TLabel;
    Edit8: TEdit;
    chk6: TCheckBox;
    tblsheduleDTA: TStringField;
    tblsheduleCWO: TStringField;
    DataSet2: TADOQuery;
    GanttChart1: TMenuItem;
    BitBtn12: TBitBtn;
    Begin1: TMenuItem;
    End1: TMenuItem;
    cxGrid1: TcxGrid;
    cxView1: TcxGridDBBandedTableView;
    cxView1PLINE: TcxGridDBBandedColumn;
    cxView1FLAG1: TcxGridDBBandedColumn;
    cxView1J_NO: TcxGridDBBandedColumn;
    cxView1J2_JOB: TcxGridDBBandedColumn;
    cxView1CWO: TcxGridDBBandedColumn;
    cxView1RWO: TcxGridDBBandedColumn;
    cxView1FCCS: TcxGridDBBandedColumn;
    cxView1FLAG6: TcxGridDBBandedColumn;
    cxView1CSTYLE: TcxGridDBBandedColumn;
    cxView1JHRS: TcxGridDBBandedColumn;
    cxView1QTY: TcxGridDBBandedColumn;
    cxView1ACOL: TcxGridDBBandedColumn;
    cxView1DBZS: TcxGridDBBandedColumn;
    cxView1FLAG4: TcxGridDBBandedColumn;
    cxView1SCQTY: TcxGridDBBandedColumn;
    cxView1LSTRS: TcxGridDBBandedColumn;
    cxView1SJRS: TcxGridDBBandedColumn;
    cxView1TRS: TcxGridDBBandedColumn;
    cxView1SJYC: TcxGridDBBandedColumn;
    cxView1TBU: TcxGridDBBandedColumn;
    cxView1FLAG2: TcxGridDBBandedColumn;
    cxView1TMU: TcxGridDBBandedColumn;
    cxView1JXJS: TcxGridDBBandedColumn;
    cxView1PHISZJS: TcxGridDBBandedColumn;
    cxView1LFLAG: TcxGridDBBandedColumn;
    cxView1FLAG7: TcxGridDBBandedColumn;
    cxView1SHJS: TcxGridDBBandedColumn;
    cxView1ZJS: TcxGridDBBandedColumn;
    cxView1PLAN_DATE: TcxGridDBBandedColumn;
    cxView1CPLAN: TcxGridDBBandedColumn;
    cxView1XC4: TcxGridDBBandedColumn;
    cxView1FYFS: TcxGridDBBandedColumn;
    cxView1UNBAL: TcxGridDBBandedColumn;
    cxView1XC1: TcxGridDBBandedColumn;
    cxView1WEEK: TcxGridDBBandedColumn;
    cxView1FLAG3: TcxGridDBBandedColumn;
    cxView1CFKSRQ: TcxGridDBBandedColumn;
    cxView1CFKSJS: TcxGridDBBandedColumn;
    cxView1ZKTD: TcxGridDBBandedColumn;
    cxView1SCLHJS: TcxGridDBBandedColumn;
    cxView1QYJS: TcxGridDBBandedColumn;
    cxView1ZHJS: TcxGridDBBandedColumn;
    cxView1BCJS: TcxGridDBBandedColumn;
    cxView1DBXL: TcxGridDBBandedColumn;
    cxView1CFWCRQ: TcxGridDBBandedColumn;
    cxView1CKJS: TcxGridDBBandedColumn;
    cxView1NSHJS: TcxGridDBBandedColumn;
    cxView1KDJS: TcxGridDBBandedColumn;
    cxView1BZJS: TcxGridDBBandedColumn;
    cxView1TZLCRQ: TcxGridDBBandedColumn;
    cxView1YQLCRQ: TcxGridDBBandedColumn;
    cxView1RQXC: TcxGridDBBandedColumn;
    cxView1FLAG5: TcxGridDBBandedColumn;
    cxView1QRXC: TcxGridDBBandedColumn;
    cxView1XC2: TcxGridDBBandedColumn;
    cxView1XC3: TcxGridDBBandedColumn;
    cxView1YSJHL: TcxGridDBBandedColumn;
    cxView1JHL: TcxGridDBBandedColumn;
    cxView1YZH: TcxGridDBBandedColumn;
    cxView1PD8: TcxGridDBBandedColumn;
    cxGrid1Level1: TcxGridLevel;
    cxStyleRepository1: TcxStyleRepository;
    cxStyle1: TcxStyle;
    cxStyle2: TcxStyle;
    cxStyleRepository3: TcxStyleRepository;
    cxStyle4: TcxStyle;
    cxStyleRepository4: TcxStyleRepository;
    cxStyle5: TcxStyle;
    cxStyleRepository2: TcxStyleRepository;
    cxStyle3: TcxStyle;
    cxGridPopupMenu1: TcxGridPopupMenu;
    ExpandAll1: TMenuItem;
    CollapseAll1: TMenuItem;
    ClearSorting1: TMenuItem;
    N3: TMenuItem;
    cxStyle6: TcxStyle;
    cxStyle7: TcxStyle;
    StartTime1: TMenuItem;
    ExportGAIData1: TMenuItem;
    transitFlow1: TMenuItem;
    AllSewingQNs1: TMenuItem;
    cxView1DSQN: TcxGridDBBandedColumn;
    PrintTicketforFJ1: TMenuItem;
    RecalculateQN1: TMenuItem;
    tblsheduleIECLS: TStringField;
    cxView1IECLS: TcxGridDBBandedColumn;
    tblsheduleIECLS1: TStringField;
    cxView1IECLS1: TcxGridDBBandedColumn;
    ClassbySize1: TMenuItem;
    SpeedButton2: TSpeedButton;
    SpeedButton3: TSpeedButton;
    GroupBox1: TGroupBox;
    chk5: TCheckBox;
    chk7: TCheckBox;
    chk1: TCheckBox;
    chk8: TCheckBox;
    GroupBox2: TGroupBox;
    chk9: TCheckBox;
    chk10: TCheckBox;
    ROQuery1: TClientDataSet;
    siLang1: TsiLang;
    SpeedButton4: TSpeedButton;
    UPDIEGRPandCLS1: TMenuItem;
    lbl850: TLabel;
    UpdateIEdataforQNGAI1: TMenuItem;
    procedure SpeedButton1Click(Sender: TObject);
    procedure BitBtn2Click(Sender: TObject);
    procedure BitBtn4Click(Sender: TObject);
    procedure BitBtn3Click(Sender: TObject);
    procedure BitBtn1Click(Sender: TObject);
    procedure SpeedButton5Click(Sender: TObject);
    procedure Edit1KeyPress(Sender: TObject; var Key: Char);
    procedure BitBtn6Click(Sender: TObject);
    procedure tblsheduleTmuChange(Sender: TField);
    procedure tblsheduleAfterPost(DataSet: TDataSet);
    procedure tblsheduleFlag5Change(Sender: TField);
    procedure tblsheduleFlag3Change(Sender: TField);
    procedure N1Click(Sender: TObject);
    procedure N2Click(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormActivate(Sender: TObject);
    procedure tblsheduleCfksrqChange(Sender: TField);
    procedure FormDeactivate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure ClientDataSet1ReconcileError(DataSet: TClientDataSet;
      E: EReconcileError; UpdateKind: TUpdateKind;
      var Action: TReconcileAction);
    procedure ExecCalc(var pline: String; var seq: Integer);
    procedure tblsheduleAfterOpen(DataSet: TDataSet);
    procedure DBGridEh1DblClick(Sender: TObject);
    procedure tblsheduleLFLAGChange(Sender: TField);
    procedure BitBtn5Click(Sender: TObject);
    procedure BitBtn8Click(Sender: TObject);
    procedure ComboBox3Enter(Sender: TObject);
    procedure ComboBox4Enter(Sender: TObject);
    procedure DBGridEh1Columns4EditButtonClick(Sender: TObject;
      var Handled: Boolean);
    procedure DBGridEh1Columns6EditButtonClick(Sender: TObject;
      var Handled: Boolean);
    procedure DBGridEh1Columns26EditButtonClick(Sender: TObject;
      var Handled: Boolean);
    procedure DBGridEh1Columns8EditButtonClick(Sender: TObject;
      var Handled: Boolean);
    procedure DBGridEh1ColumnsFLAG3EditButtonClick(Sender: TObject;
      var Handled: Boolean);
    procedure DBGridEh1Columns20EditButtonClick(Sender: TObject;
      var Handled: Boolean);
    procedure chk2Click(Sender: TObject);
    procedure chk1Click(Sender: TObject);
    procedure BitBtn9Click(Sender: TObject);
    procedure BitBtn7Click(Sender: TObject);
    procedure Cancelx1Click(Sender: TObject);
    procedure Cancels1Click(Sender: TObject);
    procedure chk3Click(Sender: TObject);
    procedure tblsheduleYzhChange(Sender: TField);
    procedure DBGridEh1Columns30EditButtonClick(Sender: TObject;
      var Handled: Boolean);
    procedure DBGridEh1Columns52EditButtonClick(Sender: TObject;
      var Handled: Boolean);
    procedure DBGridEh1ColumnsSTYLEEditButtonClick(Sender: TObject;
      var Handled: Boolean);
    procedure chk4Click(Sender: TObject);
    procedure BitBtn11Click(Sender: TObject);
    procedure WIPTransit1Click(Sender: TObject);
    procedure chk5Click(Sender: TObject);
    procedure chk6Click(Sender: TObject);
    procedure tblsheduleBeforeEdit(DataSet: TDataSet);
    procedure DBGridEh1GetCellParams(Sender: TObject; Column: TColumnEh;
      AFont: TFont; var Background: TColor; State: TGridDrawState);
    procedure FormCreate(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
    procedure GanttChart1Click(Sender: TObject);
    procedure Begin1Click(Sender: TObject);
    procedure End1Click(Sender: TObject);
    procedure cxView1CellClick(Sender: TcxCustomGridTableView;
      ACellViewInfo: TcxGridTableDataCellViewInfo; AButton: TMouseButton;
      AShift: TShiftState; var AHandled: Boolean);
    procedure cxView1KeyPress(Sender: TObject; var Key: Char);
    procedure cxView1ColumnHeaderClick(Sender: TcxGridTableView;
      AColumn: TcxGridColumn);
    procedure cxView1CSTYLEPropertiesButtonClick(Sender: TObject;
      AButtonIndex: Integer);
    procedure cxView1ACOLPropertiesButtonClick(Sender: TObject;
      AButtonIndex: Integer);
    procedure cxView1SCQTYPropertiesButtonClick(Sender: TObject;
      AButtonIndex: Integer);
    procedure cxView1SJRSPropertiesButtonClick(Sender: TObject;
      AButtonIndex: Integer);
    procedure cxView1TMUPropertiesButtonClick(Sender: TObject;
      AButtonIndex: Integer);
    procedure cxView1CPLANPropertiesButtonClick(Sender: TObject;
      AButtonIndex: Integer);
    procedure cxView1FLAG3PropertiesButtonClick(Sender: TObject;
      AButtonIndex: Integer);
    procedure cxView1CustomDrawCell(Sender: TcxCustomGridTableView;
      ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo;
      var ADone: Boolean);
    procedure cxView1J2_JOBPropertiesButtonClick(Sender: TObject;
      AButtonIndex: Integer);
    procedure ExpandAll1Click(Sender: TObject);
    procedure CollapseAll1Click(Sender: TObject);
    procedure ClearSorting1Click(Sender: TObject);
    procedure StartTime1Click(Sender: TObject);
    procedure cxView1QRXCPropertiesButtonClick(Sender: TObject;
      AButtonIndex: Integer);
    procedure ExportGAIData1Click(Sender: TObject);
    procedure transitFlow1Click(Sender: TObject);
    procedure cxView1StylesGetContentStyle(Sender: TcxCustomGridTableView;
      ARecord: TcxCustomGridRecord; AItem: TcxCustomGridTableItem;
      out AStyle: TcxStyle);
    procedure AllSewingQNs1Click(Sender: TObject);
    procedure cxView1RWOPropertiesButtonClick(Sender: TObject;
      AButtonIndex: Integer);
    procedure cxView1FCCSPropertiesButtonClick(Sender: TObject;
      AButtonIndex: Integer);
    procedure PrintTicketforFJ1Click(Sender: TObject);
    procedure RecalculateQN1Click(Sender: TObject);
    procedure cxView1IECLS1GetCellHint(Sender: TcxCustomGridTableItem;
      ARecord: TcxCustomGridRecord;
      ACellViewInfo: TcxGridTableDataCellViewInfo; const AMousePos: TPoint;
      var AHintText: TCaption; var AIsHintMultiLine: Boolean;
      var AHintTextRect: TRect);
    procedure ClassbySize1Click(Sender: TObject);
    procedure tblsheduleIECLSChange(Sender: TField);
    procedure SpeedButton2Click(Sender: TObject);
    procedure SpeedButton3Click(Sender: TObject);
    procedure chk7Click(Sender: TObject);
    procedure chk8Click(Sender: TObject);
    procedure chk9Click(Sender: TObject);
    procedure chk10Click(Sender: TObject);
    procedure SpeedButton4Click(Sender: TObject);
    procedure UPDIEGRPandCLS1Click(Sender: TObject);
    procedure UpdateIEdataforQNGAI1Click(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  worksheet1: Tworksheet1;
  flag1:boolean;
  flflag:string;
  xglflag:string;
  logseq:integer;
  ARedStyle: TcxStyle;
  AGreenStyle: TcxStyle;
  ABlackStyle: TcxStyle;

implementation

uses mainformu, printschedule1u, loginu, memformu, memform1u, prejhlu,
  planprintu, matchform, chartu, kdfxu, tblmemu, tblmem1u, scbbformu,
  zktdformu, sublineformu, printscheduleu, printform2u, rsycformu,
  lastorderformu, noteformu, styleimageformu, lwoformu, currstartformu,
  lwstartformu, flagformu, cpreportformu, colimgformu, sellwsformu,
  currcalformu, scgxdyu, trsummaryformu, mcalformu, cstylegrpformu,
  rwotransformu, wipprintformu, printform5u, schedule_ganttformu,
  setbeginendformu, startrangeformu, rwoftystartdateformu, exportgaiformu,
  transit_tempformu, printfjticketformu, ieclassformu, QNPIIformu,
  approvalprocessingformu;
  
{$R *.DFM}

procedure Tworksheet1.SpeedButton1Click(Sender: TObject);
var
  cust,pline,styleno,tshop,cstyle,tplant:string;
  si:integer;
begin
  screen.cursor:=crSQLWait;

  with clientdataset1 do begin
    close;
    params.clear;
    commandtext:='execute procedure sp_calcflag4';
    execute;
  end;

  if chk6.Checked then begin
    with clientdataset2 do begin
      close;
      params.clear;
      params.createparam(ftstring,'x1',ptinput);
      commandtext:='execute procedure sp_multqns_enddt(:x1)';
      params[0].asstring:=edit6.text;
      execute;
    end;
  end;

  //if cxView1.SortedItemCount>0 then
  for si:=0 to cxView1.SortedItemCount-1 do begin
    cxView1.SortedItems[si].SortOrder:=soNone;
  end;

  if tblshedule.state=dsedit then tblshedule.post;
  cust:=edit1.text;
  pline:=edit2.text;
  //styleno:=edit3.text;
  tshop:=edit4.text;
  cstyle:=edit5.text;
  tplant:=edit6.text;
  {
  if (tshop>'') or (tplant>'') then begin
    with clientdataset2 do begin
      close;
      params.clear;
      params.createparam(ftstring,'x1',ptinput);
      params.createparam(ftstring,'x2',ptinput);
      commandtext:='execute procedure upd_tshop(:x1,:x2)';
      params[0].asstring:=tshop;
      params[1].asstring:=tplant;
      execute;
    end;
  end;
  }
  with tblshedule do begin
    close;
    params.clear;
    if chk7.Checked then params.createparam(ftdate,'x1',ptinput);
    commandtext:='select * from tblshedule where yzh=0';
    if pline>'' then commandtext:=commandtext+' and upper(pline)='''+pline+'''';
    if cust>'' then commandtext:=commandtext+' and j_no='''+cust+'''';
    if tshop>'' then commandtext:=commandtext+' and (tshop like '''+tshop+'%'')';
    if cstyle>'' then commandtext:=commandtext+' and (cstyle like '''+cstyle+'%'')';
    if tplant>'' then commandtext:=commandtext+' and tplant='''+tplant+'''';
    if combobox1.text>'' then commandtext:=commandtext+' and grp='''+combobox1.text+'''';
    if edit7.text>'' then commandtext:=commandtext+' and j_no like '''+edit7.text+'%''';
    if combobox2.text>'' then commandtext:=commandtext+' and flag6 like '''+combobox2.text+'%''';
    if combobox3.text>'' then commandtext:=commandtext+' and flag6='''+combobox3.text+'''';
    if combobox4.text>'' then commandtext:=commandtext+' and dbzs='''+combobox4.text+'''';
    if edit3.text>'' then commandtext:=commandtext+' and acol='''+edit3.text+'''';
    if combobox5.text>'' then commandtext:=commandtext+' and flag2='''+combobox5.text+'''';
    //if chk1.Checked then commandtext:=commandtext+' and ((substr(lflag,1,1) in (''!'',''^'')) or (dta in (''1'',''5''))) and (substr(pline,1,2) not in (''SG'',''PS'',''NS'',''RS'',''SB'')) '
    if chk1.Checked then commandtext:=commandtext+' and ((substr(lflag,1,1) in (''!'')) or (dta in (''1''))) and (substr(pline,1,2) not in (''SG'',''PS'',''NS'',''RS'',''SB'')) '
                                     +'and ((fccs not like ''%u%'') and (fccs not like ''%d%'') and (fccs not like ''%D%''))';
    if chk2.Checked then commandtext:=commandtext+' and ((fccs like ''%u%'') or (fccs like ''%d%'') or (fccs like ''%D%''))';
    if chk7.Checked then commandtext:=commandtext+' and tshop in (''3A'',''3B'',''3D'',''3G'',''4A'',''4B'',''4C'',''4D'',''KB1A'',''KB1B'',''KB2'',''KB1C'',''KB1D'',''KB1E'') and flag4 in (''a'') and cfksrq>:x1';//+formatdatetime('yyyy-MM-dd',date+20);
    //if chk3.Checked then commandtext:=commandtext+' and plan_date is null';
    if chk8.Checked then commandtext:=commandtext+' and yzh=1';
    if chk4.Checked then commandtext:=commandtext+' and dta in (''3'',''4'')';
    if chk9.Checked then commandtext:=commandtext+' and ((substr(lflag,1,1) in (''^'')) or (dta in (''5'') and substr(lflag,1,1) not in (''!''))) and (substr(pline,1,2) not in (''SG'',''PS'',''NS'',''RS'',''SB'')) '
                                     +'and ((fccs not like ''%u%'') and (fccs not like ''%d%'') and (fccs not like ''%D%''))';
    if chk5.Checked then commandtext:=commandtext+' and pline like ''%SB%''';
    if chk6.Checked then commandtext:=commandtext+' and substr(flag3,1,2) in (''2s'',''3s'',''4s'',''5s'',''6s'',''7s'',''8s'',''9s'')';
    if chk10.Checked then commandtext:=commandtext+' and (((fccs like ''%u%'') or (fccs like ''%d%'') or (fccs like ''%D%'')) or (dta in (''3'',''4'')) '
                                      //+'or (exists (select seq from tbl_qn_confirm b where tblshedule.pline=b.pline and tblshedule.seq=b.seq and b.qntype=''cQN'')))';
                                      +'or (substr(flag3,1,2) in (''2s'',''3s'',''4s'',''5s'',''6s'',''7s'',''8s'',''9s'')))';
    if edit8.text>'' then commandtext:=commandtext+' and upper(jhrs) like '''+edit8.text+'%''';
    if (chk1.Checked or chk2.Checked or chk4.Checked) then commandtext:=commandtext+' and pline not in (''T056F'',''T057F'')';
    //if (chk1.Checked or chk2.Checked or chk4.Checked) then indexname:='idx7'
    //else indexname:='idx1';
    if chk7.Checked then params[0].asdate:=date;
    open;
    editkey;
    if (chk1.Checked or chk2.Checked or chk4.Checked) then indexname:='idx7'
    else indexname:='idx1';
    setkey;
    first;
  end;
  //if chk1.Checked then dbgrideh1.Columns[0].Font.color:=clRed
  //else dbgrideh1.Columns[0].Font.color:=clBlack;
  screen.cursor:=crdefault;
end;

procedure Tworksheet1.BitBtn2Click(Sender: TObject);
begin
  if tblshedule.state=dsedit then tblshedule.post;
end;

procedure Tworksheet1.BitBtn4Click(Sender: TObject);
var
  str1,str2,str3,str4,str5,str00:string;
  dt1:tdatetime;
begin
  screen.cursor:=crhourglass;
  dt1:=date;
    str1:=' order by a.pline,a.seq,a.j_no,a.j2_job,a.artno,a.acol';
    str1:=' order by hc';
    with ROQuery1 do begin
      close;
      params.clear;
      commandtext:='execute procedure sp_updweekday';
      execute;
      close;
      params.clear;
      params.createparam(ftstring,'x1',ptinput);
      params.createparam(ftstring,'x2',ptinput);
      params.createparam(ftdate,'x3',ptinput);
      params.createparam(ftstring,'x4',ptinput);
      commandtext:='execute procedure sp_genzzz(:x1,:x2,:x3,:x4)';
      params[0].asstring:=edit2.text;
      params[1].asstring:=edit6.text;
      params[2].asdate:=dt1;
      params[3].asstring:=edit4.text;
      execute;
    end;
      with ROQuery1 do begin
        close;
        params.clear;
        params.createparam(ftstring,'x1',ptinput);
        commandtext:='execute procedure sp_updhc(:x1)';
        params[0].asstring:='1';
        execute;
      end;
      with clientdataset1 do begin
        close;
        params.clear;
        //commandtext:='select distinct a.*,substr(a.j_no,1,4) as cust,b.qty from tempshedule1 a,tbl_ERPSOP1 b where a.j_no=b.J_no and a.ORDLINE=B.ORDLINE and yzh=0 and b.qty>0'+str1;
        commandtext:='select distinct a.*,substr(a.j_no,1,4) as cust from tempshedule1 a where yzh=0'+str1;
        open;
      end;
    if Edit6.text>'' then str2:=' / '+Edit6.text else str2:='';

    with clientdataset2 do begin
      close;
      params.clear;
      commandtext:='select count(distinct cstyle) as cnt1,count(distinct pline) as cnt2,'
                  +'count(distinct substr(j_no,1,4)) as cnt3,count(distinct j_no) as cnt4 from tempshedule1 where yzh=0';
      open;
      if not fieldbyname('cnt1').isnull then str3:='Ttl # of styles: '+fieldbyname('cnt1').asstring
      else str3:='';
      if not fieldbyname('cnt2').isnull then str4:='Ttl # of lines: '+fieldbyname('cnt2').asstring
      else str4:='';
      if not fieldbyname('cnt3').isnull then str5:='Ttl # of customers: '+fieldbyname('cnt3').asstring+'      Ttl # of projects: '+fieldbyname('cnt4').asstring
      else str5:='';
    end;

    str00:='';

    if frmprint2=nil then frmprint2:=tfrmprint2.create(nil);
    frmprint2.wks003.Caption:=edit4.text;
    frmprint2.ppBDEPipeline1.DataSource:=datasource2;
    frmprint2.project1.text:=uppercase(edit1.text);
    frmprint2.pline.text:=edit2.text;
    frmprint2.artno2.Caption:='Cust Style';
    frmprint2.artno1.DataField:='cstyle';
    frmprint2.xdhq.Visible:=true;
    frmprint2.xdhq.Caption:=str00+'(Line Work Start Date'+str2+')';
    frmprint2.pttl1.Caption:=str4;
    frmprint2.pttl2.Caption:=str3;
    frmprint2.pttl3.Caption:=str5;
    frmprint2.ppreport1.print;
  //end;
  screen.Cursor:=crDefault;
end;

procedure Tworksheet1.BitBtn3Click(Sender: TObject);
var
  pline,cust,styleno,tshop,cstyle,tplant:string;
  tm:tdatetime;
begin
  screen.cursor:=crhourglass;
  if tblshedule.active=true then begin
    tm:=now;
    if tblshedule.state=dsedit then tblshedule.post;
    if tblshedule.recordcount>0 then begin
      if chk2.Checked then begin
        with clientdataset1 do begin
          close;
          params.clear;
          commandtext:='update tblshedule set dta=''0'' where yzh=0 and dta<>''1'' and ((fccs like ''%u'') or (fccs like ''%d%'') or (fccs like ''%D''))';
          execute;
        end;
        with clientdataset2 do begin
          close;
          params.clear;
          commandtext:='delete from tblshedule_plc where tm<current_timestamp-0.5';
          execute;
        end;
        with clientdataset2 do begin
          close;
          params.clear;
          params.createparam(ftdatetime,'x1',ptinput);
          commandtext:='insert into tblshedule_plc select a.*,''0'',:x1 from tblshedule a where yzh=0 and ((fccs like ''%u'') or (fccs like ''%d%'') or (fccs like ''%D'')) and pline not in (''T056F'',''T057F'')';
          if edit2.text>'' then commandtext:=commandtext+' and upper(pline)='''+edit2.text+'''';
          if edit1.text>'' then commandtext:=commandtext+' and j_no='''+edit1.text+'''';
          if edit4.text>'' then commandtext:=commandtext+' and (tshop like '''+edit4.text+'%'')';
          if edit5.text>'' then commandtext:=commandtext+' and (cstyle like '''+edit5.text+'%'')';
          if edit6.text>'' then commandtext:=commandtext+' and tplant='''+edit6.text+'''';
          if combobox1.text>'' then commandtext:=commandtext+' and grp='''+combobox1.text+'''';
          if edit7.text>'' then commandtext:=commandtext+' and j_no like '''+edit7.text+'%''';
          if combobox2.text>'' then commandtext:=commandtext+' and flag6 like '''+combobox2.text+'%''';
          if combobox3.text>'' then commandtext:=commandtext+' and flag6='''+combobox3.text+'''';
          if combobox4.text>'' then commandtext:=commandtext+' and dbzs='''+combobox4.text+'''';
          if edit3.text>'' then commandtext:=commandtext+' and acol='''+edit3.text+'''';
          if combobox5.text>'' then commandtext:=commandtext+' and flag2='''+combobox5.text+'''';
          commandtext:=commandtext+' and pline not in (select pline from tblschedule_hide where hide=1)';
          params[0].asdatetime:=tm;
          execute;
        end;
        with clientdataset2 do begin
          close;
          params.clear;
          params.createparam(ftdatetime,'x1',ptinput);
          commandtext:='update tblshedule_plc set plc=''!'' where lflag like ''!%'' and tm=:x1';
          params[0].asdatetime:=tm;
          execute;
        end;

        with clientdataset1 do begin
          close;
          params.clear;
          params.createparam(ftdatetime,'x1',ptinput);
          commandtext:='select * from tblshedule_plc where tm=:x1';
          {
          commandtext:='select * from tblshedule where yzh=0 and ((fccs like ''%u'') or (fccs like ''%d%'') or (fccs like ''%D''))';
          if edit2.text>'' then commandtext:=commandtext+' and upper(pline)='''+edit2.text+'''';
          if edit1.text>'' then commandtext:=commandtext+' and j_no='''+edit1.text+'''';
          if edit4.text>'' then commandtext:=commandtext+' and (tshop like '''+edit4.text+'%'')';
          if edit5.text>'' then commandtext:=commandtext+' and (cstyle like '''+edit5.text+'%'')';
          if edit6.text>'' then commandtext:=commandtext+' and tplant='''+edit6.text+'''';
          if combobox1.text>'' then commandtext:=commandtext+' and grp='''+combobox1.text+'''';
          if edit7.text>'' then commandtext:=commandtext+' and j_no like '''+edit7.text+'%''';
          if combobox2.text>'' then commandtext:=commandtext+' and flag6 like '''+combobox2.text+'%''';
          if combobox3.text>'' then commandtext:=commandtext+' and flag6='''+combobox3.text+'''';
          if combobox4.text>'' then commandtext:=commandtext+' and dbzs='''+combobox4.text+'''';
          if edit3.text>'' then commandtext:=commandtext+' and acol='''+edit3.text+'''';
          if combobox5.text>'' then commandtext:=commandtext+' and flag2='''+combobox5.text+'''';
          }
          commandtext:=commandtext+' order by dta desc,plc,tplant,tshop,pline,seq';
          params[0].asdatetime:=tm;
          open;
          if not fieldbyname('pline').isnull then begin
            if frmprint5=nil then frmprint5:=tfrmprint5.create(nil);
            frmprint5.pplabel59.caption:='---- QN Split Conduct Dashboard (QN halt -> DSQN keep/jump -> DSQN re-active) - DTA & PLC';
            frmprint5.xdhq.Caption:='All excluding actual ex-fty(Line/QN start date/--/'+edit6.text+')';
            frmprint5.ppReport1.print;
          end;
        end;
      end else if (chk1.Checked) or (chk9.checked) then begin
        with clientdataset2 do begin
          close;
          params.clear;
          commandtext:='delete from tblshedule_plc where tm<current_timestamp-0.5';
          execute;
        end;
        with clientdataset2 do begin
          close;
          params.clear;
          params.createparam(ftdatetime,'x1',ptinput);
          commandtext:='insert into tblshedule_plc select a.*,''0'',:x1 from tblshedule a where yzh=0';
          //if chk1.Checked then commandtext:=commandtext+' and ((substr(lflag,1,1) in (''!'',''^'')) or (dta in (''1'',''5''))) and (substr(pline,1,2) not in (''SG'',''PS'',''NS'',''RS'',''SB'')) '
          if chk1.Checked then commandtext:=commandtext+' and ((substr(lflag,1,1) in (''!'')) or (dta in (''1''))) and (substr(pline,1,2) not in (''SG'',''PS'',''NS'',''RS'',''SB'')) '
                                     +'and ((fccs not like ''%u%'') and (fccs not like ''%d%'') and (fccs not like ''%D%'')) and pline not in (''T056F'',''T057F'')';
          if chk9.Checked then commandtext:=commandtext+' and ((substr(lflag,1,1) in (''^'')) or (dta in (''5'') and substr(lflag,1,1) not in (''!''))) and (substr(pline,1,2) not in (''SG'',''PS'',''NS'',''RS'',''SB'')) '
                                     +'and ((fccs not like ''%u%'') and (fccs not like ''%d%'') and (fccs not like ''%D%'')) and pline not in (''T056F'',''T057F'')';
          if edit2.text>'' then commandtext:=commandtext+' and upper(pline)='''+edit2.text+'''';
          if edit1.text>'' then commandtext:=commandtext+' and j_no='''+edit1.text+'''';
          if edit4.text>'' then commandtext:=commandtext+' and (tshop like '''+edit4.text+'%'')';
          if edit5.text>'' then commandtext:=commandtext+' and (cstyle like '''+edit5.text+'%'')';
          if edit6.text>'' then commandtext:=commandtext+' and tplant='''+edit6.text+'''';
          if combobox1.text>'' then commandtext:=commandtext+' and grp='''+combobox1.text+'''';
          if edit7.text>'' then commandtext:=commandtext+' and j_no like '''+edit7.text+'%''';
          if combobox2.text>'' then commandtext:=commandtext+' and flag6 like '''+combobox2.text+'%''';
          if combobox3.text>'' then commandtext:=commandtext+' and flag6='''+combobox3.text+'''';
          if combobox4.text>'' then commandtext:=commandtext+' and dbzs='''+combobox4.text+'''';
          if edit3.text>'' then commandtext:=commandtext+' and acol='''+edit3.text+'''';
          if combobox5.text>'' then commandtext:=commandtext+' and flag2='''+combobox5.text+'''';
          commandtext:=commandtext+' and pline not in (select pline from tblschedule_hide where hide=1)';
          params[0].asdatetime:=tm;
          execute;
        end;
        with clientdataset2 do begin
          close;
          params.clear;
          params.createparam(ftdatetime,'x1',ptinput);
          commandtext:='update tblshedule_plc set plc=''!'' where lflag like ''!%'' and tm=:x1';
          params[0].asdatetime:=tm;
          execute;
        end;

        with clientdataset1 do begin
          close;
          params.clear;
          params.createparam(ftdatetime,'x1',ptinput);
          commandtext:='select * from tblshedule_plc where tm=:x1';
          {
          commandtext:='select * from tblshedule where yzh=0';// and ((fccs like ''%u'') or (fccs like ''%d%'') or (fccs like ''%D''))';
          if chk1.Checked then commandtext:=commandtext+' and ((substr(lflag,1,1) in (''!'',''^'')) or (dta in (''1'',''5''))) and (substr(pline,1,2) not in (''SG'',''PS'',''NS'',''RS'',''SB'')) '
                                     +'and ((fccs not like ''%u%'') and (fccs not like ''%d%'') and (fccs not like ''%D%''))';
          if edit2.text>'' then commandtext:=commandtext+' and upper(pline)='''+edit2.text+'''';
          if edit1.text>'' then commandtext:=commandtext+' and j_no='''+edit1.text+'''';
          if edit4.text>'' then commandtext:=commandtext+' and (tshop like '''+edit4.text+'%'')';
          if edit5.text>'' then commandtext:=commandtext+' and (cstyle like '''+edit5.text+'%'')';
          if edit6.text>'' then commandtext:=commandtext+' and tplant='''+edit6.text+'''';
          if combobox1.text>'' then commandtext:=commandtext+' and grp='''+combobox1.text+'''';
          if edit7.text>'' then commandtext:=commandtext+' and j_no like '''+edit7.text+'%''';
          if combobox2.text>'' then commandtext:=commandtext+' and flag6 like '''+combobox2.text+'%''';
          if combobox3.text>'' then commandtext:=commandtext+' and flag6='''+combobox3.text+'''';
          if combobox4.text>'' then commandtext:=commandtext+' and dbzs='''+combobox4.text+'''';
          if edit3.text>'' then commandtext:=commandtext+' and acol='''+edit3.text+'''';
          if combobox5.text>'' then commandtext:=commandtext+' and flag2='''+combobox5.text+'''';
          }
          commandtext:=commandtext+' order by dta desc,plc,tplant,tshop,pline,seq';
          params[0].asdatetime:=tm;
          open;
          if not fieldbyname('pline').isnull then begin
            if frmprint5=nil then frmprint5:=tfrmprint5.create(nil);
            if chk1.Checked then
            frmprint5.pplabel59.caption:=' ----  QN Reschedule & Transfer Dashboard - DTA & PLC'
            else if chk9.Checked then
            frmprint5.pplabel59.caption:=' ----  QN Reschedule & Transfer Report - DTA & PLC';
            frmprint5.xdhq.Caption:='All excluding actual ex-fty(Line/QN start date/--/'+edit6.text+')';
            frmprint5.ppReport1.print;
          end;
        end;
      end else if chk4.Checked then begin
        with clientdataset2 do begin
          close;
          params.clear;
          commandtext:='delete from tblshedule_plc where tm<current_timestamp-0.5';
          execute;
        end;
        with clientdataset2 do begin
          close;
          params.clear;
          params.createparam(ftdatetime,'x1',ptinput);
          commandtext:='insert into tblshedule_plc select a.*,''0'',:x1 from tblshedule a where yzh=0';
          if chk4.Checked then commandtext:=commandtext+' and dta in (''3'',''4'') and pline not in (''T056F'',''T057F'')';
          if edit2.text>'' then commandtext:=commandtext+' and upper(pline)='''+edit2.text+'''';
          if edit1.text>'' then commandtext:=commandtext+' and j_no='''+edit1.text+'''';
          if edit4.text>'' then commandtext:=commandtext+' and (tshop like '''+edit4.text+'%'')';
          if edit5.text>'' then commandtext:=commandtext+' and (cstyle like '''+edit5.text+'%'')';
          if edit6.text>'' then commandtext:=commandtext+' and tplant='''+edit6.text+'''';
          if combobox1.text>'' then commandtext:=commandtext+' and grp='''+combobox1.text+'''';
          if edit7.text>'' then commandtext:=commandtext+' and j_no like '''+edit7.text+'%''';
          if combobox2.text>'' then commandtext:=commandtext+' and flag6 like '''+combobox2.text+'%''';
          if combobox3.text>'' then commandtext:=commandtext+' and flag6='''+combobox3.text+'''';
          if combobox4.text>'' then commandtext:=commandtext+' and dbzs='''+combobox4.text+'''';
          if edit3.text>'' then commandtext:=commandtext+' and acol='''+edit3.text+'''';
          if combobox5.text>'' then commandtext:=commandtext+' and flag2='''+combobox5.text+'''';
          commandtext:=commandtext+' and pline not in (select pline from tblschedule_hide where hide=1)';
          params[0].asdatetime:=tm;
          execute;
        end;
        with clientdataset2 do begin
          close;
          params.clear;
          params.createparam(ftdatetime,'x1',ptinput);
          commandtext:='update tblshedule_plc set plc=''!'' where lflag like ''!%'' and tm=:x1';
          params[0].asdatetime:=tm;
          execute;
        end;

        with clientdataset1 do begin
          close;
          params.clear;
          params.createparam(ftdatetime,'x1',ptinput);
          commandtext:='select * from tblshedule_plc where tm=:x1';
          commandtext:=commandtext+' order by dta,tplant,tshop,pline,seq';
          params[0].asdatetime:=tm;
          open;
          if not fieldbyname('pline').isnull then begin
            if frmprint5=nil then frmprint5:=tfrmprint5.create(nil);
            frmprint5.pplabel59.caption:=' ----  QN/DSQN SKU exchange Dashboard - DTA';
            frmprint5.xdhq.Caption:='All excluding actual ex-fty(Line/QN start date/--/'+edit6.text+')';
            frmprint5.ppReport1.print;
          end;
        end;
      end else begin
        if frmprintschedule=nil then frmprintschedule:=tfrmprintschedule.create(nil);
        frmprintschedule.Edit1.Text:=edit1.text;
        frmprintschedule.Edit2.text:=edit2.text;
        frmprintschedule.Edit3.Text:=edit3.text;
        frmprintschedule.Edit4.text:=edit4.text;
        frmprintschedule.Edit5.Text:=edit5.text;
        frmprintschedule.Edit6.text:=edit6.text;
        frmprintschedule.Edit7.Text:=edit7.text;
        frmprintschedule.Edit8.text:=edit8.text;
        frmprintschedule.ComboBox2.Text:=combobox1.text;
        frmprintschedule.ComboBox3.Text:=combobox2.text;
        frmprintschedule.ComboBox4.Text:=combobox3.text;
        frmprintschedule.ComboBox5.Text:=combobox4.text;
        frmprintschedule.ComboBox6.Text:=combobox5.text;
        //frmprintschedule.CheckBox1.Checked:=chk1.Checked;
        //frmprintschedule.CheckBox2.Checked:=chk2.Checked;
        //frmprintschedule.CheckBox3.Checked:=chk3.Checked;
        //frmprintschedule.CheckBox4.Checked:=chk4.Checked;
        frmprintschedule.CheckBox5.Checked:=chk5.Checked;
        frmprintschedule.CheckBox6.Checked:=chk6.Checked;
        frmprintschedule.CheckBox7.Checked:=chk7.Checked;
        frmprintschedule.CheckBox10.Checked:=chk10.Checked;
        if (chk1.Checked or chk4.Checked or chk5.Checked or chk6.Checked or chk7.Checked or chk10.checked) then
        frmprintschedule.BitBtn1Click(self)
        else frmprintschedule.show;
      end;
    end;
  end;
  screen.cursor:=crdefault;
end;

procedure Tworksheet1.BitBtn1Click(Sender: TObject);
var
  pline:string;
  seq:integer;
begin
  screen.cursor:=crhourglass;
  if tblshedule.state=dsedit then tblshedule.post;
  pline:=tblshedule.fieldbyname('pline').value;
  seq:=tblshedule.fieldbyname('seq').value;
  {
  with clientdataset1 do begin
    close;
    params.clear;
    params.createparam(ftstring,'pline',ptinput);
    params.createparam(ftinteger,'seq',ptinput);
    commandtext:='execute procedure calc_schedule(:pline,:seq)';
    params[0].asstring:=pline;
    params[1].asinteger:=seq;
    execute;
  end;
  }
  with ROQuery1 do begin
    close;
    params.clear;
    params.createparam(ftstring,'x1',ptinput);
    params.createparam(ftstring,'x2',ptinput);
    commandtext:='execute procedure sp_calcschedule(:x1,:x2)';
    params[0].asstring:='';
    params[1].asstring:=pline;
    execute;
  end;
  //ExecCalc(pline,seq);
  with tblshedule do begin
    close;
    params.clear;
    params.createparam(ftstring,'pline',ptinput);
    commandtext:='select * from tblshedule where pline=:pline and yzh=0';
    params[0].asstring:=pline;
    open;
    locate('seq',seq,[lopartialkey]);
  end;
  with ROQuery1 do begin
    close;
    params.clear;
    params.createparam(ftstring,'x1',ptinput);
    params.createparam(ftstring,'x2',ptinput);
    params.createparam(ftstring,'x3',ptinput);
    commandtext:='execute procedure sp_calcltc(:x1,:x2,:x3)';
    params[0].asstring:='';
    params[1].asstring:=pline;
    params[2].asstring:='';
    execute;
  end;
  screen.cursor:=crdefault;
end;

function Calcdays(var year,month,day:word):integer;
begin
  if isleapyear(year) then begin
    if month=1 then result:=day
    else if month=2 then result:=31+day
    else if month=3 then result:=60+day
    else if month=4 then result:=91+day
    else if month=5 then result:=121+day
    else if month=6 then result:=152+day
    else if month=7 then result:=182+day
    else if month=8 then result:=213+day
    else if month=9 then result:=244+day
    else if month=10 then result:=274+day
    else if month=11 then result:=305+day
    else if month=12 then result:=335+day;
  end
  else begin
    if month=1 then result:=day
    else if month=2 then result:=31+day
    else if month=3 then result:=59+day
    else if month=4 then result:=90+day
    else if month=5 then result:=120+day
    else if month=6 then result:=151+day
    else if month=7 then result:=181+day
    else if month=8 then result:=212+day
    else if month=9 then result:=243+day
    else if month=10 then result:=273+day
    else if month=11 then result:=304+day
    else if month=12 then result:=334+day;
  end;
end;

function ceiling(var double1: double): integer;
begin
  if int(double1)=double1 then result:=round(int(double1))
  else result:=round(int(double1))+1;
end;

function calcwkno(var dt1:tdatetime):integer;
var
  year1,month1,day1:word;
  int1:integer;
begin
  decodedate(dt1,year1,month1,day1);
  int1:=calcdays(year1,month1,day1);
  if dayofweek(encodedate(year1,1,1))=1 then
    result:=(int1+6) div 7
  else if dayofweek(encodedate(year1,1,1))=2 then
    result:=(int1+7) div 7
  else if dayofweek(encodedate(year1,1,1))=3 then
    result:=(int1+8) div 7
  else if dayofweek(encodedate(year1,1,1))=4 then
    result:=(int1+9) div 7
  else if dayofweek(encodedate(year1,1,1))=5 then
    result:=(int1+10) div 7
  else if dayofweek(encodedate(year1,1,1))=6 then
    result:=(int1+11) div 7
  else result:=(int1+12) div 7;
end;

function calcdiffday(var dt1,dt2:tdatetime):integer;
var
  year1,month1,day1,year2,month2,day2:word;
  days1,days2:integer;
begin
  decodedate(dt1,year1,month1,day1);
  decodedate(dt2,year2,month2,day2);
  days1:=calcdays(year1,month1,day1);
  days2:=calcdays(year2,month2,day2);
  if year1=year2 then begin
    result:=days1-days2;
  end
  else begin
    if year1>year2 then begin
      if isleapyear(year2) then begin
        result:=days1+366-days2;
      end
      else begin
        result:=days1+365-days2;
      end;
    end
    else begin
      if isleapyear(year1) then begin
        result:=days1-366-days2;
      end
      else begin
        result:=days1-365-days2;
      end;
    end;
  end;
end;

procedure Tworksheet1.SpeedButton5Click(Sender: TObject);
begin
  close;
end;

procedure Tworksheet1.Edit1KeyPress(Sender: TObject; var Key: Char);
begin
  if key=#13 then begin
    with clientdataset1 do begin
      close;
      params.clear;
      commandtext:='select distinct j_no,j2_job,rwo,acol from tblshedule where j_no='''+edit1.text+'''';
      open;
      first;
      while not eof do begin
        with ROQuery1 do begin
          close;
          params.clear;
          params.createparam(ftstring,'x1',ptinput);
          params.createparam(ftstring,'x2',ptinput);
          params.createparam(ftstring,'x3',ptinput);
          params.createparam(ftstring,'x4',ptinput);
          commandtext:='execute procedure sp_updfccs_rwo_new(:x1,:x2,:x3,:x4)';
          params[0].asstring:=clientdataset1.fieldbyname('j_no').value;
          params[1].asstring:=clientdataset1.fieldbyname('j2_job').value;
          params[2].asstring:=clientdataset1.fieldbyname('rwo').value;
          params[3].asstring:=clientdataset1.fieldbyname('acol').value;
          execute;
        end;
        application.ProcessMessages;
        next;
      end;
    end;
    if worksheet1.Caption='Shipped Records' then speedbutton4click(self)
    else speedbutton1click(self);
  end;
end;

procedure Tworksheet1.BitBtn6Click(Sender: TObject);
begin
  if tblshedule.active=true then begin
    if tblshedule.state=dsedit then tblshedule.post;
    if chk1.Checked then begin
      if tblshedule.recordcount>0 then begin
        //if frmprintschedule=nil then frmprintschedule:=tfrmprintschedule.create(nil);
        //frmprintschedule.BitBtn1click(self);
        with clientdataset1 do begin
          close;
          params.clear;
          commandtext:='select * from tblshedule where yzh=0';// and ((fccs like ''%u'') or (fccs like ''%d%'') or (fccs like ''%D''))';
          if chk1.Checked then commandtext:=commandtext+' and ((substr(lflag,1,1) in (''!'',''^'')) or (dta in (''1'',''5''))) and (substr(pline,1,2) not in (''SG'',''PS'',''NS'',''RS'',''SB'')) '
                                     +'and ((fccs not like ''%u%'') and (fccs not like ''%d%'') and (fccs not like ''%D%''))';
          if edit2.text>'' then commandtext:=commandtext+' and upper(pline)='''+edit2.text+'''';
          if edit1.text>'' then commandtext:=commandtext+' and j_no='''+edit1.text+'''';
          if edit4.text>'' then commandtext:=commandtext+' and (tshop like '''+edit4.text+'%'')';
          if edit5.text>'' then commandtext:=commandtext+' and (cstyle like '''+edit5.text+'%'')';
          if edit6.text>'' then commandtext:=commandtext+' and tplant='''+edit6.text+'''';
          if combobox1.text>'' then commandtext:=commandtext+' and grp='''+combobox1.text+'''';
          if edit7.text>'' then commandtext:=commandtext+' and j_no like '''+edit7.text+'%''';
          if combobox2.text>'' then commandtext:=commandtext+' and flag6 like '''+combobox2.text+'%''';
          if combobox3.text>'' then commandtext:=commandtext+' and flag6='''+combobox3.text+'''';
          if combobox4.text>'' then commandtext:=commandtext+' and dbzs='''+combobox4.text+'''';
          if edit3.text>'' then commandtext:=commandtext+' and acol='''+edit3.text+'''';
          if combobox5.text>'' then commandtext:=commandtext+' and flag2='''+combobox5.text+'''';
          if edit8.Text>'' then commandtext:=commandtext+' and upper(jhrs) like '''+edit8.text+'%''';
          commandtext:=commandtext+' order by dta desc,tplant,tshop,pline,seq';
          open;
          if not fieldbyname('pline').isnull then begin
            if frmprint5=nil then frmprint5:=tfrmprint5.create(nil);
            frmprint5.pplabel59.caption:=' ----  QN Reschedule & Transfer Dashboard - DTA & PLC';
            frmprint5.xdhq.Caption:='All excluding actual ex-fty(Line/QN start date/--/'+edit6.text+')';
            frmprint5.ppReport1.print;
          end;
        end;
      end;
    end;
  end;
end;

procedure Tworksheet1.tblsheduleTmuChange(Sender: TField);
var
  pline:string;
  tmu,fyl,float1,float2,ysjhl,float3,lstrs,tbu:double;
  trs,bzjs,cfksjs,cfwcjs,kdjs,scqty,bcjs,seq:integer;
  phiszjs,zktd,sclhjs,shjs,qyjs,zhjs,learn,ubal:double;
  cfksrq,cfwcrq,tzlcrq,yqlcrq:tdatetime;
  calcwc:string;
begin
  pline:=tblshedule.fieldbyname('pline').value;
  seq:=tblshedule.fieldbyname('seq').value;
  if not tblshedule.fieldbyname('tmu').isnull then tmu:=tblshedule.fieldbyname('tmu').value
  else tmu:=0;
  if not tblshedule.fieldbyname('ysjhl').isnull then ysjhl:=tblshedule.fieldbyname('ysjhl').value
  else ysjhl:=100.0;
  //if not tblshedule.fieldbyname('fyl').isnull then fyl:=tblshedule.fieldbyname('fyl').value
  //else fyl:=1;
  fyl:=1;
  if not tblshedule.fieldbyname('trs').isnull then trs:=tblshedule.fieldbyname('trs').value
  else trs:=25;
  if not tblshedule.fieldbyname('scqty').isnull then scqty:=tblshedule.fieldbyname('scqty').value
  else scqty:=0;
  if not tblshedule.fieldbyname('learn').isnull then learn:=tblshedule.fieldbyname('learn').value
  else learn:=0;
  if not tblshedule.fieldbyname('bcjs').isnull then bcjs:=tblshedule.fieldbyname('bcjs').value
  else bcjs:=0;
  if not tblshedule.fieldbyname('lstrs').isnull then lstrs:=tblshedule.fieldbyname('lstrs').value
  else lstrs:=trs;
  //if not tblshedule.fieldbyname('tbu').isnull then tbu:=tblshedule.fieldbyname('tbu').value
  //else tbu:=100.0;
  tbu:=100.0;
  if lstrs<=0 then lstrs:=25;
  if ysjhl<=0 then ysjhl:=100;
  if tmu*fyl>0 then begin
    float1:=0.5*lstrs/tmu/fyl;//*tbu/100.0;
    tblshedule.fieldbyname('jxjs').value:=float1;
    tblshedule.fieldbyname('xjs').value:=float1;//((round(float1)+1) div 2)*2;
    //float2:=scqty/ceiling(float1)*1.00;//(((round(float1)+1) div 2)*2)*1.00;
    //float3:=scqty/ceiling(float1)*100/ysjhl;//(((round(float1)+1) div 2)*2)*100.00/ysjhl;
    tblshedule.fieldbyname('phiszjs').value:=scqty*1.00/float1;
    tblshedule.fieldbyname('shjs').value:=scqty*100.00/float1/ysjhl-scqty*1.00/float1;
    //tblshedule.fieldbyname('phiszjs').value:=ceiling(float2);
    //tblshedule.fieldbyname('shjs').value:=ceiling(float3)-ceiling(float2);
  end;
  if not tblshedule.fieldbyname('phiszjs').isnull then phiszjs:=tblshedule.fieldbyname('phiszjs').value
  else phiszjs:=0;
  if not tblshedule.fieldbyname('sclhjs').isnull then sclhjs:=tblshedule.fieldbyname('sclhjs').value
  else sclhjs:=0;
  if not tblshedule.fieldbyname('shjs').isnull then shjs:=tblshedule.fieldbyname('shjs').value
  else shjs:=0;
  if not tblshedule.fieldbyname('qyjs').isnull then qyjs:=tblshedule.fieldbyname('qyjs').value
  else qyjs:=0;
  if not tblshedule.fieldbyname('zhjs').isnull then zhjs:=tblshedule.fieldbyname('zhjs').value
  else zhjs:=0;
  if zhjs<0 then zhjs:=zhjs*(-1.0);
  tblshedule.fieldbyname('zjs').value:=phiszjs+sclhjs+shjs+qyjs-zhjs+learn;//+ubal;
  tblshedule.fieldbyname('zktd').value:=learn+sclhjs+qyjs;//+ubal;

  if bcjs>0 then tblshedule.fieldbyname('dbxl').value:=zhjs*100.0/bcjs else tblshedule.fieldbyname('dbxl').value:=0;

  //if (phiszjs+sclhjs+shjs+qyjs)>0 then
  //tblshedule.fieldbyname('jhl').value:=phiszjs*100.0/(phiszjs+sclhjs+shjs+qyjs)
  //else tblshedule.fieldbyname('jhl').value:=ysjhl;

  if not tblshedule.fieldbyname('cfksrq').isnull then begin
    cfksrq:=tblshedule.fieldbyname('cfksrq').value;
    cfksjs:=tblshedule.fieldbyname('cfksjs').value;
    float1:=phiszjs+shjs+sclhjs+qyjs-zhjs+learn;//+ubal;
    with ROQuery1 do begin
      close;
      params.clear;
      params.createparam(ftstring,'x1',ptinput);
      params.createparam(ftdate,'x2',ptinput);
      params.createparam(ftfloat,'x3',ptinput);
      params.createparam(ftfloat,'x4',ptinput);
      params.createparam(ftfloat,'x5',ptinput);
      params.createparam(ftfloat,'x6',ptinput);
      params.createparam(ftinteger,'x7',ptinput);
      commandtext:='select * from prd_wcrq_1(:x1,:x2,:x3,:x4,:x5,:x6,:x7)';
      params[0].asstring:=pline;
      params[1].asdate:=cfksrq;
      params[2].asfloat:=cfksjs;
      params[3].asfloat:=float1;
      params[4].asfloat:=0;
      params[5].asfloat:=0;
      params[6].asinteger:=seq;
      open;
      if not fieldbyname('o_wcrq').isnull then begin
        cfwcrq:=fieldbyname('o_wcrq').value;
        cfwcjs:=fieldbyname('o_wcjs').value;

        tzlcrq:=cfwcrq+1;
        tblshedule.fieldbyname('cfwcrq').value:=cfwcrq;
        tblshedule.fieldbyname('cfwcjs').value:=cfwcjs;
        tblshedule.fieldbyname('tzlcrq').value:=tzlcrq;
        if not tblshedule.fieldbyname('yqlcrq').isnull then begin
          yqlcrq:=tblshedule.fieldbyname('yqlcrq').value;
          tblshedule.fieldbyname('rqxc').value:=trunc(yqlcrq)-trunc(tzlcrq);//calcdiffday(yqlcrq,tzlcrq);
        end;
      end;
    end;
    {
    tzlcrq:=cfwcrq+1;
    tblshedule.fieldbyname('cfwcrq').value:=cfwcrq;
    tblshedule.fieldbyname('cfwcjs').value:=cfwcjs;
    tblshedule.fieldbyname('tzlcrq').value:=tzlcrq;
    if not tblshedule.fieldbyname('yqlcrq').isnull then begin
      yqlcrq:=tblshedule.fieldbyname('yqlcrq').value;
      tblshedule.fieldbyname('rqxc').value:=trunc(yqlcrq)-trunc(tzlcrq);//calcdiffday(yqlcrq,tzlcrq);
    end;
    }
  end;
end;

procedure Tworksheet1.tblsheduleAfterPost(DataSet: TDataSet);
var
  pstr:string;
  upd:string;
  str1,str2:string;
begin
  if tblshedule.ApplyUpdates(-1)>0 then begin
    with clientdataset1 do begin
      close;
      params.clear;
      params.createparam(ftstring,'flag1',ptinput);
      params.createparam(ftstring,'khzl',ptinput);
      params.createparam(ftstring,'flag2',ptinput);
      params.createparam(ftfloat,'tmu',ptinput);
      params.createparam(ftfloat,'fyl',ptinput);
      params.createparam(ftfloat,'trs',ptinput);
      params.createparam(ftfloat,'ysjhl',ptinput);
      params.createparam(ftfloat,'kdjs',ptinput);
      params.createparam(ftfloat,'zktd',ptinput);
      params.createparam(ftstring,'flag3',ptinput);
      params.createparam(ftfloat,'sctd',ptinput);
      params.createparam(ftfloat,'sclhjs',ptinput);
      params.createparam(ftfloat,'zhjs',ptinput);
      params.createparam(ftfloat,'bcjs',ptinput);
      params.createparam(ftfloat,'bzjs',ptinput);
      params.createparam(ftstring,'flag4',ptinput);
      params.createparam(ftstring,'flag5',ptinput);
      params.createparam(ftdate,'qrlcrq',ptinput);
      params.createparam(ftstring,'fyfs',ptinput);
      params.createparam(ftboolean,'yzh',ptinput);
      params.createparam(ftfloat,'xjs',ptinput);
      params.createparam(ftfloat,'phiszjs',ptinput);
      params.createparam(ftfloat,'zjs',ptinput);
      params.createparam(ftfloat,'jhl',ptinput);
      params.createparam(ftdate,'cfksrq',ptinput);
      params.createparam(ftfloat,'cfksjs',ptinput);
      params.createparam(ftinteger,'week',ptinput);
      params.createparam(ftdate,'cfwcrq',ptinput);
      params.createparam(ftfloat,'cfwcjs',ptinput);
      params.createparam(ftdate,'tzlcrq',ptinput);
      params.createparam(ftinteger,'qrxc',ptinput);
      params.createparam(ftinteger,'rqxc',ptinput);
      PARAMS.CREATEPARAM(FTINTEGER,'SCQTY',PTINPUT);
      params.createparam(ftinteger,'xs',ptinput);
      params.createparam(ftstring,'pflag1',ptinput);
      params.createparam(ftstring,'dbzs',ptinput);
      params.createparam(ftstring,'flag6',ptinput);
      params.createparam(ftfloat,'lstrs',ptinput);
      params.createparam(ftfloat,'shjs',ptinput);
      params.createparam(ftfloat,'qyjs',ptinput);
      params.createparam(ftstring,'jhrs',ptinput);
      params.createparam(ftdate,'plan_date',ptinput);
      params.createparam(ftdate,'pd8',ptinput);
      params.createparam(ftstring,'lflag',ptinput);
      params.createparam(ftfloat,'learn',ptinput);
      params.createparam(ftfloat,'jxjs',ptinput);
      params.createparam(ftfloat,'ckjs',ptinput);
      params.createparam(ftfloat,'sjrs',ptinput);
      params.createparam(ftfloat,'sjyc',ptinput);
      params.createparam(ftfloat,'tbu',ptinput);
      params.createparam(ftdate,'cplan',ptinput);
      params.createparam(ftinteger,'xc4',ptinput);
      params.createparam(ftstring,'fccs',ptinput);
      params.createparam(ftfloat,'unbal',ptinput);
      params.createparam(ftstring,'iecls',ptinput);
      params.createparam(ftstring,'iecls1',ptinput);
      params.createparam(ftstring,'pline',ptinput);
      params.createparam(ftinteger,'seq',ptinput);
      commandtext:='update tblshedule set flag1=:flag1,khzl=:khzl,flag2=:flag2,tmu=:tmu,fyl=:fyl,trs=:trs,'
                  +'ysjhl=:ysjhl,kdjs=:kdjs,zktd=:zktd,flag3=:flag3,sctd=:sctd,sclhjs=:sclhjs,zhjs=:zhjs,'
                  +'bcjs=:bcjs,bzjs=:bzjs,flag4=:flag4,flag5=:flag5,qrlcrq=:qrlcrq,fyfs=:fyfs,yzh=:yzh,'
                  +'xjs=:xjs,phiszjs=:phiszjs,zjs=:zjs,jhl=:jhl,cfksrq=:cfksrq,cfksjs=:cfksjs,week=:week,'
                  +'cfwcrq=:cfwcrq,cfwcjs=:cfwcjs,tzlcrq=:tzlcrq,qrxc=:qrxc,rqxc=:rqxc,SCQTY=:SCQTY,'
                  +'xs=:xs,pflag1=:pflag1,dbzs=:dbzs,flag6=:flag6,lstrs=:lstrs,shjs=:shjs,qyjs=:qyjs,jhrs=:jhrs,'
                  +'plan_date=:plan_date,pd8=:pd8,lflag=:lflag,learn=:learn,jxjs=:jxjs,ckjs=:ckjs,'
                  +'sjrs=:sjrs,sjyc=:sjyc,tbu=:tbu,cplan=:cplan,xc4=:xc4,fccs=:fccs,unbal=:unbal,'
                  +'iecls=:iecls,iecls1=:iecls1 where pline=:pline and seq=:seq';
      if not tblshedule.fieldbyname('flag1').isnull then
      params[0].asstring:=tblshedule.fieldbyname('flag1').value
      else params[0].asstring:='2';
      if not tblshedule.fieldbyname('khzl').isnull then
      params[1].asstring:=tblshedule.fieldbyname('khzl').value
      else params[1].asstring:='';
      if not tblshedule.fieldbyname('flag2').isnull then
      params[2].asstring:=tblshedule.fieldbyname('flag2').value
      else params[2].asstring:='';
      params[3].asfloat:=tblshedule.fieldbyname('tmu').value;
      params[4].asfloat:=tblshedule.fieldbyname('fyl').value;
      params[5].asfloat:=tblshedule.fieldbyname('trs').value;
      params[6].asfloat:=tblshedule.fieldbyname('ysjhl').value;
      params[7].asfloat:=tblshedule.fieldbyname('kdjs').value;
      params[8].asfloat:=tblshedule.fieldbyname('zktd').value;
      if not tblshedule.fieldbyname('flag3').isnull then
      params[9].asstring:=tblshedule.fieldbyname('flag3').value
      else params[9].asstring:='';
      params[10].asfloat:=tblshedule.fieldbyname('sctd').value;
      params[11].asfloat:=tblshedule.fieldbyname('sclhjs').value;
      params[12].asfloat:=tblshedule.fieldbyname('zhjs').value;
      params[13].asfloat:=tblshedule.fieldbyname('bcjs').value;
      params[14].asfloat:=tblshedule.fieldbyname('bzjs').value;
      if not tblshedule.fieldbyname('flag4').isnull then
      params[15].asstring:=tblshedule.fieldbyname('flag4').value
      else params[15].asstring:='';
      if not tblshedule.fieldbyname('flag5').isnull then
      params[16].asstring:=tblshedule.fieldbyname('flag5').value
      else params[16].asstring:='';
      if not tblshedule.fieldbyname('qrlcrq').isnull then
      params[17].asdate:=tblshedule.fieldbyname('qrlcrq').value;
      if not tblshedule.fieldbyname('fyfs').isnull then
      params[18].asstring:=tblshedule.fieldbyname('fyfs').value
      else params[18].asstring:='';
      params[19].asboolean:=tblshedule.fieldbyname('yzh').value;
      params[20].asfloat:=tblshedule.fieldbyname('xjs').value;
      if not tblshedule.fieldbyname('phiszjs').isnull then
      params[21].asfloat:=tblshedule.fieldbyname('phiszjs').value
      else params[21].asfloat:=0;
      if not tblshedule.fieldbyname('zjs').isnull then
      params[22].asfloat:=tblshedule.fieldbyname('zjs').value
      else params[22].asfloat:=0;
      if not tblshedule.fieldbyname('jhl').isnull then
      params[23].asfloat:=tblshedule.fieldbyname('jhl').value
      else params[23].asfloat:=0;
      if not tblshedule.fieldbyname('cfksrq').isnull then
      params[24].asdate:=tblshedule.fieldbyname('cfksrq').value;
      if not tblshedule.fieldbyname('cfksjs').isnull then
      params[25].asfloat:=tblshedule.fieldbyname('cfksjs').value
      else params[25].asfloat:=0;
      if not tblshedule.fieldbyname('week').isnull then
      params[26].asinteger:=tblshedule.fieldbyname('week').value;
      if not tblshedule.fieldbyname('cfwcrq').isnull then
      params[27].asdate:=tblshedule.fieldbyname('cfwcrq').value;
      if not tblshedule.fieldbyname('cfwcjs').isnull then
      params[28].asfloat:=tblshedule.fieldbyname('cfwcjs').value
      else params[28].asfloat:=0;
      if not tblshedule.fieldbyname('tzlcrq').isnull then
      params[29].asdate:=tblshedule.fieldbyname('tzlcrq').value;
      if not tblshedule.fieldbyname('qrxc').isnull then
      params[30].asinteger:=tblshedule.fieldbyname('qrxc').value
      else params[30].asinteger:=0;
      if not tblshedule.fieldbyname('rqxc').isnull then
      params[31].asinteger:=tblshedule.fieldbyname('rqxc').value
      else params[31].asinteger:=0;
      PARAMS[32].ASINTEGER:=TBLSHEDULE.FIELDBYNAME('SCQTY').VALUE;
      if not tblshedule.fieldbyname('xs').isnull then
      params[33].asinteger:=tblshedule.fieldbyname('xs').value
      else params[33].asinteger:=1;
      if not tblshedule.fieldbyname('pflag1').isnull then
      params[34].asstring:=tblshedule.fieldbyname('pflag1').value
      else params[34].asstring:='1';
      if not tblshedule.fieldbyname('dbzs').isnull then
      params[35].asstring:=tblshedule.fieldbyname('dbzs').value
      else params[35].asstring:='';
      if not tblshedule.fieldbyname('flag6').isnull then
      params[36].asstring:=tblshedule.fieldbyname('flag6').value
      else params[36].asstring:='';
      if not tblshedule.fieldbyname('lstrs').isnull then
      params[37].asfloat:=tblshedule.fieldbyname('lstrs').value
      else params[37].asfloat:=0;
      if not tblshedule.fieldbyname('shjs').isnull then
      params[38].asfloat:=tblshedule.fieldbyname('shjs').value
      else params[38].asfloat:=0;
      if not tblshedule.fieldbyname('qyjs').isnull then
      params[39].asfloat:=tblshedule.fieldbyname('qyjs').value
      else params[39].asfloat:=0;
      if not tblshedule.fieldbyname('jhrs').isnull then
      params[40].asstring:=tblshedule.fieldbyname('jhrs').value
      else params[40].asstring:='';
      if not tblshedule.fieldbyname('plan_date').isnull then
      params[41].asdate:=tblshedule.fieldbyname('plan_date').value;
      if not tblshedule.fieldbyname('pd8').isnull then
      params[42].asdate:=tblshedule.fieldbyname('pd8').value;
      if not tblshedule.fieldbyname('lflag').isnull then begin
        if flflag<>'' then begin
          if (copy(tblshedule.fieldbyname('lflag').value,1,1)='!') or (copy(tblshedule.fieldbyname('lflag').value,1,1)='^') then
          params[43].asstring:=tblshedule.fieldbyname('lflag').value
          else params[43].asstring:=flflag+trim(tblshedule.fieldbyname('lflag').value);
        end else params[43].asstring:=tblshedule.fieldbyname('lflag').value;
      end else params[43].asstring:='!1';
      if not tblshedule.fieldbyname('learn').isnull then
      params[44].asfloat:=tblshedule.fieldbyname('learn').value
      else params[44].asfloat:=0;
      if not tblshedule.fieldbyname('jxjs').isnull then
      params[45].asfloat:=tblshedule.fieldbyname('jxjs').value
      else params[45].asfloat:=0;
      if not tblshedule.fieldbyname('ckjs').isnull then
      params[46].asfloat:=tblshedule.fieldbyname('ckjs').value
      else params[46].asfloat:=0;
      if not tblshedule.fieldbyname('sjrs').isnull then
      params[47].asfloat:=tblshedule.fieldbyname('sjrs').value
      else params[47].asfloat:=0;
      if not tblshedule.fieldbyname('sjyc').isnull then
      params[48].asfloat:=tblshedule.fieldbyname('sjyc').value
      else params[48].asfloat:=0;
      if not tblshedule.fieldbyname('tbu').isnull then
      params[49].asfloat:=tblshedule.fieldbyname('tbu').value
      else params[49].asfloat:=100;
      if not tblshedule.fieldbyname('cplan').isnull then
      params[50].asdate:=tblshedule.fieldbyname('cplan').value;
      if not tblshedule.fieldbyname('xc4').isnull then
      params[51].asinteger:=tblshedule.fieldbyname('xc4').value
      else params[51].asinteger:=0;
      if not tblshedule.fieldbyname('fccs').isnull then
      params[52].asstring:=tblshedule.fieldbyname('fccs').value
      else params[52].asstring:='1/1';
      if not tblshedule.fieldbyname('unbal').isnull then
      params[53].asfloat:=tblshedule.fieldbyname('unbal').value
      else params[53].asfloat:=0;
      if not tblshedule.fieldbyname('iecls').isnull then
      params[54].asstring:=tblshedule.fieldbyname('iecls').value
      else params[4].asstring:='';
      if not tblshedule.fieldbyname('iecls1').isnull then
      params[55].asstring:=tblshedule.fieldbyname('iecls1').value
      else params[55].asstring:='';
      params[56].asstring:=tblshedule.fieldbyname('pline').value;
      params[57].asinteger:=tblshedule.fieldbyname('seq').value;
      execute;
    end;
  end;
  if xglflag='1' then begin
    with ROQuery1 do begin
      close;
      params.clear;
      params.CreateParam(ftstring,'x1',ptinput);
      params.CreateParam(ftinteger,'x2',ptinput);
      params.CreateParam(ftstring,'x3',ptinput);
      commandtext:='execute procedure sp_upd_lineplc(:x1,:x2,:x3)';
      params[0].asstring:=tblshedule.fieldbyname('pline').value;
      params[1].asinteger:=tblshedule.fieldbyname('seq').value;
      params[2].asstring:=tblshedule.fieldbyname('cstyle').value;
      execute;
    end;
    xglflag:='0';
  end;
  {
    pstr:='9 '+tblshedule.fieldbyname('pline').value+' '+tblshedule.fieldbyname('seq').asstring;
    if pos('test',lowercase(application.ExeName))>0 then
    winexec(pchar(extractfilepath(application.exename)+'lwpm_replication_test.exe '+pstr),sw_hide)
    else winexec(pchar(extractfilepath(application.exename)+'lwpm_replication.exe '+pstr),sw_hide);
    }
  upd:='0';
  if tblshedule.fieldbyname('flag3').isnull then upd:='1'
  else begin
    if pos('s',tblshedule.fieldbyname('flag3').value)>0 then upd:='1'
    else if pos('h1',tblshedule.fieldbyname('flag3').value)>0 then upd:='1'
    else if tblshedule.fieldbyname('flag3').value='' then upd:='1';
  end;
  if upd='1' then begin
    if (not tblshedule.fieldbyname('cfksrq').isnull) and (not tblshedule.fieldbyname('cfwcrq').isnull) then begin
      {
      str1:=frmmain.Memo2.lines.strings[0];
      str2:=tblshedule.fieldbyname('tplant').value+' '+tblshedule.fieldbyname('pline').value+' '+tblshedule.fieldbyname('j_no').value+' '+tblshedule.fieldbyname('j2_job').value+' '+tblshedule.fieldbyname('rwo').value+' '+tblshedule.fieldbyname('fccs').value+' '+tblshedule.fieldbyname('acol').value;
      shellexecute(0,'open',pchar('LWPMTORAP.exe'),pchar(str2),pchar(str1),sw_show);
      //showmessage(str1+' '+str2);
      }
      //{
      with frmmain.ADOQuery1 do begin
        close;
        sql.Clear;
        sql.Text:='exec [ph.lwpm.wp].dbo.getlwpm :x1,:x2,:x3,:x4,:x5,:x6,:x7,:x8,:x9,:x10,:x11,:x12';
        parameters[0].Value:=tblshedule.fieldbyname('tplant').value;
        parameters[1].Value:=tblshedule.fieldbyname('pline').value;
        parameters[2].Value:=tblshedule.fieldbyname('j_no').value;
        parameters[3].Value:=tblshedule.fieldbyname('j2_job').value;
        parameters[4].Value:=tblshedule.fieldbyname('rwo').value;
        parameters[5].Value:=tblshedule.fieldbyname('fccs').value;
        parameters[6].Value:=tblshedule.fieldbyname('acol').value;
        parameters[7].Value:=tblshedule.fieldbyname('flag3').value;
        parameters[8].Value:=tblshedule.fieldbyname('seq').value;
        parameters[9].Value:=tblshedule.fieldbyname('tshop').value;
        parameters[10].Value:=tblshedule.fieldbyname('cfksrq').value;
        parameters[11].Value:=tblshedule.fieldbyname('cfwcrq').value;
        execsql;
      end;
      //}
    end;
  end;
end;

procedure Tworksheet1.tblsheduleFlag5Change(Sender: TField);
begin
  if not tblshedule.fieldbyname('flag5').isnull then begin
    if (tblshedule.fieldbyname('flag5').value='1') or (tblshedule.fieldbyname('flag5').value='2') then begin
      with clientdataset1 do begin
        close;
        params.clear;
        params.createparam(ftstring,'pline',ptinput);
        params.createparam(ftstring,'j_no',ptinput);
        params.createparam(ftstring,'j2_job',ptinput);
        params.createparam(ftstring,'artno',ptinput);
        params.createparam(ftstring,'acol',ptinput);
        params.createparam(ftinteger,'seq',ptinput);
        params.createparam(ftdatetime,'dt',ptinput);
        params.createparam(ftstring,'usr',ptinput);
        PARAMS.CREATEPARAM(FTDATEtime,'YQLCRQ',PTINPUT);
        PARAMS.CREATEPARAM(FTDATE,'QRLCRQ',PTINPUT);
        commandtext:='insert into tblmem(pline,j_no,j2_job,artno,acol,seq,dt,usr,YQLCRQ,QRLCRQ) values(:pline,:j_no,:j2_job,:artno,:acol,:seq,:dt,:usr,:YQLCRQ,:QRLCRQ)';
        params[0].asstring:=tblshedule.fieldbyname('pline').value;
        params[1].asstring:=tblshedule.fieldbyname('j_no').value;
        params[2].asstring:=tblshedule.fieldbyname('j2_job').value;
        params[3].asstring:=tblshedule.fieldbyname('artno').value;
        params[4].asstring:=tblshedule.fieldbyname('acol').value;
        params[5].asinteger:=tblshedule.fieldbyname('seq').value;
        params[6].asdatetime:=now;
        params[7].asstring:=frmmain.combobox1.text;
        if not tblshedule.fieldbyname('yqlcrq').isnull then
        PARAMS[8].ASDATEtime:=TBLSHEDULE.FIELDBYNAME('YQLCRQ').VALUE;
        if not tblshedule.fieldbyname('qrlcrq').isnull then
        PARAMS[9].ASDATE:=TBLSHEDULE.FIELDBYNAME('QRLCRQ').VALUE;
        execute;
      end;
    end;
  end;
end;

procedure Tworksheet1.tblsheduleFlag3Change(Sender: TField);
begin
  if tblshedule.fieldbyname('flag3').isnull then begin
    if tblshedule.fieldbyname('flag3').value='3' then begin
      if tblshedule.fieldbyname('okhrq').isnull then begin
        if not tblshedule.fieldbyname('cfksrq').isnull then
          tblshedule.fieldbyname('okhrq').value:=tblshedule.fieldbyname('cfksrq').value
        else tblshedule.fieldbyname('okhrq').value:=date;
      end;
      with clientdataset1 do begin
        close;
        params.clear;
        params.createparam(ftstring,'pline',ptinput);
        params.createparam(ftstring,'j_no',ptinput);
        params.createparam(ftstring,'j2_job',ptinput);
        params.createparam(ftstring,'artno',ptinput);
        params.createparam(ftstring,'acol',ptinput);
        params.createparam(ftinteger,'seq',ptinput);
        params.createparam(ftdate,'okhrq',ptinput);
        params.createparam(ftdate,'nkhrq',ptinput);
        params.createparam(ftdatetime,'dt',ptinput);
        params.createparam(ftinteger,'ckts',ptinput);
        commandtext:='insert into tblmem1(pline,j_no,j2_job,artno,acol,seq,okhrq,nkhrq,dt,ckts) values(:pline,:j_no,:j2_job,:artno,:acol,:seq,:okhrq,:nkhrq,:dt,:ckts)';
        params[0].asstring:=tblshedule.fieldbyname('pline').value;
        params[1].asstring:=tblshedule.fieldbyname('j_no').value;
        params[2].asstring:=tblshedule.fieldbyname('j2_job').value;
        params[3].asstring:=tblshedule.fieldbyname('artno').value;
        params[4].asstring:=tblshedule.fieldbyname('acol').value;
        params[5].asinteger:=tblshedule.fieldbyname('seq').value;
        params[6].asdate:=tblshedule.fieldbyname('okhrq').value;
        params[7].asdate:=tblshedule.fieldbyname('cfksrq').value;
        params[8].asdatetime:=now;
        params[9].asinteger:=trunc(tblshedule.fieldbyname('okhrq').value)-trunc(tblshedule.fieldbyname('cfksrq').value);
        execute;
      end;
    end;
  end;
end;

procedure Tworksheet1.N1Click(Sender: TObject);
begin
  screen.cursor:=crhourglass;
  if frmtblmem=nil then frmtblmem:=tfrmtblmem.create(self);
  with frmtblmem.clientdataset1 do begin
    close;
    params.clear;
    commandtext:='select * from tblmem order by pline,j_no,j2_job,artno,acol,seq';
    open;
  end;
  frmtblmem.ppreport1.print;
  screen.cursor:=crdefault;
end;

procedure Tworksheet1.N2Click(Sender: TObject);
begin
  screen.cursor:=crhourglass;
  if frmtblmem1=nil then frmtblmem1:=tfrmtblmem1.create(self);
  with frmtblmem1.clientdataset1 do begin
    close;
    params.clear;
    commandtext:='select * from tblmem1 order by pline,j_no,j2_job,artno,acol';
    open;
  end;
  frmtblmem1.ppreport1.print;
  screen.cursor:=crdefault;
end;

procedure Tworksheet1.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  frmmain.tbn7.Visible:=false;
  frmmain.tbn8.Visible:=false;
  frmmain.tbn9.Visible:=false;
  frmmain.tbn10.Visible:=false;
  frmmain.tbn11.Visible:=false;
  //frmmain.tbn15.Visible:=false;
  //frmmain.tbn16.Visible:=false;
  frmmain.tbs3.visible:=false;
  if frmprint5<>nil then frmprint5:=nil;
  action:=cafree;
  worksheet1:=nil;
end;

procedure Tworksheet1.FormActivate(Sender: TObject);
begin
  with clientdataset1 do begin
    close;
    params.clear;
    params.createparam(ftstring,'usr',ptinput);
    commandtext:='select r7,r39,r77 from tbluser where upper(usr)=:usr';
    params[0].asstring:=frmmain.combobox1.text;
    open;
    if fieldbyname('r7').value=true then begin
      frmmain.tbn7.Visible:=true;
      frmmain.tbn8.Visible:=true;
      frmmain.tbn9.Visible:=true;
      frmmain.tbn10.Visible:=true;
      //frmmain.tbn11.Visible:=false;
      //frmmain.tbn15.Visible:=true;
      //frmmain.tbn16.Visible:=true;
      frmmain.tbs3.visible:=true;
      bitbtn1.Enabled:=true;
      bitbtn2.Enabled:=true;
      //bitbtn5.Enabled:=true;
      //cxGrid1.ReadOnly:=false;
      tblshedule.ReadOnly:=false;
      if fieldbyname('r39').value=true then begin
        cxView1.Columns[58].Options.Editing:=true;//ReadOnly:=false;
        cxView1.Columns[59].Options.Editing:=true;//ReadOnly:=false;
      end else begin
        cxView1.Columns[58].Options.Editing:=false;//ReadOnly:=true;
        cxView1.Columns[59].Options.Editing:=false;//ReadOnly:=true;
      end;
      if fieldbyname('r77').value=true then
        frmmain.tbn11.visible:=true
      else frmmain.tbn11.Visible:=false;
    end else begin
      frmmain.tbn7.Visible:=false;
      frmmain.tbn8.Visible:=false;
      frmmain.tbn9.Visible:=false;
      frmmain.tbn10.Visible:=false;
      frmmain.tbn11.Visible:=false;
      //frmmain.tbn15.Visible:=false;
      //frmmain.tbn16.Visible:=false;
      frmmain.tbs3.visible:=false;
      bitbtn1.Enabled:=false;
      bitbtn2.Enabled:=false;
      //bitbtn5.Enabled:=false;
      //cxView1.ReadOnly:=true;
      tblshedule.ReadOnly:=true;
    end;
  end;
end;

procedure Tworksheet1.tblsheduleCfksrqChange(Sender: TField);
var
  cfksrq,cfwcrq:tdatetime;
  cfksjs,cfwcjs,week1:integer;
  phiszjs,zktd,zhjs,float1,shjs:double;
  calcwc:string;
begin
  if (not tblshedule.fieldbyname('cfksrq').isnull) and  (not tblshedule.fieldbyname('cfksjs').isnull) then begin
    cfksrq:=tblshedule.fieldbyname('cfksrq').value;
    week1:=calcwkno(cfksrq);
    cfksjs:=tblshedule.fieldbyname('cfksjs').value;
    phiszjs:=tblshedule.fieldbyname('phiszjs').value;
    shjs:=tblshedule.fieldbyname('shjs').value;
    zktd:=tblshedule.fieldbyname('zktd').value;
    zhjs:=tblshedule.fieldbyname('zhjs').value;//-tblshedule.fieldbyname('qyjs').value-tblshedule.fieldbyname('zhjs').value;
    if zhjs<0 then zhjs:=(-1.0)*zhjs;
    float1:=phiszjs+zktd-zhjs+shjs;
    with ROQuery1 do begin
      close;
      params.clear;
      params.createparam(ftstring,'x1',ptinput);
      params.createparam(ftdate,'x2',ptinput);
      params.createparam(ftfloat,'x3',ptinput);
      params.createparam(ftfloat,'x4',ptinput);
      params.createparam(ftfloat,'x5',ptinput);
      params.createparam(ftfloat,'x6',ptinput);
      params.createparam(ftinteger,'x7',ptinput);
      commandtext:='select * from prd_wcrq_1(:x1,:x2,:x3,:x4,:x5,:x6,:x7)';
      params[0].asstring:=tblshedule.fieldbyname('pline').value;
      params[1].asdate:=cfksrq;
      params[2].asfloat:=cfksjs;
      params[3].asfloat:=float1;
      params[4].asfloat:=0;
      params[5].asfloat:=0;
      params[6].asinteger:=tblshedule.fieldbyname('seq').value;
      open;
      cfwcrq:=fieldbyname('o_wcrq').value;
      cfwcjs:=fieldbyname('o_wcjs').value;
    end;
    tblshedule.fieldbyname('week').value:=week1;
    tblshedule.fieldbyname('cfwcrq').value:=cfwcrq;
    tblshedule.fieldbyname('cfwcjs').value:=cfwcjs;
    tblshedule.fieldbyname('tzlcrq').value:=cfwcrq+1;
  end;
end;

procedure Tworksheet1.FormDeactivate(Sender: TObject);
begin
  label3.caption:='';
end;

procedure Tworksheet1.FormShow(Sender: TObject);
begin
  flflag:='';
  xglflag:='0';
  label3.caption:='';
  combobox3.items.clear;
  combobox4.items.clear;
  combobox5.Items.Clear;
  {
  with clientdataset1 do begin
    close;
    params.clear;
    commandtext:='select distinct dbzs from tblshedule where yzh=0 and (dbzs is not null)';
    open;
    first;
    while not eof do begin
      combobox4.items.add(fieldbyname('dbzs').value);
      application.ProcessMessages;
      next;
    end;
  end;
  with clientdataset1 do begin
    close;
    params.clear;
    commandtext:='select distinct flag6 from tblshedule where yzh=0 and (flag6 is not null)';
    open;
    first;
    while not eof do begin
      combobox3.items.add(fieldbyname('flag6').value);
      application.ProcessMessages;
      next;
    end;
  end;
  with clientdataset1 do begin
    close;
    params.clear;
    commandtext:='select distinct flag2 from tblshedule where yzh=0 and (flag2 is not null)';
    open;
    first;
    while not eof do begin
      combobox5.items.add(fieldbyname('flag2').value);
      application.ProcessMessages;
      next;
    end;
  end;
  }
  with clientdataset1 do begin
    close;
    params.clear;
    commandtext:='select * from tbluser where usr='''+frmmain.ComboBox1.text+'''';
    open;
    if fieldbyname('qncpy').value=true then begin
      chk6.Visible:=true;
      chk2.Visible:=true;
      chk4.Visible:=true;
    end else begin
      chk6.Visible:=false;
      chk2.Visible:=false;
      chk4.Visible:=false;
    end;
    if fieldbyname('r37').value=true then begin
      cancelx1.Visible:=true;
      cancels1.Visible:=true;
      if fieldbyname('r38').value=true then transitflow1.Visible:=true
      else transitflow1.Visible:=false;
    end else begin
      cancelx1.Visible:=false;
      cancels1.Visible:=false;
      transitflow1.Visible:=false;
    end;
    if fieldbyname('printfj').value=true then printticketforfj1.Visible:=true
    else printticketforfj1.Visible:=false;
    if fieldbyname('r7').value=false then begin
      //dbgrideh1.ReadOnly:=true;
      tblshedule.ReadOnly:=true;
      frmmain.tbn7.Visible:=false;
      frmmain.tbn9.Visible:=false;
      frmmain.tbn10.Visible:=false;
      frmmain.tbn11.Visible:=false;
    end else begin
      tblshedule.ReadOnly:=false;
      if fieldbyname('r9').value=false then cxview1.Columns[10].Options.Editing:=false;//ReadOnly:=true;
      if fieldbyname('r10').value=false then begin
        cxview1.Columns[15].Options.Editing:=false;//ReadOnly:=true;
        cxview1.Columns[17].Options.Editing:=false;//ReadOnly:=true;
        cxview1.Columns[18].Options.Editing:=false;//ReadOnly:=true;
        cxview1.columns[20].Options.Editing:=false;//Readonly:=true;
        cxview1.columns[21].Options.Editing:=false;//Readonly:=true;
      end;
      if fieldbyname('r11').value=false then cxview1.Columns[52].Options.Editing:=false;//ReadOnly:=true;
      //if fieldbyname('r12').value=false then dbgrideh1.Columns[31].ReadOnly:=true;
      if fieldbyname('r15').value=false then cxview1.Columns[1].Options.Editing:=false;//ReadOnly:=true;
      if fieldbyname('r16').value=false then cxview1.Columns[5].Options.Editing:=false;//ReadOnly:=true;
      if fieldbyname('r17').value=false then cxview1.Columns[25].Options.Editing:=false;//ReadOnly:=true;
      if fieldbyname('r35').value=false then begin
        cxview1.columns[30].Options.Editing:=false;//ReadOnly:=true;
        cxview1.Columns[31].Options.Editing:=false;//ReadOnly:=true;
      end;
    end;
  end;
  if lbl850.caption<>'SPE' then
  worksheet1.Caption:=worksheet1.Caption+' - Assembly + Specific'
  else worksheet1.Caption:=worksheet1.Caption+' - Assembly';
end;

procedure Tworksheet1.ClientDataSet1ReconcileError(DataSet: TClientDataSet;
  E: EReconcileError; UpdateKind: TUpdateKind;
  var Action: TReconcileAction);
begin
  showmessage(e.message);
end;

procedure Tworksheet1.ExecCalc(var pline: String; var seq: Integer);
var
  float1:double;
  dt1,cfwcrq,tzlcrq,yqlcrq,qrlcrq:tdatetime;
  wkno1,rqxc,qrxc:integer;
begin
  with clientdataset1 do begin
    close;
    params.clear;
    params.createparam(ftstring,'pline',ptinput);
    params.createparam(ftinteger,'seq',ptinput);
    commandtext:='select * from tblshedule where pline=:pline and seq>=:seq and yzh=false';
    params[0].asstring:=pline;
    params[1].asinteger:=seq;
    open;
    first;
    while not eof do begin
      float1:=fieldbyname('bzjs').value/20;
      if not fieldbyname('cfksrq').isnull then begin
        dt1:=fieldbyname('cfksrq').value;
        wkno1:=calcwkno(dt1);
      end
      else wkno1:=0;
      if not fieldbyname('cfwcrq').isnull then begin
        cfwcrq:=fieldbyname('cfwcrq').value;
        tzlcrq:=cfwcrq+ceiling(float1);
      end
      else tzlcrq:=0;
      if not fieldbyname('yqlcrq').isnull then begin
        yqlcrq:=fieldbyname('yqlcrq').value;
        rqxc:=trunc(yqlcrq)-trunc(tzlcrq);
      end
      else rqxc:=0;
      with clientdataset2 do begin
        close;
        params.clear;
        params.createparam(ftinteger,'week',ptinput);
        params.createparam(ftdate,'tzlcrq',ptinput);
        params.createparam(ftinteger,'rqxc',ptinput);
        params.createparam(ftstring,'pline',ptinput);
        params.createparam(ftinteger,'seq',ptinput);
        commandtext:='update tblshedule set week=:week,tzlcrq=:tzlcrq,rqxc=:rqxc where pline=:pline and seq=:seq';
        if wkno1>0 then
        params[0].asinteger:=wkno1;
        if tzlcrq>0 then
        params[1].asdate:=tzlcrq;
        params[2].asinteger:=rqxc;
        params[3].asstring:=pline;
        params[4].asinteger:=clientdataset1.fieldbyname('seq').value;
        execute;
      end;
      application.ProcessMessages;
      next;
    end;
  end;
end;

procedure Tworksheet1.tblsheduleAfterOpen(DataSet: TDataSet);
begin
  //(tblshedule.fieldbyname('lstrs') as tfloatfield).DisplayFormat:='#0.00;;0.00';
  (tblshedule.fieldbyname('phiszjs') as tfloatfield).DisplayFormat:='#0.0;;0.0';
  (tblshedule.fieldbyname('zjs') as tfloatfield).DisplayFormat:='#0.0;;0.0';
  (tblshedule.fieldbyname('zktd') as tfloatfield).DisplayFormat:='#0.0;;0.0';
  (tblshedule.fieldbyname('sclhjs') as tfloatfield).DisplayFormat:='#0.0;;0.0';
  (tblshedule.fieldbyname('shjs') as tfloatfield).DisplayFormat:='#0.0;;0.0';
  (tblshedule.fieldbyname('qyjs') as tfloatfield).DisplayFormat:='#0.0;;0.0';
  (tblshedule.fieldbyname('zhjs') as tfloatfield).DisplayFormat:='#0.0;;0.0';
  (tblshedule.fieldbyname('jxjs') as tfloatfield).DisplayFormat:='#0.00;;0.00';
  (tblshedule.fieldbyname('sjrs') as tfloatfield).displayformat:='#0.0;;0.0';
  (tblshedule.fieldbyname('sjyc') as tfloatfield).displayformat:='#0.0;;0.0';
  (tblshedule.fieldbyname('tbu') as tfloatfield).displayformat:='#0.00';
  (tblshedule.fieldbyname('jhl') as tfloatfield).DisplayFormat:='#0.00;;''';
  (tblshedule.fieldbyname('ckjs') as tfloatfield).DisplayFormat:='#0.0;;''';
  (tblshedule.fieldbyname('ysjhl') as tfloatfield).DisplayFormat:='#0.00;;''';
  (tblshedule.fieldbyname('tmu') as tfloatfield).DisplayFormat:='#0.0000;;''';
  (tblshedule.fieldbyname('cfksjs') as tfloatfield).DisplayFormat:='#0.0';
end;

procedure Tworksheet1.DBGridEh1DblClick(Sender: TObject);
var
  pstr:string;
  rpur,rmc:boolean;
begin
  screen.Cursor:=crSQLWait;
  try
  {
  //for child line (column 35 double click)
  if dbgrideh1.SelectedIndex=35 then begin
    with clientdataset1 do begin
      close;
      params.clear;
      params.createparam(ftstring,'x1',ptinput);
      commandtext:='execute procedure sp_subline(:x1)';
      params[0].asstring:=tblshedule.fieldbyname('pline').value;
      execute;
    end;
    if frmchildline=nil then frmchildline:=tfrmchildline.Create(nil);
    with frmchildline.Query1 do begin
      close;
      params.clear;
      params.createparam(ftstring,'x1',ptinput);
      commandtext:='select * from tblsubline where pline=:x1';
      params[0].asstring:=worksheet1.tblshedule.fieldbyname('pline').value;
      open;
    end;
    frmchildline.Show;
  end else if dbgrideh1.SelectedIndex=2 then begin
    //by Project
    if frmnote=nil then frmnote:=tfrmnote.Create(nil);
    frmnote.Caption:='Notepad for LWPM - Project';
    frmnote.Label6.Caption:='1';
    with frmnote.Query1 do begin
      close;
      params.clear;
      commandtext:='select * from tbl_notepad where j_no='''+tblshedule.fieldbyname('j_no').value+'''';
      open;
    end;
    frmnote.Edit1.text:=tblshedule.fieldbyname('j_no').value;
    frmnote.Show;
  end else if dbgrideh1.SelectedIndex=3 then begin
    //by WO
    if frmnote=nil then frmnote:=tfrmnote.Create(nil);
    frmnote.Caption:='Notepad for LWPM - WO';
    frmnote.Label6.Caption:='2';
    with frmnote.Query1 do begin
      close;
      params.clear;
      commandtext:='select * from tbl_notepad where j_no='''+tblshedule.fieldbyname('j_no').value+''' and j2_job='''+tblshedule.fieldbyname('j2_job').value+'''';
      open;
    end;
    frmnote.Edit1.text:=tblshedule.fieldbyname('j_no').value;
    frmnote.Edit2.text:=tblshedule.fieldbyname('j2_job').value;
    frmnote.Show;
  end else if dbgrideh1.SelectedIndex=5 then begin
    //by RWO
    if frmnote=nil then frmnote:=tfrmnote.Create(nil);
    frmnote.Caption:='Notepad for LWPM - RWO/Factory Start Date';
    frmnote.Label6.Caption:='4';
    with frmnote.Query1 do begin
      close;
      params.clear;
      commandtext:='select * from tbl_notepad where j_no='''+tblshedule.fieldbyname('j_no').value+''' and j2_job='''+tblshedule.fieldbyname('j2_job').value+'''';
      commandtext:=commandtext+' and cstyle='''+tblshedule.fieldbyname('cstyle').value+'''';
      open;
    end;
    frmnote.Edit1.text:=tblshedule.fieldbyname('j_no').value;
    frmnote.Edit2.text:=tblshedule.fieldbyname('j2_job').value;
    frmnote.edit3.text:=tblshedule.fieldbyname('rwo').value;
    frmnote.Show;
  end else if dbgrideh1.SelectedIndex=8 then begin
    //by Cust style
    if frmnote=nil then frmnote:=tfrmnote.Create(nil);
    frmnote.Caption:='Notepad for LWPM - Cust Style';
    frmnote.Label6.Caption:='3';
    with frmnote.Query1 do begin
      close;
      params.clear;
      commandtext:='select * from tbl_notepad where j_no='''+tblshedule.fieldbyname('j_no').value+''' and j2_job='''+tblshedule.fieldbyname('j2_job').value+'''';
      commandtext:=commandtext+' and cstyle='''+tblshedule.fieldbyname('cstyle').value+'''';// and rwo='''+tblshedule.fieldbyname('rwo').value+'''';
      open;
    end;
    frmnote.Edit1.text:=tblshedule.fieldbyname('j_no').value;
    frmnote.Edit2.text:=tblshedule.fieldbyname('j2_job').value;
    //frmnote.edit3.text:=tblshedule.fieldbyname('rwo').value;
    frmnote.Show;
  end else if dbgrideh1.SelectedIndex=6 then begin
    //by LW
    if frmnote=nil then frmnote:=tfrmnote.Create(nil);
    frmnote.Caption:='Notepad for LWPM - QN';
    frmnote.Label6.Caption:='5';
    with frmnote.Query1 do begin
      close;
      params.clear;
      commandtext:='select * from tbl_notepad where j_no='''+tblshedule.fieldbyname('j_no').value+''' and j2_job='''+tblshedule.fieldbyname('j2_job').value+'''';
      commandtext:=commandtext+' and cstyle='''+tblshedule.fieldbyname('cstyle').value+''' and rwo='''+tblshedule.fieldbyname('rwo').value+'''';
      commandtext:=commandtext+' and pline='''+tblshedule.fieldbyname('pline').value+''' and pseq='+tblshedule.fieldbyname('seq').asstring;
      open;
    end;
    frmnote.Edit1.text:=tblshedule.fieldbyname('j_no').value;
    frmnote.Edit2.text:=tblshedule.fieldbyname('j2_job').value;
    frmnote.edit3.text:=tblshedule.fieldbyname('rwo').value;
    frmnote.edit4.text:=tblshedule.fieldbyname('fccs').value;
    frmnote.Show;
  end else if dbgrideh1.SelectedIndex=29 then begin
    with clientdataset1 do begin
      close;
      params.clear;
      commandtext:='select * from tbluser where usr='''+frmmain.ComboBox1.text+'''';
      open;
      if not fieldbyname('rmc').isnull then rmc:=fieldbyname('rmc').value;
      if not fieldbyname('rpur').isnull then rpur:=fieldbyname('rpur').value;
    end;
    if (rmc or rpur) then begin
    if frmcurrstart=nil then frmcurrstart:=tfrmcurrstart.Create(nil);
    with frmcurrstart.Query1 do begin
      close;
      params.clear;
      params.createparam(ftstring,'x1',ptinput);
      params.createparam(ftstring,'x2',ptinput);
      params.createparam(ftstring,'x3',ptinput);
      params.createparam(ftstring,'x4',ptinput);
      commandtext:='select * from tbl_rwofdt where j_no=:x1 and j2_job=:x2 and rwo=:x3 and acol=:x4';
      params[0].asstring:=tblshedule.fieldbyname('j_no').value;
      params[1].asstring:=tblshedule.fieldbyname('j2_job').value;
      params[2].asstring:=tblshedule.fieldbyname('rwo').value;
      params[3].asstring:=tblshedule.fieldbyname('acol').value;
      open;
      if not fieldbyname('sby').isnull then frmcurrstart.CEdit1.Value:=fieldbyname('sby').value
      else frmcurrstart.CEdit1.Value:=0;
      if not fieldbyname('cfddt').isnull then frmcurrstart.DateEdit1.Date:=fieldbyname('cfddt').value
      else frmcurrstart.DateEdit1.Text:='';
      if not fieldbyname('knote').isnull then frmcurrstart.Memo1.Lines.Add(fieldbyname('knote').value)
      else frmcurrstart.Memo1.Lines.clear;
    end;
    if rmc then begin
      frmcurrstart.CEdit1.ReadOnly:=false;
      frmcurrstart.DateEdit1.ReadOnly:=false;
      frmcurrstart.Memo1.ReadOnly:=false;
      frmcurrstart.DBGridEh1.ReadOnly:=true;
      frmcurrstart.bitbtn1.Enabled:=false;
    end else begin
      frmcurrstart.CEdit1.ReadOnly:=true;
      frmcurrstart.DateEdit1.ReadOnly:=true;
      frmcurrstart.Memo1.ReadOnly:=true;
      frmcurrstart.DBGridEh1.ReadOnly:=false;
      frmcurrstart.bitbtn1.Enabled:=true;
    end;
    frmcurrstart.Show;
    end;
  end else if dbgrideh1.SelectedIndex=101 then begin
    if frmlwstart=nil then frmlwstart:=tfrmlwstart.Create(nil);
    with frmlwstart.Query1 do begin
      close;
      params.clear;
      params.createparam(ftstring,'x1',ptinput);
      params.createparam(ftstring,'x2',ptinput);
      params.createparam(ftstring,'x3',ptinput);
      commandtext:='select * from tbl_astable where j_no=:x1 and j2_job=:x2 and rwo=:x3';
      params[0].asstring:=tblshedule.fieldbyname('j_no').value;
      params[1].asstring:=tblshedule.fieldbyname('j2_job').value;
      params[2].asstring:=tblshedule.fieldbyname('rwo').value;
      open;
    end;
    frmlwstart.Show;
  end else if dbgrideh1.SelectedIndex=14 then begin
    if frmlwo=nil then frmlwo:=tfrmlwo.create(nil);
    with query1 do begin
      close;
      params.clear;
      params.createparam(ftstring,'x1',ptinput);
      params.createparam(ftinteger,'x2',ptinput);
      commandtext:='execute procedure sp_tbllwo(:x1,:x2)';
      params[0].asstring:=tblshedule.fieldbyname('pline').value;
      params[1].asinteger:=tblshedule.fieldbyname('seq').value;
      execute;
    end;
    with frmlwo.Query1 do begin
      close;
      params.clear;
      params.createparam(ftstring,'x1',ptinput);
      params.createparam(ftinteger,'x2',ptinput);
      commandtext:='select * from tbl_lwo where pline=:x1 and seq=:x2';
      params[0].asstring:=tblshedule.fieldbyname('pline').value;
      params[1].asinteger:=tblshedule.fieldbyname('seq').value;
      open;
    end;
    frmlwo.dbtext1.DataSource:=DataSource1;
    frmlwo.dbtext2.DataSource:=DataSource1;
    frmlwo.dbtext3.DataSource:=DataSource1;
    frmlwo.dbtext4.DataSource:=DataSource1;
    frmlwo.dbtext5.DataSource:=DataSource1;
    frmlwo.dbtext6.DataSource:=DataSource1;
    frmlwo.dbtext7.DataSource:=DataSource1;
    frmlwo.show;
  end else if dbgrideh1.SelectedIndex=10 then begin
   if frmrwotrans=nil then frmrwotrans:=tfrmrwotrans.create(nil);
   with clientdataset1 do begin
     close;
     params.clear;
     params.createparam(ftstring,'x1',ptinput);
     params.createparam(ftstring,'x2',ptinput);
     params.createparam(ftstring,'x3',ptinput);
     params.createparam(ftstring,'x4',ptinput);
     commandtext:='execute procedure sp_rtrs1(:x1,:x2,:x3,:x4)';
     params[0].asstring:=tblshedule.fieldbyname('tplant').value;
     params[1].asstring:=tblshedule.fieldbyname('j_no').value;
     params[2].asstring:=tblshedule.fieldbyname('j2_job').value;
     params[3].asstring:=tblshedule.fieldbyname('rwo').value;
     execute;
   end;
   with frmrwotrans.Query1 do begin
     close;
     params.clear;
     params.createparam(ftstring,'x1',ptinput);
     params.createparam(ftstring,'x2',ptinput);
     params.createparam(ftstring,'x3',ptinput);
     params.createparam(ftstring,'x4',ptinput);
     commandtext:='select * from tbl_rtrs1 where tplant=:x1 and j_no=:x2 and j2_job=:x3 and rwo=:x4';
     params[0].asstring:=tblshedule.fieldbyname('tplant').value;
     params[1].asstring:=tblshedule.fieldbyname('j_no').value;
     params[2].asstring:=tblshedule.fieldbyname('j2_job').value;
     params[3].asstring:=tblshedule.fieldbyname('rwo').value;
     open;
   end;
    frmrwotrans.dbtext1.DataSource:=DataSource1;
    frmrwotrans.dbtext2.DataSource:=DataSource1;
    frmrwotrans.dbtext3.DataSource:=DataSource1;
    frmrwotrans.dbtext4.DataSource:=DataSource1;
    frmrwotrans.dbtext5.DataSource:=DataSource1;
    frmrwotrans.show;
  end;
  }
  finally
    screen.Cursor:=crDefault;
  end;
end;

procedure Tworksheet1.tblsheduleLFLAGChange(Sender: TField);
var
  pline,lflag:string;
  seq:integer;
  oysjhl:double;
begin
  if (copy(tblshedule.fieldbyname('pline').value,1,1)='T') then begin
  if not tblshedule.fieldbyname('lflag').isnull then begin
    if (copy(tblshedule.fieldbyname('lflag').value,1,1)='!') or (copy(tblshedule.fieldbyname('lflag').value,1,1)='^') then flflag:='';
    lflag:=flflag+tblshedule.fieldbyname('lflag').value;
    if ((copy(lflag,1,1)='!') or (copy(lflag,1,1)='^')) then lflag:=copy(lflag,2,2);
    if lflag>'0' then begin
      pline:=tblshedule.fieldbyname('pline').value;
      seq:=tblshedule.fieldbyname('seq').value;
      with ROQuery1 do begin
        close;
        params.clear;
        params.createparam(ftstring,'x1',ptinput);
        params.createparam(ftinteger,'x2',ptinput);
        params.createparam(ftstring,'x3',ptinput);
        commandtext:='select * from sp_jsdxl(:x1,:x2,:x3)';
        params[0].asstring:=pline;
        params[1].asinteger:=seq;
        params[2].asstring:=lflag;
        open;
        oysjhl:=fieldbyname('o_ysjhl').value;
      end;
      tblshedule.fieldbyname('ysjhl').value:=oysjhl;
    end;
    if xglflag='0' then xglflag:='1';
  end;
  end;
end;

procedure Tworksheet1.BitBtn5Click(Sender: TObject);
begin
  screen.cursor:=crhourglass;
  if frmlastorders=nil then frmlastorders:=tfrmlastorders.Create(nil);
  frmlastorders.Caption:='Last Order(s) Print';
  frmlastorders.Label1.Caption:='Last Order(s)';
  frmlastorders.Show;
  screen.Cursor:=crDefault;
end;

procedure Tworksheet1.BitBtn8Click(Sender: TObject);
begin
  screen.cursor:=crhourglass;
  if frmlastorders=nil then frmlastorders:=tfrmlastorders.Create(nil);
  frmlastorders.Caption:='Preparing for Next Order(s) Print';
  frmlastorders.Label1.Caption:='Next Order(s)';
  frmlastorders.Show;
  screen.Cursor:=crDefault;
end;

procedure Tworksheet1.ComboBox3Enter(Sender: TObject);
begin
  combobox3.items.clear;
  with query1 do begin
    close;
    params.clear;
    commandtext:='select distinct flag6 from tblshedule where yzh=0 and flag6>''''';
    open;
    first;
    while not eof do begin
      combobox3.items.add(fieldbyname('flag6').value);
      application.ProcessMessages;
      next;
    end;
  end;
end;

procedure Tworksheet1.ComboBox4Enter(Sender: TObject);
begin
  combobox4.items.clear;
  with query1 do begin
    close;
    params.clear;
    commandtext:='select distinct dbzs from tblshedule where yzh=0 and dbzs>''''';
    open;
    first;
    while not eof do begin
      combobox4.items.add(fieldbyname('dbzs').value);
      application.ProcessMessages;
      next;
    end;
  end;
end;

procedure Tworksheet1.DBGridEh1Columns4EditButtonClick(Sender: TObject;
  var Handled: Boolean);
var
  str1:string;
begin
  str1:='P1 '+tblshedule.fieldbyname('j_no').value+' '+tblshedule.fieldbyname('ordline').asstring+' '+tblshedule.fieldbyname('rwo').value;
  str1:=str1+' '+frmmain.SocketConnection1.Address;
  shellexecute(0,'open','c:\temp\rwoprint.exe',pchar(str1),'c:\temp',sw_show);
end;

procedure Tworksheet1.DBGridEh1Columns6EditButtonClick(Sender: TObject;
  var Handled: Boolean);
begin
  with clientdataset1 do begin
    close;
    params.clear;
    params.createparam(ftstring,'x1',ptinput);
    commandtext:='select cstyle from tbl_stylechart where cstyle=:x1';
    params[0].asstring:=tblshedule.fieldbyname('cstyle').value;
    open;
    if fieldbyname('cstyle').isnull then begin
      with clientdataset2 do begin
        close;
        params.clear;
        params.createparam(ftstring,'x1',ptinput);
        params.createparam(ftstring,'x2',ptinput);
        commandtext:='insert into tbl_stylechart(cstyle,artno) values(:x1,:x2)';
        params[0].asstring:=tblshedule.fieldbyname('cstyle').value;
        params[1].asstring:=tblshedule.fieldbyname('artno').value;
        execute;
      end;
    end;
  end;
  if frmstyleimage=nil then frmstyleimage:=tfrmstyleimage.create(nil);
  frmstyleimage.Label1.Caption:=tblshedule.fieldbyname('cstyle').value;
  frmstyleimage.Show;
end;

procedure Tworksheet1.DBGridEh1Columns26EditButtonClick(Sender: TObject;
  var Handled: Boolean);
begin
    if frmrwoftystartdate=nil then frmrwoftystartdate:=tfrmrwoftystartdate.Create(nil);
    frmrwoftystartdate.show;
end;

procedure Tworksheet1.DBGridEh1Columns8EditButtonClick(Sender: TObject;
  var Handled: Boolean);
begin
  with clientdataset1 do begin
    close;
    params.clear;
    params.createparam(ftstring,'x1',ptinput);
    commandtext:='select acol from tbl_colchart where acol=:x1';
    params[0].asstring:=tblshedule.fieldbyname('acol').value;
    open;
    if fieldbyname('acol').isnull then begin
      with clientdataset2 do begin
        close;
        params.clear;
        params.createparam(ftstring,'x1',ptinput);
        commandtext:='insert into tbl_colchart(acol) values(:x1)';
        params[0].asstring:=tblshedule.fieldbyname('acol').value;
        execute;
      end;
    end;
  end;
  if frmcolimg=nil then frmcolimg:=tfrmcolimg.create(nil);
  frmcolimg.Label1.Caption:=tblshedule.fieldbyname('acol').value;
  frmcolimg.Show;
end;

procedure Tworksheet1.DBGridEh1ColumnsFLAG3EditButtonClick(Sender: TObject;
  var Handled: Boolean);
begin
  if pos('SB',tblshedule.fieldbyname('pline').value)>0 then exit;
  with clientdataset1 do begin
    close;
    params.clear;
    commandtext:='select * from tbluser where usr='''+frmmain.ComboBox1.text+'''';
    open;
    if fieldbyname('r12').value=true then begin
      if frmsellws=nil then frmsellws:=tfrmsellws.Create(nil);
      if not tblshedule.fieldbyname('flag3').isnull then begin
        if (tblshedule.fieldbyname('flag3').value>='1') and (tblshedule.Fieldbyname('flag3').value<='9s') then begin
          with clientdataset2 do begin
            close;
            params.clear;
            params.createparam(ftstring,'x1',ptinput);
            params.createparam(ftinteger,'x2',ptinput);
            commandtext:='select dt1,sect1,dt2,sect2 from tbl_schstatus where pline=:x1 and seq=:x2';
            params[0].asstring:=tblshedule.fieldbyname('pline').value;
            params[1].asinteger:=tblshedule.fieldbyname('seq').value;
            open;
          end;
          if not clientdataset2.fieldbyname('dt1').isnull then begin
            frmsellws.DateEdit1.Date:=clientdataset2.fieldbyname('dt1').value;
            if not clientdataset2.FieldByName('sect1').isnull then frmsellws.Edit1.Value:=clientdataset2.fieldbyname('sect1').value;
            frmsellws.xh3.Checked:=true;
            frmsellws.xh2.ItemIndex:=-1;
          end else begin
            if not clientdataset2.fieldbyname('dt2').isnull then frmsellws.DateEdit1.Date:=clientdataset2.fieldbyname('dt2').value;
            if not clientdataset2.fieldbyname('sect2').isnull then frmsellws.Edit1.Value:=clientdataset2.fieldbyname('sect2').value;
            frmsellws.xh1.Checked:=true;
            frmsellws.xh2.itemindex:=-1;
          end;
        end else if tblshedule.fieldbyname('flag3').value='w' then begin
          with clientdataset2 do begin
            close;
            params.clear;
            params.createparam(ftstring,'x1',ptinput);
            params.createparam(ftinteger,'x2',ptinput);
            commandtext:='select dt3,sect3,sta3 from tbl_schstatus where pline=:x1 and seq=:x2';
            params[0].asstring:=tblshedule.fieldbyname('pline').value;
            params[1].asinteger:=tblshedule.fieldbyname('seq').value;
            open;
          end;
          if not clientdataset2.fieldbyname('dt3').isnull then frmsellws.DateEdit1.Date:=clientdataset2.fieldbyname('dt3').value;
          if not clientdataset2.fieldbyname('sect3').isnull then frmsellws.Edit1.Value:=clientdataset2.fieldbyname('sect3').value;
          if (clientdataset2.fieldbyname('sta3').value='Halt') or (clientdataset2.fieldbyname('sta3').value='H1') then
          frmsellws.xh2.ItemIndex:=0
          else if clientdataset2.fieldbyname('sta3').value='H2' then frmsellws.xh2.ItemIndex:=1
          else if clientdataset2.fieldbyname('sta3').value='H3' then frmsellws.xh2.ItemIndex:=2
          else if clientdataset2.fieldbyname('sta3').value='H4' then frmsellws.xh2.ItemIndex:=3;
        end else if (copy(tblshedule.FieldByName('flag3').value,1,1)='x') or (tblshedule.fieldbyname('flag3').value='z') then begin
          with clientdataset2 do begin
            close;
            params.clear;
            params.createparam(ftstring,'x1',ptinput);
            params.createparam(ftinteger,'x2',ptinput);
            commandtext:='select dt4,sect4 from tbl_schstatus where pline=:x1 and seq=:x2';
            params[0].asstring:=tblshedule.fieldbyname('pline').value;
            params[1].asinteger:=tblshedule.fieldbyname('seq').value;
            open;
          end;
          if not clientdataset2.fieldbyname('dt4').isnull then frmsellws.DateEdit1.Date:=clientdataset2.fieldbyname('dt4').value;
          if not clientdataset2.fieldbyname('sect4').isnull then frmsellws.Edit1.Value:=clientdataset2.fieldbyname('sect4').value;
          frmsellws.xh4.Checked:=true;
          frmsellws.xh2.ItemIndex:=-1;
        end;
      end ;
      frmsellws.Show;
    end else showmessage('You have no right!');
  end;
end;

procedure Tworksheet1.DBGridEh1Columns20EditButtonClick(Sender: TObject;
  var Handled: Boolean);
begin
  if frmscgxdy=nil then frmscgxdy:=tfrmscgxdy.create(nil);
  frmscgxdy.show;
end;

procedure Tworksheet1.chk2Click(Sender: TObject);
var
  cust,pline,styleno,tshop,cstyle,tplant:string;
begin
  screen.Cursor:=crSQLWait;
  if chk2.Checked then begin
    if chk1.Checked then chk1.Checked:=false;
    if chk3.Checked then chk3.Checked:=false;
    if chk4.Checked then chk4.Checked:=false;
    if chk5.Checked then chk5.Checked:=false;
    if chk6.Checked then chk6.Checked:=false;
    speedbutton1click(self);
  end;
  screen.cursor:=crdefault;
end;

procedure Tworksheet1.chk1Click(Sender: TObject);
var
  cust,pline,styleno,tshop,cstyle,tplant:string;
begin
  screen.Cursor:=crSQLWait;
  if chk1.Checked then begin
    if chk7.Checked then chk7.Checked:=false;
    if chk8.Checked then chk8.Checked:=false;
    if chk9.Checked then chk9.Checked:=false;
    if chk5.Checked then chk5.Checked:=false;
    if chk10.Checked then chk10.Checked:=false;
    with clientdataset2 do begin
      close;
      params.clear;
      commandtext:='update tblshedule set dta=''5'' where dta=''0'' and substr(lflag,1,1) in (''!'',''^'') and flag4 in (''a'',''A'') and yzh=0';
      if edit6.text>'' then commandtext:=commandtext+' and tplant='''+edit6.text+'''';
      execute;
    end;
    with clientdataset2 do begin
      close;
      params.clear;
      commandtext:='update tblshedule set dta=''5'' where dta in (''1'',''2'',''3'') and flag4 in (''a'',''A'') and yzh=0';
      if edit6.text>'' then commandtext:=commandtext+' and tplant='''+edit6.text+'''';
      execute;
    end;
    with clientdataset2 do begin
      close;
      params.clear;
      commandtext:='update tblshedule set dta=''0'' where yzh=0 and dta=''5'' and substr(lflag,1,1) not in (''!'',''^'') and flag4 not in (''a'',''A'')';
      if edit6.text>'' then commandtext:=commandtext+' and tplant='''+edit6.text+'''';
      execute;
    end;
    speedbutton1click(self);
  end;
  screen.cursor:=crdefault;
end;

procedure Tworksheet1.BitBtn9Click(Sender: TObject);
begin
  if tblshedule.active=true then begin
    if tblshedule.state=dsedit then tblshedule.post;
    if chk2.Checked then begin
      if tblshedule.recordcount>0 then begin
        with clientdataset1 do begin
          close;
          params.clear;
          commandtext:='update tblshedule set dta=''0'' where yzh=0 and dta<>''1'' and ((fccs like ''%u'') or (fccs like ''%d%'') or (fccs like ''%D''))';
          execute;
        end;
        with clientdataset1 do begin
          close;
          params.clear;
          commandtext:='select * from tblshedule where yzh=0 and ((fccs like ''%u'') or (fccs like ''%d%'') or (fccs like ''%D''))';
          if edit2.text>'' then commandtext:=commandtext+' and upper(pline)='''+edit2.text+'''';
          if edit1.text>'' then commandtext:=commandtext+' and j_no='''+edit1.text+'''';
          if edit4.text>'' then commandtext:=commandtext+' and (tshop like '''+edit4.text+'%'')';
          if edit5.text>'' then commandtext:=commandtext+' and (cstyle like '''+edit5.text+'%'')';
          if edit6.text>'' then commandtext:=commandtext+' and tplant='''+edit6.text+'''';
          if combobox1.text>'' then commandtext:=commandtext+' and grp='''+combobox1.text+'''';
          if edit7.text>'' then commandtext:=commandtext+' and j_no like '''+edit7.text+'%''';
          if combobox2.text>'' then commandtext:=commandtext+' and flag6 like '''+combobox2.text+'%''';
          if combobox3.text>'' then commandtext:=commandtext+' and flag6='''+combobox3.text+'''';
          if combobox4.text>'' then commandtext:=commandtext+' and dbzs='''+combobox4.text+'''';
          if edit3.text>'' then commandtext:=commandtext+' and acol='''+edit3.text+'''';
          if combobox5.text>'' then commandtext:=commandtext+' and flag2='''+combobox5.text+'''';
          commandtext:=commandtext+' order by dta desc,tplant,tshop,pline,seq';
          open;
          if not fieldbyname('pline').isnull then begin
            if frmprint5=nil then frmprint5:=tfrmprint5.create(nil);
            frmprint5.pplabel59.caption:='---- QN Split Conduct Dashboard (QN halt -> DSQN keep/jump -> DSQN re-active) - DTA & PLC';
            frmprint5.xdhq.Caption:='All excluding actual ex-fty(Line/QN start date/--/'+edit6.text+')';
            frmprint5.ppReport1.print;
          end;
        end;
      end;
    end;
  end;
end;

procedure Tworksheet1.BitBtn7Click(Sender: TObject);
begin
  if tblshedule.Active then begin
    if not tblshedule.fieldbyname('pline').isnull then begin
      if frmtrsummary=nil then frmtrsummary:=tfrmtrsummary.Create(nil);
      frmtrsummary.Edit1.Text:=tblshedule.fieldbyname('j_no').value;
      frmtrsummary.Edit2.Text:=tblshedule.fieldbyname('j2_job').value;
      frmtrsummary.Edit3.Text:=tblshedule.fieldbyname('rwo').value;
      frmtrsummary.Show;
    end;
  end;
end;

procedure Tworksheet1.Cancelx1Click(Sender: TObject);
begin
  with clientdataset1 do begin
    close;
    params.clear;
    params.createparam(ftstring,'x1',ptinput);
    params.createparam(ftinteger,'x2',ptinput);
    commandtext:='update tbl_schstatus set dt4=null,sect4=0,sta4='''' where pline=:x1 and seq=:x2';
    params[0].asstring:=tblshedule.fieldbyname('pline').value;
    params[1].asinteger:=tblshedule.Fieldbyname('seq').value;
    execute;
  end;
  with clientdataset1 do begin
    close;
    params.clear;
    params.createparam(ftstring,'x1',ptinput);
    params.createparam(ftinteger,'x2',ptinput);
    commandtext:='delete from tblshedule_stime where pline=:x1 and seq=:x2';
    params[0].asstring:=tblshedule.fieldbyname('pline').value;
    params[1].asinteger:=tblshedule.Fieldbyname('seq').value;
    execute;
  end;
  with tblshedule do begin
    edit;
    fieldbyname('flag3').value:='';
    fieldbyname('ckjs').value:=0;
    post;
  end;
end;

procedure Tworksheet1.Cancels1Click(Sender: TObject);
begin
  with clientdataset1 do begin
    close;
    params.clear;
    params.createparam(ftstring,'x1',ptinput);
    params.createparam(ftinteger,'x2',ptinput);
    commandtext:='update tbl_schstatus set dt1=null,sect1=0,sta1='''',dt2=null,sect2=0,sta2='''' where pline=:x1 and seq=:x2';
    params[0].asstring:=tblshedule.fieldbyname('pline').value;
    params[1].asinteger:=tblshedule.Fieldbyname('seq').value;
    execute;
  end;
  with clientdataset1 do begin
    close;
    params.clear;
    params.createparam(ftstring,'x1',ptinput);
    params.createparam(ftinteger,'x2',ptinput);
    commandtext:='delete from tblshedule_stime where pline=:x1 and seq=:x2';
    params[0].asstring:=tblshedule.fieldbyname('pline').value;
    params[1].asinteger:=tblshedule.Fieldbyname('seq').value;
    execute;
  end;
  with tblshedule do begin
    edit;
    fieldbyname('flag3').value:='';
    post;
  end;
end;

procedure Tworksheet1.chk3Click(Sender: TObject);
var
  cust,pline,styleno,tshop,cstyle,tplant:string;
begin
  screen.Cursor:=crSQLWait;
  if tblshedule.state=dsedit then tblshedule.post;
  if chk3.Checked then begin
    if chk1.Checked then chk1.Checked:=false;
    if chk2.Checked then chk2.Checked:=false;
    if chk4.Checked then chk4.Checked:=false;
    if chk5.Checked then chk5.Checked:=false;
    if chk6.Checked then chk6.Checked:=false;
    speedbutton1click(self);
  end;
  screen.cursor:=crdefault;
end;

procedure Tworksheet1.tblsheduleYzhChange(Sender: TField);
begin
  if tblshedule.fieldbyname('yzh').value=true then tblshedule.fieldbyname('pd8').value:=date;
end;

procedure Tworksheet1.DBGridEh1Columns30EditButtonClick(Sender: TObject;
  var Handled: Boolean);
var
  mouse1:Tmouse;
  dt:tdate;
begin
  with clientdataset1 do begin
    close;
    params.clear;
    commandtext:='select * from tbluser where usr='''+frmmain.ComboBox1.text+'''';
    open;
    if fieldbyname('r35').value=true then begin
      handled:=true;
    end else handled:=false;
  end;
  if handled then begin
    if not tblshedule.FieldByName('cplan').isnull then dt:=tblshedule.fieldbyname('cplan').value
    else dt:=tblshedule.fieldbyname('plan_date').value;
    mouse1:=tmouse.Create;
    try
      if frmmcal=nil then frmmcal:=tfrmmcal.create(nil);
      frmmcal.Label1.Caption:='V';
      frmmcal.MonthCalendar1.CalendarDate:=dt-tblshedule.fieldbyname('unbal').value;
      frmmcal.Left:=mouse1.CursorPos.X-100;
      frmmcal.Top:=mouse1.CursorPos.Y;
      frmmcal.Show;
    finally
      mouse1.Free;
    end;
  end;
end;

procedure Tworksheet1.DBGridEh1Columns52EditButtonClick(Sender: TObject;
  var Handled: Boolean);
var
  mouse1:Tmouse;
  y,m,d:word;
  dt:tdate;
begin
  with clientdataset1 do begin
    close;
    params.clear;
    commandtext:='select * from tbluser where usr='''+frmmain.ComboBox1.text+'''';
    open;
    if fieldbyname('r11').value=true then begin
      handled:=true;
    end else handled:=false;
  end;
  if handled then begin
    decodedate(tblshedule.fieldbyname('yqlcrq').value,y,m,d);
    dt:=encodedate(y,m,d);
    mouse1:=tmouse.Create;
    try
      if frmmcal=nil then frmmcal:=tfrmmcal.create(nil);
      frmmcal.Label1.Caption:='AQ';
      frmmcal.MonthCalendar1.CalendarDate:=dt-tblshedule.fieldbyname('qrxc').value;
      frmmcal.Left:=mouse1.CursorPos.X-100;
      frmmcal.Top:=mouse1.CursorPos.Y;
      frmmcal.Show;
    finally
      mouse1.Free;
    end;
  end;
end;

procedure Tworksheet1.DBGridEh1ColumnsSTYLEEditButtonClick(Sender: TObject;
  var Handled: Boolean);
begin
  if frmcstylegrp=nil then frmcstylegrp:=tfrmcstylegrp.create(nil);
  frmcstylegrp.Show;
end;

procedure Tworksheet1.chk4Click(Sender: TObject);
var
  cust,pline,styleno,tshop,cstyle,tplant:string;
begin
  screen.Cursor:=crSQLWait;
  if chk4.Checked then begin
    if chk1.Checked then chk1.Checked:=false;
    if chk2.Checked then chk2.Checked:=false;
    if chk3.Checked then chk3.Checked:=false;
    if chk5.Checked then chk5.Checked:=false;
    if chk6.Checked then chk6.Checked:=false;
    speedbutton1click(self);
  end;
  screen.cursor:=crdefault;
end;

procedure Tworksheet1.BitBtn11Click(Sender: TObject);
begin
  if tblshedule.active=true then begin
    if tblshedule.state=dsedit then tblshedule.post;
    if chk4.Checked then begin
      if tblshedule.recordcount>0 then begin
        with clientdataset1 do begin
          close;
          params.clear;
          commandtext:='select * from tblshedule where yzh=0';// and ((fccs like ''%u'') or (fccs like ''%d%'') or (fccs like ''%D''))';
          if chk4.Checked then commandtext:=commandtext+' and dta in (''3'',''4'')';
          if edit2.text>'' then commandtext:=commandtext+' and upper(pline)='''+edit2.text+'''';
          if edit1.text>'' then commandtext:=commandtext+' and j_no='''+edit1.text+'''';
          if edit4.text>'' then commandtext:=commandtext+' and (tshop like '''+edit4.text+'%'')';
          if edit5.text>'' then commandtext:=commandtext+' and (cstyle like '''+edit5.text+'%'')';
          if edit6.text>'' then commandtext:=commandtext+' and tplant='''+edit6.text+'''';
          if combobox1.text>'' then commandtext:=commandtext+' and grp='''+combobox1.text+'''';
          if edit7.text>'' then commandtext:=commandtext+' and j_no like '''+edit7.text+'%''';
          if combobox2.text>'' then commandtext:=commandtext+' and flag6 like '''+combobox2.text+'%''';
          if combobox3.text>'' then commandtext:=commandtext+' and flag6='''+combobox3.text+'''';
          if combobox4.text>'' then commandtext:=commandtext+' and dbzs='''+combobox4.text+'''';
          if edit3.text>'' then commandtext:=commandtext+' and acol='''+edit3.text+'''';
          if combobox5.text>'' then commandtext:=commandtext+' and flag2='''+combobox5.text+'''';
          commandtext:=commandtext+' order by dta,tplant,tshop,pline,seq';
          open;
          if not fieldbyname('pline').isnull then begin
            if frmprint5=nil then frmprint5:=tfrmprint5.create(nil);
            frmprint5.pplabel59.caption:=' ----  QN/DSQN SKU exchange Dashboard - DTA';
            frmprint5.xdhq.Caption:='All excluding actual ex-fty(Line/QN start date/--/'+edit6.text+')';
            frmprint5.ppReport1.print;
          end;
        end;
      end;
    end;
  end;
end;

procedure Tworksheet1.WIPTransit1Click(Sender: TObject);
begin
  if frmprintwip=nil then frmprintwip:=tfrmprintwip.create(nil);
  frmprintwip.show;
end;

procedure Tworksheet1.chk5Click(Sender: TObject);
var
  cust,pline,styleno,tshop,cstyle,tplant:string;
begin
  screen.Cursor:=crSQLWait;
  if tblshedule.state=dsedit then tblshedule.post;
  if chk5.Checked then begin
    if chk1.Checked then chk1.Checked:=false;
    if chk7.Checked then chk7.Checked:=false;
    if chk8.Checked then chk8.Checked:=false;
    if chk9.Checked then chk9.Checked:=false;
    if chk10.Checked then chk10.Checked:=false;
    speedbutton1click(self);
  end;
  screen.cursor:=crdefault;
end;

procedure Tworksheet1.chk6Click(Sender: TObject);
var
  cust,pline,styleno,tshop,cstyle,tplant:string;
begin
  screen.Cursor:=crSQLWait;
  if tblshedule.state=dsedit then tblshedule.post;
  if chk6.Checked then begin
    if chk1.Checked then chk1.Checked:=false;
    if chk2.Checked then chk2.Checked:=false;
    if chk3.Checked then chk3.Checked:=false;
    if chk4.Checked then chk4.Checked:=false;
    if chk5.Checked then chk5.Checked:=false;
    speedbutton1click(self);
  end;
  screen.cursor:=crdefault;
end;

procedure Tworksheet1.tblsheduleBeforeEdit(DataSet: TDataSet);
begin
  if copy(tblshedule.fieldbyname('lflag').value,1,1)='!' then flflag:='^' else flflag:='';
end;

procedure Tworksheet1.DBGridEh1GetCellParams(Sender: TObject;
  Column: TColumnEh; AFont: TFont; var Background: TColor;
  State: TGridDrawState);
begin 
  if (chk1.Checked or chk2.Checked or chk4.Checked) then begin
    if tblshedule.state=dsbrowse then begin
      if tblshedule.fieldbyname('dta').value='5' then AFont.Color:=clBlack
      else if (tblshedule.fieldbyname('dta').value='1') or (tblshedule.fieldbyname('dta').value='2') or (tblshedule.fieldbyname('dta').value='3') then
      AFont.Color:=clRed
      else AFont.Color:=clGreen;
    end;
  end;
end;

procedure Tworksheet1.FormCreate(Sender: TObject);
begin
  siLang1.LoadAllFromFile(extractfilepath(application.ExeName)+'LWPM_LANGUAGE.sil',false);
  siLang1.Language:=frmmain.ComboBox2.text;
        with clientdataset2 do begin
          close;
          params.clear;
          params.createparam(ftinteger,'x1',ptinput);
          commandtext:='select max(dseq) as q1 from tbl_logging where seq=:x1';
          params[0].asinteger:=frmmain.SpinEdit1.Value;
          open;
          if not fieldbyname('q1').isnull then logseq:=fieldbyname('q1').value+1
          else logseq:=2;
        end;
        with clientdataset2 do begin
          close;
          params.clear;
          params.createparam(ftinteger,'x1',ptinput);
          params.CreateParam(ftstring,'x2',ptinput);
          params.createparam(ftstring,'x3',ptinput);
          params.createparam(ftdatetime,'x4',ptinput);
          params.createparam(ftstring,'x5',ptinput);
          params.createparam(ftinteger,'x6',ptinput);
          commandtext:='insert into tbl_logging(seq,usr,frmid,strdt,ip,dseq) values(:x1,:x2,:x3,:x4,:x5,:x6)';
          params[0].asinteger:=frmmain.spinedit1.Value;
          params[1].AsString:=frmmain.combobox1.text;
          params[2].AsString:='Planning & Scheduling';
          params[3].AsDateTime:=now;
          params[4].asstring:=frmmain.tcp1.LocalIP;
          params[5].AsInteger:=logseq;
          execute;
        end;
        with dataset2 do begin
          close;
          sql.text:='insert into [Sys.Authority].dbo.sysuseinfo(menuid,userid,starttime) values(:x1,:x2,:x3)';
          parameters[0].Value:='LWPM - Planning & Scheduling';
          parameters[1].value:=frmmain.combobox1.text;
          parameters[2].Value:=now;
          execsql;
        end;
        ARedStyle := TcxStyle.Create(Self);
        ARedStyle.TextColor := clRed;
        AGreenStyle := TcxStyle.Create(Self);
        AGreenStyle.TextColor := clGreen;
        ABlackStyle := TcxStyle.Create(Self);
        ABlackStyle.TextColor := clBlack;


end;

procedure Tworksheet1.FormDestroy(Sender: TObject);
begin
        with clientdataset2 do begin
          close;
          params.clear;
          params.createparam(ftdatetime,'x1',ptinput);
          params.createparam(ftinteger,'x2',ptinput);
          params.createparam(ftinteger,'x3',ptinput);
          commandtext:='update tbl_logging set enddt=:x1 where seq=:x2 and dseq=:x3';
          params[0].AsDateTime:=now;
          params[1].asinteger:=frmmain.spinedit1.Value;
          params[2].asinteger:=logseq;
          execute;
        end;
end;

procedure Tworksheet1.GanttChart1Click(Sender: TObject);
begin
  if tblshedule.Active then begin
    if not tblshedule.fieldbyname('pline').isnull then begin
      if frmstartrange=nil then frmstartrange:=tfrmstartrange.create(nil);
      frmstartrange.show;
    end;
  end;
end;

procedure Tworksheet1.Begin1Click(Sender: TObject);
begin
  with clientdataset1 do begin
    close;
    params.clear;
    params.createparam(ftstring,'x1',ptinput);
    commandtext:='select * from tblline where pline=:x1';
    params[0].asstring:=tblshedule.fieldbyname('pline').value;
    open;
    if fieldbyname('lactive').value=false then begin
      if frmsetbeginend=nil then frmsetbeginend:=tfrmsetbeginend.Create(nil);
      frmsetbeginend.Show;
    end;
  end;
end;

procedure Tworksheet1.End1Click(Sender: TObject);
begin
  with clientdataset1 do begin
    close;
    params.clear;
    params.createparam(ftstring,'x1',ptinput);
    commandtext:='select * from tblline where pline=:x1';
    params[0].asstring:=tblshedule.fieldbyname('pline').value;
    open;
    if fieldbyname('lactive').value=false then begin
      if frmsetbeginend=nil then frmsetbeginend:=tfrmsetbeginend.Create(nil);
      frmsetbeginend.Show;
    end;
  end;
end;

procedure Tworksheet1.cxView1CellClick(Sender: TcxCustomGridTableView;
  ACellViewInfo: TcxGridTableDataCellViewInfo; AButton: TMouseButton;
  AShift: TShiftState; var AHandled: Boolean);
var
  oseq,nseq:integer;
  pline:string;
  pstr:string;
begin
  if (label3.caption<>'') and (edit2.text>'') then begin
    AHandled:=true;
    screen.cursor:=crhourglass;
    try
    pline:=tblshedule.fieldbyname('pline').value;
    oseq:=strtoint(label3.caption);
    nseq:=tblshedule.fieldbyname('seq').value;
    with ROQuery1 do begin
      close;
      params.clear;
      params.createparam(ftstring,'pline',ptinput);
      params.createparam(ftinteger,'oseq',ptinput);
      params.createparam(ftinteger,'nseq',ptinput);
      commandtext:='execute procedure calc_seq(:pline,:oseq,:nseq)';
      params[0].asstring:=pline;
      params[1].asinteger:=oseq;
      params[2].asinteger:=nseq;
      execute;
    end;
    with tblshedule do begin
      close;
      params.clear;
      params.createparam(ftstring,'pline',ptinput);
      commandtext:='select * from tblshedule where pline=:pline and yzh=0';
      params[0].asstring:=pline;
      open;
      locate('pline;seq',vararrayof([pline,nseq]),[]);
    end;
    label3.caption:='';
    finally
      screen.cursor:=crdefault;
    end;
  end;
end;

procedure Tworksheet1.cxView1KeyPress(Sender: TObject; var Key: Char);
begin
  if key<>#13 then begin
    if not tblshedule.fieldbyname('flag3').isnull then begin
      if (uppercase(copy(tblshedule.fieldbyname('flag3').value,1,1))='X') or ((tblshedule.fieldbyname('flag3').value>='1') and (tblshedule.fieldbyname('flag3').value<='99s')) then begin
        with clientdataset1 do begin
          close;
          params.clear;
          commandtext:='select r36 from tbluser where usr='''+frmmain.ComboBox1.Text+'''';
          open;
          if fieldbyname('r36').value=0 then key:=#0;
        end;
      end;
    end;
  end;
end;

procedure Tworksheet1.cxView1ColumnHeaderClick(Sender: TcxGridTableView;
  AColumn: TcxGridColumn);
var
  pline:string;
  seq:integer;
  r26,r27,r28,r29,r30,r31,r32,r33,r34,r35:boolean;
begin
  try
  with clientdataset1 do begin
    close;
    params.clear;
    commandtext:='select r26,r27,r28,r29,r30,r31,r32,r33,r34,r35 from tbluser where usr='''+frmmain.ComboBox1.text+'''';
    open;
    r26:=fieldbyname('r26').value;
    r27:=fieldbyname('r27').value;
    r28:=fieldbyname('r28').value;
    r29:=fieldbyname('r29').value;
    r30:=fieldbyname('r30').value;
    r31:=fieldbyname('r31').value;
    r32:=fieldbyname('r32').value;
    r33:=fieldbyname('r33').value;
    r34:=fieldbyname('r34').value;
    r35:=fieldbyname('r35').value;
  end;
  if AColumn=cxView1.Columns[1] then begin
    if frmflag=nil then frmflag:=tfrmflag.create(nil);
    frmflag.Label1.caption:='1';
    frmflag.Caption:='Flag Explanation - Project Process/u{y{';
    if pos('test',application.ExeName)>0 then frmflag.caption:=frmflag.caption+' - Test';
    with frmflag.Query1 do begin
      close;
      params.clear;
      params.createparam(ftinteger,'x1',ptinput);
      commandtext:='select * from flag_marks where fseq=:x1';
      if Acolumn=cxView1.Columns[1] then
      params[0].asinteger:=1
      else if AColumn=cxView1.Columns[20] then params[0].asinteger:=2
      else if AColumn=cxView1.Columns[35] then params[0].asinteger:=3
      else if AColumn=cxView1.Columns[25] then params[0].AsInteger:=4
      else if AColumn=cxView1.Columns[52] then params[0].asinteger:=5
      else if AColumn=cxView1.Columns[7] then params[0].asinteger:=6
      else if AColumn=cxView1.Columns[12] then params[0].asinteger:=9
      else if AColumn=cxView1.Columns[31] then params[0].asinteger:=12
      else if AColumn=cxView1.Columns[24] then params[0].asinteger:=14
      else if AColumn=cxView1.Columns[13] then params[0].asinteger:=10
      else if AColumn=cxView1.Columns[9] then params[0].asinteger:=16;
      open;
    end;
    if r26 then begin
      frmflag.DBGridEh1.ReadOnly:=false;
      frmflag.DBMemo1.ReadOnly:=false;
      frmflag.BitBtn1.Enabled:=true;
      frmflag.BitBtn2.Enabled:=true;
    end else begin
      frmflag.DBGridEh1.ReadOnly:=true;
      frmflag.DBMemo1.ReadOnly:=true;
      frmflag.BitBtn1.Enabled:=false;
      frmflag.BitBtn2.Enabled:=false;
    end;
    frmflag.Panel2.Visible:=false;
    frmflag.Show;
    frmflag.DBGridEh1.SetFocus;
  end else if AColumn=cxView1.Columns[7] then begin
    if frmflag=nil then frmflag:=tfrmflag.create(nil);
    frmflag.Label1.caption:='6';
    frmflag.Caption:='Flag explanation - Style nr prefix:- Product Categories / e:- ~';
    if pos('test',application.ExeName)>0 then frmflag.caption:=frmflag.caption+' - Test';
    with frmflag.Query1 do begin
      close;
      params.clear;
      params.createparam(ftinteger,'x1',ptinput);
      commandtext:='select * from flag_marks where fseq=:x1';
      if AColumn=cxView1.Columns[1] then
      params[0].asinteger:=1
      else if AColumn=cxView1.Columns[20] then params[0].asinteger:=2
      else if AColumn=cxView1.Columns[35] then params[0].asinteger:=3
      else if AColumn=cxView1.Columns[25] then params[0].AsInteger:=4
      else if AColumn=cxView1.Columns[52] then params[0].asinteger:=5
      else if AColumn=cxView1.Columns[7] then params[0].asinteger:=6
      else if AColumn=cxView1.Columns[12] then params[0].asinteger:=9
      else if AColumn=cxView1.Columns[31] then params[0].asinteger:=12
      else if AColumn=cxView1.Columns[24] then params[0].asinteger:=14
      else if AColumn=cxView1.Columns[13] then params[0].asinteger:=10
      else if AColumn=cxView1.Columns[9] then params[0].asinteger:=16;
      open;
    end;
    if r27 then begin
      frmflag.DBGridEh1.ReadOnly:=false;
      frmflag.DBMemo1.ReadOnly:=false;
      frmflag.BitBtn1.Enabled:=true;
      frmflag.BitBtn2.Enabled:=true;
    end else begin
      frmflag.DBGridEh1.ReadOnly:=true;
      frmflag.DBMemo1.ReadOnly:=true;
      frmflag.BitBtn1.Enabled:=false;
      frmflag.BitBtn2.Enabled:=false;
    end;
    frmflag.Panel2.Visible:=false;
    frmflag.Show;
    frmflag.DBGridEh1.SetFocus;
  end else if AColumn=cxView1.Columns[12] then begin
    if frmflag=nil then frmflag:=tfrmflag.create(nil);
    frmflag.Label1.caption:='9';
    frmflag.Caption:='Flag Explanation - Impact Code/';
    if pos('test',application.ExeName)>0 then frmflag.caption:=frmflag.caption+' - Test';
    with frmflag.Query1 do begin
      close;
      params.clear;
      params.createparam(ftinteger,'x1',ptinput);
      commandtext:='select * from flag_marks where fseq=:x1';
      if AColumn=cxView1.Columns[1] then
      params[0].asinteger:=1
      else if AColumn=cxView1.Columns[20] then params[0].asinteger:=2
      else if AColumn=cxView1.Columns[35] then params[0].asinteger:=3
      else if AColumn=cxView1.Columns[25] then params[0].AsInteger:=4
      else if AColumn=cxView1.Columns[52] then params[0].asinteger:=5
      else if AColumn=cxView1.Columns[7] then params[0].asinteger:=6
      else if AColumn=cxView1.Columns[12] then params[0].asinteger:=9
      else if AColumn=cxView1.Columns[31] then params[0].asinteger:=12
      else if AColumn=cxView1.Columns[24] then params[0].asinteger:=14
      else if AColumn=cxView1.Columns[13] then params[0].asinteger:=10
      else if AColumn=cxView1.Columns[9] then params[0].asinteger:=16;
      open;
    end;
    if r28 then begin
      frmflag.DBGridEh1.ReadOnly:=false;
      frmflag.DBMemo1.ReadOnly:=false;
      frmflag.BitBtn1.Enabled:=true;
      frmflag.BitBtn2.Enabled:=true;
    end else begin
      frmflag.DBGridEh1.ReadOnly:=true;
      frmflag.DBMemo1.ReadOnly:=true;
      frmflag.BitBtn1.Enabled:=false;
      frmflag.BitBtn2.Enabled:=false;
    end;
    frmflag.Panel2.Visible:=false;
    frmflag.Show;
    frmflag.DBGridEh1.SetFocus;
  end else if AColumn=cxView1.Columns[13] then begin
    if frmflag=nil then frmflag:=tfrmflag.create(nil);
    frmflag.Label1.caption:='10';
    frmflag.Caption:='Flag Explanation - QN Transit Process/y{';
    if pos('test',application.ExeName)>0 then frmflag.caption:=frmflag.caption+' - Test';
    with frmflag.Query1 do begin
      close;
      params.clear;
      params.createparam(ftinteger,'x1',ptinput);
      commandtext:='select * from flag_marks where fseq=:x1';
      if AColumn=cxView1.Columns[1] then
      params[0].asinteger:=1
      else if AColumn=cxView1.Columns[20] then params[0].asinteger:=2
      else if AColumn=cxView1.Columns[35] then params[0].asinteger:=3
      else if AColumn=cxView1.Columns[25] then params[0].AsInteger:=4
      else if AColumn=cxView1.Columns[52] then params[0].asinteger:=5
      else if AColumn=cxView1.Columns[7] then params[0].asinteger:=6
      else if AColumn=cxView1.Columns[12] then params[0].asinteger:=9
      else if AColumn=cxView1.Columns[31] then params[0].asinteger:=12
      else if AColumn=cxView1.Columns[24] then params[0].asinteger:=14
      else if AColumn=cxView1.Columns[13] then params[0].asinteger:=10
      else if AColumn=cxView1.Columns[9] then params[0].asinteger:=16;
      open;
    end;
    if r29 then begin
      frmflag.DBGridEh1.ReadOnly:=false;
      frmflag.DBMemo1.ReadOnly:=false;
      frmflag.BitBtn1.Enabled:=true;
      frmflag.BitBtn2.Enabled:=true;
    end else begin
      frmflag.DBGridEh1.ReadOnly:=true;
      frmflag.DBMemo1.ReadOnly:=true;
      frmflag.BitBtn1.Enabled:=false;
      frmflag.BitBtn2.Enabled:=false;
    end;
    frmflag.Panel2.Visible:=false;
    frmflag.Show;
    frmflag.DBGridEh1.SetFocus;
  end else if AColumn=cxView1.Columns[20] then begin
    if frmflag=nil then frmflag:=tfrmflag.create(nil);
    frmflag.Label1.caption:='2';
    frmflag.Caption:='Flag Explanation - SAH & BOO Process/SAH & BOOy{';
    if pos('test',application.ExeName)>0 then frmflag.caption:=frmflag.caption+' - Test';
    with frmflag.Query1 do begin
      close;
      params.clear;
      params.createparam(ftinteger,'x1',ptinput);
      commandtext:='select * from flag_marks where fseq=:x1';
      if AColumn=cxView1.Columns[1] then
      params[0].asinteger:=1
      else if AColumn=cxView1.Columns[20] then params[0].asinteger:=2
      else if AColumn=cxView1.Columns[35] then params[0].asinteger:=3
      else if AColumn=cxView1.Columns[25] then params[0].AsInteger:=4
      else if AColumn=cxView1.Columns[52] then params[0].asinteger:=5
      else if AColumn=cxView1.Columns[7] then params[0].asinteger:=6
      else if AColumn=cxView1.Columns[12] then params[0].asinteger:=9
      else if AColumn=cxView1.Columns[31] then params[0].asinteger:=12
      else if AColumn=cxView1.Columns[24] then params[0].asinteger:=14
      else if AColumn=cxView1.Columns[13] then params[0].asinteger:=10
      else if AColumn=cxView1.Columns[9] then params[0].asinteger:=16;
      open;
    end;
    if r30 then begin
      frmflag.DBGridEh1.ReadOnly:=false;
      frmflag.DBMemo1.ReadOnly:=false;
      frmflag.BitBtn1.Enabled:=true;
      frmflag.BitBtn2.Enabled:=true;
    end else begin
      frmflag.DBGridEh1.ReadOnly:=true;
      frmflag.DBMemo1.ReadOnly:=true;
      frmflag.BitBtn1.Enabled:=false;
      frmflag.BitBtn2.Enabled:=false;
    end;
    frmflag.Panel2.Visible:=false;
    frmflag.Show;
    frmflag.DBGridEh1.SetFocus;
  end else if AColumn=cxView1.Columns[25] then begin
    if frmflag=nil then frmflag:=tfrmflag.create(nil);
    frmflag.Label1.caption:='4';
    frmflag.Caption:='Flag Explanation - Default phase of line eff.(opt perf)/w]qv(@{)';
    if pos('test',application.ExeName)>0 then frmflag.caption:=frmflag.caption+' - Test';
    with frmflag.Query1 do begin
      close;
      params.clear;
      params.createparam(ftinteger,'x1',ptinput);
      commandtext:='select * from flag_marks where fseq=:x1';
      if AColumn=cxView1.Columns[1] then
      params[0].asinteger:=1
      else if AColumn=cxView1.Columns[20] then params[0].asinteger:=2
      else if AColumn=cxView1.Columns[35] then params[0].asinteger:=3
      else if AColumn=cxView1.Columns[25] then params[0].AsInteger:=4
      else if AColumn=cxView1.Columns[52] then params[0].asinteger:=5
      else if AColumn=cxView1.Columns[7] then params[0].asinteger:=6
      else if AColumn=cxView1.Columns[12] then params[0].asinteger:=9
      else if AColumn=cxView1.Columns[31] then params[0].asinteger:=12
      else if AColumn=cxView1.Columns[24] then params[0].asinteger:=14
      else if AColumn=cxView1.Columns[13] then params[0].asinteger:=10
      else if AColumn=cxView1.Columns[9] then params[0].asinteger:=16;
      open;
    end;
    if r31 then begin
      frmflag.DBGridEh1.ReadOnly:=false;
      frmflag.DBMemo1.ReadOnly:=false;
      frmflag.BitBtn1.Enabled:=true;
      frmflag.BitBtn2.Enabled:=true;
    end else begin
      frmflag.DBGridEh1.ReadOnly:=true;
      frmflag.DBMemo1.ReadOnly:=true;
      frmflag.BitBtn1.Enabled:=false;
      frmflag.BitBtn2.Enabled:=false;
    end;
    frmflag.Panel2.Visible:=false;
    frmflag.Show;
    frmflag.DBGridEh1.SetFocus;
  end else if AColumn=cxView1.Columns[31] then begin
    if frmflag=nil then frmflag:=tfrmflag.create(nil);
    frmflag.Label1.caption:='12';
    frmflag.Caption:='Flag Explanation - RWO Fty Start Date(Locked Diff Process)/st}l(wtZy{)';
    if pos('test',application.ExeName)>0 then frmflag.caption:=frmflag.caption+' - Test';
    with frmflag.Query1 do begin
      close;
      params.clear;
      params.createparam(ftinteger,'x1',ptinput);
      commandtext:='select * from flag_marks where fseq=:x1';
      if AColumn=cxView1.Columns[1] then
      params[0].asinteger:=1
      else if AColumn=cxView1.Columns[20] then params[0].asinteger:=2
      else if AColumn=cxView1.Columns[35] then params[0].asinteger:=3
      else if AColumn=cxView1.Columns[25] then params[0].AsInteger:=4
      else if AColumn=cxView1.Columns[52] then params[0].asinteger:=5
      else if AColumn=cxView1.Columns[7] then params[0].asinteger:=6
      else if AColumn=cxView1.Columns[12] then params[0].asinteger:=9
      else if AColumn=cxView1.Columns[31] then params[0].asinteger:=12
      else if AColumn=cxView1.Columns[24] then params[0].asinteger:=14
      else if AColumn=cxView1.Columns[13] then params[0].asinteger:=10
      else if AColumn=cxView1.Columns[9] then params[0].asinteger:=16;
      open;
    end;
    if r35 then begin
      frmflag.DBGridEh1.ReadOnly:=false;
      frmflag.DBMemo1.ReadOnly:=false;
      frmflag.BitBtn1.Enabled:=true;
      frmflag.BitBtn2.Enabled:=true;
    end else begin
      frmflag.DBGridEh1.ReadOnly:=true;
      frmflag.DBMemo1.ReadOnly:=true;
      frmflag.BitBtn1.Enabled:=false;
      frmflag.BitBtn2.Enabled:=false;
    end;
    frmflag.Panel2.Visible:=false;
    frmflag.Show;
    frmflag.DBGridEh1.SetFocus;
  end else if AColumn=cxView1.Columns[35] then begin
    if frmflag=nil then frmflag:=tfrmflag.create(nil);
    frmflag.Label1.caption:='3';
    frmflag.Caption:='Flag Explanation - QN/SQN Dynamic Process at workshop / /Oy{-';
    if pos('test',application.ExeName)>0 then frmflag.caption:=frmflag.caption+' - Test';
    with frmflag.Query1 do begin
      close;
      params.clear;
      params.createparam(ftinteger,'x1',ptinput);
      commandtext:='select * from flag_marks where fseq=:x1';
      if AColumn=cxView1.Columns[1] then
      params[0].asinteger:=1
      else if AColumn=cxView1.Columns[20] then params[0].asinteger:=2
      else if AColumn=cxView1.Columns[35] then params[0].asinteger:=3
      else if AColumn=cxView1.Columns[25] then params[0].AsInteger:=4
      else if AColumn=cxView1.Columns[52] then params[0].asinteger:=5
      else if AColumn=cxView1.Columns[7] then params[0].asinteger:=6
      else if AColumn=cxView1.Columns[12] then params[0].asinteger:=9
      else if AColumn=cxView1.Columns[31] then params[0].asinteger:=12
      else if AColumn=cxView1.Columns[24] then params[0].asinteger:=14
      else if AColumn=cxView1.Columns[13] then params[0].asinteger:=10
      else if AColumn=cxView1.Columns[9] then params[0].asinteger:=16;
      open;
    end;
    if r32 then begin
      frmflag.DBGridEh1.ReadOnly:=false;
      frmflag.DBMemo1.ReadOnly:=false;
      frmflag.BitBtn1.Enabled:=true;
      frmflag.BitBtn2.Enabled:=true;
    end else begin
      frmflag.DBGridEh1.ReadOnly:=true;
      frmflag.DBMemo1.ReadOnly:=true;
      frmflag.BitBtn1.Enabled:=false;
      frmflag.BitBtn2.Enabled:=false;
    end;
    frmflag.Panel2.Visible:=false;
    frmflag.Show;
    frmflag.DBGridEh1.SetFocus;
  end else if AColumn=cxView1.Columns[24] then begin
    if frmflag=nil then frmflag:=tfrmflag.create(nil);
    frmflag.Label1.caption:='14';
    frmflag.Caption:='Flag Explanation - Ref for default phase of line eff(opt perf) / w]qv(@{)';
    if pos('test',application.ExeName)>0 then frmflag.caption:=frmflag.caption+' - Test';
    with frmflag.Query1 do begin
      close;
      params.clear;
      params.createparam(ftinteger,'x1',ptinput);
      commandtext:='select * from flag_marks where fseq=:x1';
      if AColumn=cxView1.Columns[1] then
      params[0].asinteger:=1
      else if AColumn=cxView1.Columns[20] then params[0].asinteger:=2
      else if AColumn=cxView1.Columns[35] then params[0].asinteger:=3
      else if AColumn=cxView1.Columns[25] then params[0].AsInteger:=4
      else if AColumn=cxView1.Columns[52] then params[0].asinteger:=5
      else if AColumn=cxView1.Columns[7] then params[0].asinteger:=6
      else if AColumn=cxView1.Columns[12] then params[0].asinteger:=9
      else if AColumn=cxView1.Columns[31] then params[0].asinteger:=12
      else if AColumn=cxView1.Columns[24] then params[0].asinteger:=14
      else if AColumn=cxView1.Columns[13] then params[0].asinteger:=10
      else if AColumn=cxView1.Columns[9] then params[0].asinteger:=16;
      open;
    end;
    if r32 then begin
      frmflag.DBGridEh1.ReadOnly:=false;
      frmflag.DBMemo1.ReadOnly:=false;
      frmflag.BitBtn1.Enabled:=true;
      frmflag.BitBtn2.Enabled:=true;
    end else begin
      frmflag.DBGridEh1.ReadOnly:=true;
      frmflag.DBMemo1.ReadOnly:=true;
      frmflag.BitBtn1.Enabled:=false;
      frmflag.BitBtn2.Enabled:=false;
    end;
    frmflag.Panel2.Visible:=false;
    frmflag.Show;
    frmflag.DBGridEh1.SetFocus;
  end else if AColumn=cxView1.Columns[52] then begin
    if frmflag=nil then frmflag:=tfrmflag.create(nil);
    frmflag.Label1.caption:='5';
    frmflag.Caption:='Flag Explanation - Locked Diff Process/wtZy{';
    if pos('test',application.ExeName)>0 then frmflag.caption:=frmflag.caption+' - Test';
    with frmflag.Query1 do begin
      close;
      params.clear;
      params.createparam(ftinteger,'x1',ptinput);
      commandtext:='select * from flag_marks where fseq=:x1';
      if AColumn=cxView1.Columns[1] then
      params[0].asinteger:=1
      else if AColumn=cxView1.Columns[20] then params[0].asinteger:=2
      else if AColumn=cxView1.Columns[35] then params[0].asinteger:=3
      else if AColumn=cxView1.Columns[25] then params[0].AsInteger:=4
      else if AColumn=cxView1.Columns[52] then params[0].asinteger:=5
      else if AColumn=cxView1.Columns[7] then params[0].asinteger:=6
      else if AColumn=cxView1.Columns[12] then params[0].asinteger:=9
      else if AColumn=cxView1.Columns[31] then params[0].asinteger:=12
      else if AColumn=cxView1.Columns[24] then params[0].asinteger:=14
      else if AColumn=cxView1.Columns[13] then params[0].asinteger:=10
      else if AColumn=cxView1.Columns[9] then params[0].asinteger:=16;
      open;
    end;
    if r32 then begin
      frmflag.DBGridEh1.ReadOnly:=false;
      frmflag.DBMemo1.ReadOnly:=false;
      frmflag.BitBtn1.Enabled:=true;
      frmflag.BitBtn2.Enabled:=true;
    end else begin
      frmflag.DBGridEh1.ReadOnly:=true;
      frmflag.DBMemo1.ReadOnly:=true;
      frmflag.BitBtn1.Enabled:=false;
      frmflag.BitBtn2.Enabled:=false;
    end;
    frmflag.Panel2.Visible:=false;
    frmflag.Show;
    frmflag.DBGridEh1.SetFocus;
  end else if AColumn=cxView1.Columns[9] then begin
    if frmflag=nil then frmflag:=tfrmflag.create(nil);
    frmflag.Label1.caption:='16';
    frmflag.Caption:='Flag explanation - Style nr suffix:- Season# & Range Name / Z:- u`#tCW';
    if pos('test',application.ExeName)>0 then frmflag.caption:=frmflag.caption+' - Test';
    if r26 then begin
      frmflag.DBGridEh1.ReadOnly:=false;
      frmflag.DBMemo1.ReadOnly:=false;
      frmflag.BitBtn1.Enabled:=true;
      frmflag.BitBtn2.Enabled:=true;
    end else begin
      frmflag.DBGridEh1.ReadOnly:=true;
      frmflag.DBMemo1.ReadOnly:=true;
      frmflag.BitBtn1.Enabled:=false;
      frmflag.BitBtn2.Enabled:=false;
    end;
    frmflag.Panel2.Visible:=true;
    frmflag.Show;
    frmflag.ComboBox1.SetFocus;
  end else begin
  end;
  except
    abort;
  end;
end;

procedure Tworksheet1.cxView1CSTYLEPropertiesButtonClick(Sender: TObject;
  AButtonIndex: Integer);
begin
  with clientdataset1 do begin
    close;
    params.clear;
    params.createparam(ftstring,'x1',ptinput);
    commandtext:='select cstyle from tbl_stylechart where cstyle=:x1';
    params[0].asstring:=tblshedule.fieldbyname('cstyle').value;
    open;
    if fieldbyname('cstyle').isnull then begin
      with clientdataset2 do begin
        close;
        params.clear;
        params.createparam(ftstring,'x1',ptinput);
        params.createparam(ftstring,'x2',ptinput);
        commandtext:='insert into tbl_stylechart(cstyle,artno) values(:x1,:x2)';
        params[0].asstring:=tblshedule.fieldbyname('cstyle').value;
        params[1].asstring:=tblshedule.fieldbyname('artno').value;
        execute;
      end;
    end;
  end;
  if frmstyleimage=nil then frmstyleimage:=tfrmstyleimage.create(nil);
  frmstyleimage.Label1.Caption:=tblshedule.fieldbyname('cstyle').value;
  frmstyleimage.Show;
end;

procedure Tworksheet1.cxView1ACOLPropertiesButtonClick(Sender: TObject;
  AButtonIndex: Integer);
begin
  with clientdataset1 do begin
    close;
    params.clear;
    params.createparam(ftstring,'x1',ptinput);
    commandtext:='select acol from tbl_colchart where acol=:x1';
    params[0].asstring:=tblshedule.fieldbyname('acol').value;
    open;
    if fieldbyname('acol').isnull then begin
      with clientdataset2 do begin
        close;
        params.clear;
        params.createparam(ftstring,'x1',ptinput);
        commandtext:='insert into tbl_colchart(acol) values(:x1)';
        params[0].asstring:=tblshedule.fieldbyname('acol').value;
        execute;
      end;
    end;
  end;
  if frmcolimg=nil then frmcolimg:=tfrmcolimg.create(nil);
  frmcolimg.Label1.Caption:=tblshedule.fieldbyname('acol').value;
  frmcolimg.Show;
end;

procedure Tworksheet1.cxView1SCQTYPropertiesButtonClick(Sender: TObject;
  AButtonIndex: Integer);
begin
  screen.Cursor:=crSQLWait;
  try
    if frmlwo=nil then frmlwo:=tfrmlwo.create(nil);
    with ROQuery1 do begin
      close;
      params.clear;
      params.createparam(ftstring,'x1',ptinput);
      params.createparam(ftinteger,'x2',ptinput);
      commandtext:='execute procedure sp_tbllwo(:x1,:x2)';
      params[0].asstring:=tblshedule.fieldbyname('pline').value;
      params[1].asinteger:=tblshedule.fieldbyname('seq').value;
      execute;
    end;
    with frmlwo.Query1 do begin
      close;
      params.clear;
      params.createparam(ftstring,'x1',ptinput);
      params.createparam(ftinteger,'x2',ptinput);
      commandtext:='select * from tbl_lwo where pline=:x1 and seq=:x2';
      params[0].asstring:=tblshedule.fieldbyname('pline').value;
      params[1].asinteger:=tblshedule.fieldbyname('seq').value;
      open;
    end;
    frmlwo.dbtext1.DataSource:=DataSource1;
    frmlwo.dbtext2.DataSource:=DataSource1;
    frmlwo.dbtext3.DataSource:=DataSource1;
    frmlwo.dbtext4.DataSource:=DataSource1;
    frmlwo.dbtext5.DataSource:=DataSource1;
    frmlwo.dbtext6.DataSource:=DataSource1;
    frmlwo.dbtext7.DataSource:=DataSource1;
    frmlwo.show;
  finally
    screen.Cursor:=crDefault;
  end;
end;

procedure Tworksheet1.cxView1SJRSPropertiesButtonClick(Sender: TObject;
  AButtonIndex: Integer);
var
  dt1:tdate;
  tm:tdatetime;
  r12,r36:boolean;
  pstr:string;
begin
  with clientdataset1 do begin
    close;
    params.clear;
    commandtext:='select * from tbluser where usr='''+frmmain.ComboBox1.text+'''';
    open;
    if fieldbyname('r12').isnull then r12:=false else r12:=fieldbyname('r12').value;
    if fieldbyname('r36').isnull then r36:=false else r36:=fieldbyname('r36').value;
  end;
  if r36=true then begin
      tm:=now;

    if not tblshedule.fieldbyname('cfwcrq').isnull then begin
      if ((tblshedule.fieldbyname('flag3').isnull) or (tblshedule.FieldByName('flag3').value<'x')) then begin
        WITH ROQuery1 DO BEGIN
          CLOSE;
          PARAMS.CLEAR;
          PARAMS.CREATEPARAM(FTSTRING,'X1',PTINPUT);
          PARAMS.CREATEPARAM(FTINTEGER,'X2',PTINPUT);
          params.createparam(ftdatetime,'x3',ptinput);
          COMMANDTEXT:='EXECUTE PROCEDURE SP_DIVIDEDSHJS(:X1,:X2,:x3)';
          PARAMS[0].ASSTRING:=TBLSHEDULE.FIELDBYNAME('PLINE').VALUE;
          PARAMS[1].ASINTEGER:=TBLSHEDULE.FIELDBYNAME('SEQ').VALUE;
          params[2].asdatetime:=tm;
          EXECUTE;
        END;
        WITH ROQuery1 DO BEGIN
          CLOSE;
          PARAMS.CLEAR;
          PARAMS.CREATEPARAM(FTSTRING,'X1',PTINPUT);
          PARAMS.CREATEPARAM(FTINTEGER,'X2',PTINPUT);
          COMMANDTEXT:='EXECUTE PROCEDURE SP_updlineshjs_001(:X1,:X2)';
          PARAMS[0].ASSTRING:=TBLSHEDULE.FIELDBYNAME('PLINE').VALUE;
          PARAMS[1].ASINTEGER:=TBLSHEDULE.FIELDBYNAME('SEQ').VALUE;
          EXECUTE;
        END;
      end;
        WITH ROQuery1 DO BEGIN
          CLOSE;
          PARAMS.CLEAR;
          PARAMS.CREATEPARAM(FTSTRING,'X1',PTINPUT);
          PARAMS.CREATEPARAM(FTINTEGER,'X2',PTINPUT);
          COMMANDTEXT:='EXECUTE PROCEDURE SP_updlineshjslst(:X1,:X2)';
          PARAMS[0].ASSTRING:=TBLSHEDULE.FIELDBYNAME('PLINE').VALUE;
          PARAMS[1].ASINTEGER:=TBLSHEDULE.FIELDBYNAME('SEQ').VALUE;
          EXECUTE;
        END;
    end;
        if frmzktd=nil then frmzktd:=tfrmzktd.create(nil);
        frmzktd.lbl850.Caption:=lbl850.Caption;
        if lbl850.Caption='SPE' then begin
          frmzktd.DBGridEh1.columns[24].FieldName:='AQTY_SP';
          frmzktd.DBGridEh1.columns[25].FieldName:='AQTY1_SP';
          frmzktd.DBGridEh1.columns[26].FieldName:='DIFF_SP';
          frmzktd.DBGridEh1.columns[29].FieldName:='DBXL_SP';
          frmzktd.DBGridEh1.columns[32].FieldName:='EFF2_SP';
        end else begin
          frmzktd.DBGridEh1.columns[24].FieldName:='AQTY';
          frmzktd.DBGridEh1.columns[25].FieldName:='AQTY1';
          frmzktd.DBGridEh1.columns[26].FieldName:='DIFF';
          frmzktd.DBGridEh1.columns[29].FieldName:='DBXL';
          frmzktd.DBGridEh1.columns[32].FieldName:='EFF2';
        end;
        with frmzktd.query1 do begin
          close;
          params.clear;
          params.createparam(ftstring,'pline',ptinput);
          params.createparam(ftinteger,'seq',ptinput);
          commandtext:='select * from line_shjs where pline=:x1 and seq=:x2 AND FLAG=''0''';
          params[0].asstring:=tblshedule.fieldbyname('pline').value;
          params[1].asinteger:=tblshedule.fieldbyname('seq').value;
          open;
        end;
        frmzktd.DBText1.DataSource:=datasource1;
        frmzktd.DBText2.DataSource:=datasource1;
        frmzktd.DBText3.DataSource:=datasource1;
        frmzktd.DBText4.DataSource:=datasource1;
        frmzktd.DBText5.DataSource:=datasource1;
        frmzktd.DBText6.DataSource:=datasource1;
        frmzktd.DBText7.DataSource:=datasource1;
        frmzktd.DBText8.DataSource:=datasource1;
        frmzktd.Show;
    {
    pstr:='5 '+tblshedule.fieldbyname('pline').value+' '+tblshedule.fieldbyname('seq').asstring;
    if pos('test',lowercase(application.ExeName))>0 then
    winexec(pchar(extractfilepath(application.exename)+'lwpm_replication_test.exe '+pstr),sw_hide)
    else winexec(pchar(extractfilepath(application.exename)+'lwpm_replication.exe '+pstr),sw_hide);
    }
  end else begin

  if not tblshedule.fieldbyname('flag3').isnull then begin
      tm:=now;

    if ((tblshedule.fieldbyname('flag3').value<'x') and (tblshedule.fieldbyname('flag3').value>'')) then begin
      if not tblshedule.fieldbyname('cfwcrq').isnull then begin
        if r12=true then begin
        WITH ROQuery1 DO BEGIN
          CLOSE;
          PARAMS.CLEAR;
          PARAMS.CREATEPARAM(FTSTRING,'X1',PTINPUT);
          PARAMS.CREATEPARAM(FTINTEGER,'X2',PTINPUT);
          params.createparam(ftdatetime,'x3',ptinput);
          COMMANDTEXT:='EXECUTE PROCEDURE SP_DIVIDEDSHJS(:X1,:X2,:x3)';
          PARAMS[0].ASSTRING:=TBLSHEDULE.FIELDBYNAME('PLINE').VALUE;
          PARAMS[1].ASINTEGER:=TBLSHEDULE.FIELDBYNAME('SEQ').VALUE;
          params[2].asdatetime:=tm;
          EXECUTE;
        END;
        WITH ROQuery1 DO BEGIN
          CLOSE;
          PARAMS.CLEAR;
          PARAMS.CREATEPARAM(FTSTRING,'X1',PTINPUT);
          PARAMS.CREATEPARAM(FTINTEGER,'X2',PTINPUT);
          COMMANDTEXT:='EXECUTE PROCEDURE SP_updlineshjs_001(:X1,:X2)';
          PARAMS[0].ASSTRING:=TBLSHEDULE.FIELDBYNAME('PLINE').VALUE;
          PARAMS[1].ASINTEGER:=TBLSHEDULE.FIELDBYNAME('SEQ').VALUE;
          EXECUTE;
        END;
        WITH ROQuery1 DO BEGIN
          CLOSE;
          PARAMS.CLEAR;
          PARAMS.CREATEPARAM(FTSTRING,'X1',PTINPUT);
          PARAMS.CREATEPARAM(FTINTEGER,'X2',PTINPUT);
          COMMANDTEXT:='EXECUTE PROCEDURE SP_updlineshjslst(:X1,:X2)';
          PARAMS[0].ASSTRING:=TBLSHEDULE.FIELDBYNAME('PLINE').VALUE;
          PARAMS[1].ASINTEGER:=TBLSHEDULE.FIELDBYNAME('SEQ').VALUE;
          EXECUTE;
        END;
        end;
      end;
    end;
        {
    pstr:='5 '+tblshedule.fieldbyname('pline').value+' '+tblshedule.fieldbyname('seq').asstring;
    if pos('test',lowercase(application.ExeName))>0 then
    winexec(pchar(extractfilepath(application.exename)+'lwpm_replication_test.exe '+pstr),sw_hide)
    else winexec(pchar(extractfilepath(application.exename)+'lwpm_replication.exe '+pstr),sw_hide);
    }

        if frmzktd=nil then frmzktd:=tfrmzktd.create(nil);
        frmzktd.lbl850.Caption:=lbl850.Caption;
        if lbl850.Caption='SPE' then begin
          frmzktd.DBGridEh1.columns[24].FieldName:='AQTY_SP';
          frmzktd.DBGridEh1.columns[25].FieldName:='AQTY1_SP';
          frmzktd.DBGridEh1.columns[26].FieldName:='DIFF_SP';
          frmzktd.DBGridEh1.columns[29].FieldName:='DBXL_SP';
          frmzktd.DBGridEh1.columns[32].FieldName:='EFF2_SP';
        end else begin
          frmzktd.DBGridEh1.columns[24].FieldName:='AQTY';
          frmzktd.DBGridEh1.columns[25].FieldName:='AQTY1';
          frmzktd.DBGridEh1.columns[26].FieldName:='DIFF';
          frmzktd.DBGridEh1.columns[29].FieldName:='DBXL';
          frmzktd.DBGridEh1.columns[32].FieldName:='EFF2';
        end;
        with frmzktd.query1 do begin
          close;
          params.clear;
          params.createparam(ftstring,'pline',ptinput);
          params.createparam(ftinteger,'seq',ptinput);
          commandtext:='select * from line_shjs where pline=:x1 and seq=:x2 AND FLAG=''0''';
          params[0].asstring:=tblshedule.fieldbyname('pline').value;
          params[1].asinteger:=tblshedule.fieldbyname('seq').value;
          open;
        end;
        frmzktd.DBText1.DataSource:=datasource1;
        frmzktd.DBText2.DataSource:=datasource1;
        frmzktd.DBText3.DataSource:=datasource1;
        frmzktd.DBText4.DataSource:=datasource1;
        frmzktd.DBText5.DataSource:=datasource1;
        frmzktd.DBText6.DataSource:=datasource1;
        frmzktd.DBText7.DataSource:=datasource1;
        frmzktd.DBText8.DataSource:=datasource1;
        frmzktd.Show;
  end;

  end;
end;

procedure Tworksheet1.cxView1TMUPropertiesButtonClick(Sender: TObject;
  AButtonIndex: Integer);
begin
  if frmscgxdy=nil then frmscgxdy:=tfrmscgxdy.create(nil);
  frmscgxdy.show;
end;

procedure Tworksheet1.cxView1CPLANPropertiesButtonClick(Sender: TObject;
  AButtonIndex: Integer);
var
  rmc,rpur:boolean;
begin
    //if frmrwoftystartdate=nil then frmrwoftystartdate:=tfrmrwoftystartdate.Create(nil);
    //frmrwoftystartdate.show;
    //{
    with clientdataset1 do begin
      close;
      params.clear;
      commandtext:='select * from tbluser where usr='''+frmmain.ComboBox1.text+'''';
      open;
      if not fieldbyname('rmc').isnull then rmc:=fieldbyname('rmc').value;
      if not fieldbyname('rpur').isnull then rpur:=fieldbyname('rpur').value;
    end;
    if (rmc or rpur) then begin
    if frmcurrstart=nil then frmcurrstart:=tfrmcurrstart.Create(nil);
    with frmcurrstart.Query1 do begin
      close;
      params.clear;
      params.createparam(ftstring,'x1',ptinput);
      params.createparam(ftstring,'x2',ptinput);
      params.createparam(ftstring,'x3',ptinput);
      params.createparam(ftstring,'x4',ptinput);
      commandtext:='select * from tbl_rwofdt where j_no=:x1 and j2_job=:x2 and rwo=:x3 and acol=:x4';
      params[0].asstring:=tblshedule.fieldbyname('j_no').value;
      params[1].asstring:=tblshedule.fieldbyname('j2_job').value;
      params[2].asstring:=tblshedule.fieldbyname('rwo').value;
      params[3].asstring:=tblshedule.fieldbyname('acol').value;
      open;
      if not fieldbyname('sby').isnull then frmcurrstart.CEdit1.Value:=fieldbyname('sby').value
      else frmcurrstart.CEdit1.Value:=0;
      if not fieldbyname('cfddt').isnull then frmcurrstart.DateEdit1.Date:=fieldbyname('cfddt').value
      else frmcurrstart.DateEdit1.Text:='';
      if not fieldbyname('knote').isnull then frmcurrstart.Memo1.Lines.Add(fieldbyname('knote').value)
      else frmcurrstart.Memo1.Lines.clear;
    end;
    if rmc then begin
      frmcurrstart.CEdit1.ReadOnly:=false;
      frmcurrstart.DateEdit1.ReadOnly:=false;
      frmcurrstart.Memo1.ReadOnly:=false;
      frmcurrstart.DBGridEh1.ReadOnly:=true;
      frmcurrstart.bitbtn1.Enabled:=false;
    end else begin
      frmcurrstart.CEdit1.ReadOnly:=true;
      frmcurrstart.DateEdit1.ReadOnly:=true;
      frmcurrstart.Memo1.ReadOnly:=true;
      frmcurrstart.DBGridEh1.ReadOnly:=false;
      frmcurrstart.bitbtn1.Enabled:=true;
    end;
    frmcurrstart.Show;
    end;
    //}
end;

procedure Tworksheet1.cxView1FLAG3PropertiesButtonClick(Sender: TObject;
  AButtonIndex: Integer);
begin
  if pos('SB',tblshedule.fieldbyname('pline').value)>0 then exit;
  with clientdataset1 do begin
    close;
    params.clear;
    commandtext:='select * from tbluser where usr='''+frmmain.ComboBox1.text+'''';
    open;
    if fieldbyname('r12').value=true then begin
      if frmsellws=nil then frmsellws:=tfrmsellws.Create(nil);
      if not tblshedule.fieldbyname('flag3').isnull then begin
        if (tblshedule.fieldbyname('flag3').value>='1') and (tblshedule.Fieldbyname('flag3').value<='9s') then begin
          with clientdataset2 do begin
            close;
            params.clear;
            params.createparam(ftstring,'x1',ptinput);
            params.createparam(ftinteger,'x2',ptinput);
            commandtext:='select dt1,sect1,dt2,sect2 from tbl_schstatus where pline=:x1 and seq=:x2';
            params[0].asstring:=tblshedule.fieldbyname('pline').value;
            params[1].asinteger:=tblshedule.fieldbyname('seq').value;
            open;
          end;
          if not clientdataset2.fieldbyname('dt1').isnull then begin
            frmsellws.DateEdit1.Date:=clientdataset2.fieldbyname('dt1').value;
            if not clientdataset2.FieldByName('sect1').isnull then frmsellws.Edit1.Value:=clientdataset2.fieldbyname('sect1').value;
            frmsellws.xh3.Checked:=true;
            frmsellws.xh2.ItemIndex:=-1;
          end else begin
            if not clientdataset2.fieldbyname('dt2').isnull then frmsellws.DateEdit1.Date:=clientdataset2.fieldbyname('dt2').value;
            if not clientdataset2.fieldbyname('sect2').isnull then frmsellws.Edit1.Value:=clientdataset2.fieldbyname('sect2').value;
            frmsellws.xh1.Checked:=true;
            frmsellws.xh2.itemindex:=-1;
          end;
        end else if tblshedule.fieldbyname('flag3').value='w' then begin
          with clientdataset2 do begin
            close;
            params.clear;
            params.createparam(ftstring,'x1',ptinput);
            params.createparam(ftinteger,'x2',ptinput);
            commandtext:='select dt3,sect3,sta3 from tbl_schstatus where pline=:x1 and seq=:x2';
            params[0].asstring:=tblshedule.fieldbyname('pline').value;
            params[1].asinteger:=tblshedule.fieldbyname('seq').value;
            open;
          end;
          if not clientdataset2.fieldbyname('dt3').isnull then frmsellws.DateEdit1.Date:=clientdataset2.fieldbyname('dt3').value;
          if not clientdataset2.fieldbyname('sect3').isnull then frmsellws.Edit1.Value:=clientdataset2.fieldbyname('sect3').value;
          if (clientdataset2.fieldbyname('sta3').value='Halt') or (clientdataset2.fieldbyname('sta3').value='H1') then
          frmsellws.xh2.ItemIndex:=0
          else if clientdataset2.fieldbyname('sta3').value='H2' then frmsellws.xh2.ItemIndex:=1
          else if clientdataset2.fieldbyname('sta3').value='H3' then frmsellws.xh2.ItemIndex:=2
          else if clientdataset2.fieldbyname('sta3').value='H4' then frmsellws.xh2.ItemIndex:=3;
        end else if (copy(tblshedule.FieldByName('flag3').value,1,1)='x') or (tblshedule.fieldbyname('flag3').value='z') then begin
          with clientdataset2 do begin
            close;
            params.clear;
            params.createparam(ftstring,'x1',ptinput);
            params.createparam(ftinteger,'x2',ptinput);
            commandtext:='select dt4,sect4 from tbl_schstatus where pline=:x1 and seq=:x2';
            params[0].asstring:=tblshedule.fieldbyname('pline').value;
            params[1].asinteger:=tblshedule.fieldbyname('seq').value;
            open;
          end;
          if not clientdataset2.fieldbyname('dt4').isnull then frmsellws.DateEdit1.Date:=clientdataset2.fieldbyname('dt4').value;
          if not clientdataset2.fieldbyname('sect4').isnull then frmsellws.Edit1.Value:=clientdataset2.fieldbyname('sect4').value;
          frmsellws.xh4.Checked:=true;
          frmsellws.xh2.ItemIndex:=-1;
        end;
      end ;
      frmsellws.xh1.Enabled:=true;
      frmsellws.xh3.Enabled:=true;
      frmsellws.xh4.Enabled:=true;
      frmsellws.Show;
    end else showmessage('You have no right!');
  end;
end;

procedure Tworksheet1.cxView1CustomDrawCell(Sender: TcxCustomGridTableView;
  ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo;
  var ADone: Boolean);
begin
  if (chk1.Checked or chk2.Checked or chk4.Checked) then begin
    if tblshedule.state=dsbrowse then begin
      if tblshedule.fieldbyname('dta').value='5' then ACanvas.Font.Color:=clBlack
      else if (tblshedule.fieldbyname('dta').value='1') or (tblshedule.fieldbyname('dta').value='2') or (tblshedule.fieldbyname('dta').value='3') then
        ACanvas.Font.Color:=clRed
      else ACanvas.Font.Color:=clGreen;
      //ADone:=true;
    end else ADone:=false;
  end else ADone:=false;
end;

procedure Tworksheet1.cxView1J2_JOBPropertiesButtonClick(Sender: TObject;
  AButtonIndex: Integer);
var
  str1,str2:string;
begin
  {
    if frmnote=nil then frmnote:=tfrmnote.Create(nil);
    frmnote.Caption:='Notepad for LWPM - WO';
    frmnote.Label6.Caption:='2';
    with frmnote.Query1 do begin
      close;
      params.clear;
      commandtext:='select * from tbl_notepad where j_no='''+tblshedule.fieldbyname('j_no').value+''' and j2_job='''+tblshedule.fieldbyname('j2_job').value+'''';
      open;
    end;
    frmnote.Edit1.text:=tblshedule.fieldbyname('j_no').value;
    frmnote.Edit2.text:=tblshedule.fieldbyname('j2_job').value;
    frmnote.Show;
  }
  //
    //str1:=extractfiledir(application.exename);
    str1:=frmmain.Memo2.lines.strings[0];
    if tblshedule.FieldByName('tplant').value='KB' then str2:='"Joew" "123" "TH" "PH.RWO.UI3.0.dll" "PH.RWO.UI.Report.ExReport" "PH.RWO.BackEnd3.0.dll,PH.RWO.BackEnd.ReportJob.JobWOReport,'+tblshedule.fieldbyname('j2_job').value+'"'
    else str2:='"Joew" "123" "EN" "PH.RWO.UI3.0.dll" "PH.RWO.UI.Report.ExReport" "PH.RWO.BackEnd3.0.dll,PH.RWO.BackEnd.ReportJob.JobWOReport,'+tblshedule.fieldbyname('j2_job').value+'"';
    shellexecute(0,'open',pchar('PH.Platform.PHWinApp.exe'),pchar(str2),pchar(str1),sw_show);
end;

procedure Tworksheet1.ExpandAll1Click(Sender: TObject);
begin
  cxView1.ViewData.Expand(True);
end;

procedure Tworksheet1.CollapseAll1Click(Sender: TObject);
begin
  cxView1.ViewData.Collapse(True);
end;

procedure Tworksheet1.ClearSorting1Click(Sender: TObject);
begin
  if cxView1.SortedItemCount>0 then
    cxView1.SortedItems[0].SortOrder:=soNone;
end;

procedure Tworksheet1.StartTime1Click(Sender: TObject);
var
  usr:string;
begin
  with query1 do begin
    close;
    params.clear;
    params.createparam(ftstring,'x1',ptinput);
    params.createparam(ftinteger,'x2',ptinput);
    commandtext:='select usr,stime from tblshedule_stime where pline=:x1 and seq=:x2';
    params[0].asstring:=tblshedule.fieldbyname('pline').value;
    params[1].asinteger:=tblshedule.fieldbyname('seq').value;
    open;
    if not fieldbyname('usr').isnull then usr:=fieldbyname('usr').value else usr:='';
    if not fieldbyname('stime').isnull then showmessage('User: '+usr+' Marked "s" at: '+formatdatetime('yy-MM-dd hh:nn:ss',fieldbyname('stime').value));
  end;
end;

procedure Tworksheet1.cxView1QRXCPropertiesButtonClick(Sender: TObject;
  AButtonIndex: Integer);
var
  mouse1:Tmouse;
  y,m,d:word;
  dt:tdate;
  r11:boolean;
begin
  with clientdataset1 do begin
    close;
    params.clear;
    commandtext:='select * from tbluser where usr='''+frmmain.ComboBox1.text+'''';
    open;
    if fieldbyname('r11').value=true then begin
      r11:=true;
    end else r11:=false;
  end;
  if r11 then begin
    decodedate(tblshedule.fieldbyname('yqlcrq').value,y,m,d);
    dt:=encodedate(y,m,d);
    mouse1:=tmouse.Create;
    try
      if frmmcal=nil then frmmcal:=tfrmmcal.create(nil);
      frmmcal.Label1.Caption:='AQ';
      frmmcal.MonthCalendar1.CalendarDate:=dt-tblshedule.fieldbyname('qrxc').value;
      frmmcal.Left:=mouse1.CursorPos.X-100;
      frmmcal.Top:=mouse1.CursorPos.Y;
      frmmcal.Show;
    finally
      mouse1.Free;
    end;
  end;
end;

procedure Tworksheet1.ExportGAIData1Click(Sender: TObject);
begin
  if frmexportgai=nil then frmexportgai:=tfrmexportgai.create(nil);
  frmexportgai.show;
end;

procedure Tworksheet1.transitFlow1Click(Sender: TObject);
begin
  if frmtransit_temp=nil then frmtransit_temp:=tfrmtransit_temp.Create(nil);
  frmtransit_temp.DateEdit1.date:=date;
  frmtransit_temp.DateEdit2.Date:=date;
  frmtransit_temp.Show;
end;

procedure Tworksheet1.cxView1StylesGetContentStyle(
  Sender: TcxCustomGridTableView; ARecord: TcxCustomGridRecord;
  AItem: TcxCustomGridTableItem; out AStyle: TcxStyle);
begin
  if (chk1.Checked or chk2.Checked or chk4.Checked) then begin
    if tblshedule.state=dsbrowse then begin
      if tblshedule.fieldbyname('dta').value='5' then AStyle:=ABlackStyle
      else if (tblshedule.fieldbyname('dta').value='1') or (tblshedule.fieldbyname('dta').value='2') or (tblshedule.fieldbyname('dta').value='3') then
        AStyle:=ARedStyle
      else AStyle:=AGreenStyle;
      //ADone:=true;
    end;
  end;
end;

procedure Tworksheet1.AllSewingQNs1Click(Sender: TObject);
var
  cust,pline,styleno,tshop,cstyle,tplant:string;
  si:integer;
begin
  //if cxView1.SortedItemCount>0 then
  for si:=0 to cxView1.SortedItemCount-1 do begin
    cxView1.SortedItems[si].SortOrder:=soNone;
  end;

  if tblshedule.state=dsedit then tblshedule.post;
  cust:=edit1.text;
  pline:=edit2.text;
  //styleno:=edit3.text;
  tshop:=edit4.text;
  cstyle:=edit5.text;
  tplant:=edit6.text;
  with tblshedule do begin
    close;
    params.clear;
    commandtext:='select * from tblshedule where yzh=0';
    if pline>'' then commandtext:=commandtext+' and upper(pline)='''+pline+'''';
    if cust>'' then commandtext:=commandtext+' and j_no='''+cust+'''';
    if tshop>'' then commandtext:=commandtext+' and (tshop like '''+tshop+'%'')';
    if cstyle>'' then commandtext:=commandtext+' and (cstyle like '''+cstyle+'%'')';
    if tplant>'' then commandtext:=commandtext+' and tplant='''+tplant+'''';
    if combobox1.text>'' then commandtext:=commandtext+' and grp='''+combobox1.text+'''';
    if edit7.text>'' then commandtext:=commandtext+' and j_no like '''+edit7.text+'%''';
    if combobox2.text>'' then commandtext:=commandtext+' and flag6 like '''+combobox2.text+'%''';
    if combobox3.text>'' then commandtext:=commandtext+' and flag6='''+combobox3.text+'''';
    if combobox4.text>'' then commandtext:=commandtext+' and dbzs='''+combobox4.text+'''';
    if edit3.text>'' then commandtext:=commandtext+' and acol='''+edit3.text+'''';
    if combobox5.text>'' then commandtext:=commandtext+' and flag2='''+combobox5.text+'''';
    if chk1.Checked then commandtext:=commandtext+' and ((substr(lflag,1,1) in (''!'',''^'')) or (dta in (''1'',''5''))) and (substr(pline,1,2) not in (''SG'',''PS'',''NS'',''RS'',''SB'')) '
                                     +'and ((fccs not like ''%u%'') and (fccs not like ''%d%'') and (fccs not like ''%D%''))';
    if chk2.Checked then commandtext:=commandtext+' and ((fccs like ''%u%'') or (fccs like ''%d%'') or (fccs like ''%D%''))';
    if chk3.Checked then commandtext:=commandtext+' and plan_date is null';
    if chk4.Checked then commandtext:=commandtext+' and dta in (''3'',''4'')';
    if chk5.Checked then commandtext:=commandtext+' and pline like ''%SB%''';
    if chk6.Checked then commandtext:=commandtext+' and substr(flag3,1,2) in (''2s'',''3s'',''4s'',''5s'',''6s'',''7s'',''8s'',''9s'',''10'',''11'',''12'',''13'',''14'',''15'')';
    if edit8.text>'' then commandtext:=commandtext+' and upper(jhrs) like '''+edit8.text+'%''';
    if (chk1.Checked or chk2.Checked or chk4.Checked) then commandtext:=commandtext+' and pline not in (''T056F'',''T057F'')';
    commandtext:=commandtext+' and substr(flag3,1,2) in (''1s'',''2s'',''3s'',''4s'',''5s'',''6s'',''7s'',''8s'',''9s'',''10'',''11'',''12'',''13'',''14'',''15'')';
    open;
    editkey;
    if (chk1.Checked or chk2.Checked or chk4.Checked) then indexname:='idx7'
    else indexname:='idx1';
    setkey;
    first;
  end;
end;

procedure Tworksheet1.cxView1RWOPropertiesButtonClick(Sender: TObject;
  AButtonIndex: Integer);
var
  str1,str2:string;
begin
    //str1:=extractfiledir(application.exename);
    str1:=frmmain.Memo2.lines.strings[0];
    if tblshedule.FieldByName('tplant').value='KB' then str2:='"Joew" "123" "TH" "PH.RWO.UI3.0.dll" "PH.RWO.UI.Report.ExReport" "PH.RWO.BackEnd3.0.dll,PH.RWO.BackEnd.ReportJob.JobRWOReport,'+tblshedule.fieldbyname('j2_job').value+';'+tblshedule.fieldbyname('acol').value+';'+copy(tblshedule.fieldbyname('rwo').value,1,pos('/',tblshedule.fieldbyname('rwo').value)-1)+'"'
    else str2:='"Joew" "123" "EN" "PH.RWO.UI3.0.dll" "PH.RWO.UI.Report.ExReport" "PH.RWO.BackEnd3.0.dll,PH.RWO.BackEnd.ReportJob.JobRWOReport,'+tblshedule.fieldbyname('j2_job').value+';'+tblshedule.fieldbyname('acol').value+';'+copy(tblshedule.fieldbyname('rwo').value,1,pos('/',tblshedule.fieldbyname('rwo').value)-1)+'"';
    //str2:=str2+' '+tblshedule.fieldbyname('j2_job').value+' '+tblshedule.fieldbyname('acol').value+' '+copy(tblshedule.fieldbyname('rwo').value,1,pos('/',tblshedule.fieldbyname('rwo').value)-1);
    shellexecute(0,'open',pchar('PH.Platform.PHWinApp.exe'),pchar(str2),pchar(str1),sw_show);
end;

procedure Tworksheet1.cxView1FCCSPropertiesButtonClick(Sender: TObject;
  AButtonIndex: Integer);
var
  str1,str2,usr1,usr2,usr3,a1,c1,b1,wwip,ct,sp,bd:string;
  cqn:integer;
  sqn:string;
  ksrq:tdate;
begin
  //str1:=extractfiledir(application.exename);
  wwip:='false';
  if not tblshedule.fieldbyname('flag3').isnull then begin
    if pos('s',tblshedule.fieldbyname('flag3').value)>0 then wwip:='true'
    else if pos('x',tblshedule.fieldbyname('flag3').value)>0 then wwip:='true';
  end;
  if not tblshedule.fieldbyname('cfksrq').isnull then ksrq:=tblshedule.fieldbyname('cfksrq').value
  else ksrq:=date+90;
  with clientdataset1 do begin
    close;
    params.clear;
    commandtext:='select distinct user1,user2,user3 from tbl_qncfmd where tplant='''+tblshedule.fieldbyname('tplant').value+'''';
    open;
    if not fieldbyname('user1').isnull then usr1:=fieldbyname('user1').value else usr1:='';
    if not fieldbyname('user2').isnull then usr2:=fieldbyname('user2').value else usr2:='';
    if not fieldbyname('user3').isnull then usr3:=fieldbyname('user3').value else usr3:='';
  end;
  str1:=frmmain.Memo2.lines.strings[0];
  if chk10.Checked then begin
    //cQN
    if chk6.Checked then begin
    //if (copy(tblshedule.fieldbyname('flag3').value,1,2)>='2s') and (copy(tblshedule.fieldbyname('flag3').value,1,2)<='9s') then begin
      with clientdataset1 do begin
        close;
        params.clear;
        commandtext:='select count(distinct cstyle) as x1,count(distinct acol) as x2 from tblshedule where pline='''+tblshedule.fieldbyname('pline').value+''' and yzh=0 and flag3 like ''%s%''';
        open;
        if fieldbyname('x1').value>1 then begin
          if fieldbyname('x2').value=1 then begin
            if (pos('AFGH',tblshedule.fieldbyname('j_no').value)>0) or (pos('ANFF',tblshedule.fieldbyname('j_no').value)>0) or (pos('SALL',tblshedule.fieldbyname('j_no').value)>0) then cqn:=3
            else cqn:=2;
          end else cqn:=2;
        end else if fieldbyname('x2').value>1 then cqn:=2
        else cqn:=1;
        //if ((fieldbyname('x1').value>1) or (fieldbyname('x2').value>1)) then cqn:=2 else cqn:=1;
      end;
      if (cqn=1) then begin
        if tblshedule.FieldByName('tplant').value='KB' then str2:='"Joew" "123" "TH" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.cQN3,'+tblshedule.fieldbyname('tplant').value+';'+tblshedule.fieldbyname('pline').value+';'+wwip+';'+formatdatetime('yyyy-MM-dd',ksrq-30)+';'
        else str2:='"Joew" "123" "EN" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.cQN3,'+tblshedule.fieldbyname('tplant').value+';'+tblshedule.fieldbyname('pline').value+';'+wwip+';'+formatdatetime('yyyy-MM-dd',ksrq-30)+';';
        str2:=str2+formatdatetime('yyyy-MM-dd',ksrq-20)+';1;'+usr1+';'+formatdatetime('yyyy-MM-dd',ksrq-16)+';'+usr2+';'
        +formatdatetime('yyyy-MM-dd',ksrq-16)+';'+usr3+';'+formatdatetime('yyyy-MM-dd',ksrq-16)+'"';
      end else if (cqn=2) then begin
        if tblshedule.FieldByName('tplant').value='KB' then str2:='"Joew" "123" "TH" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.cQN1,'+tblshedule.fieldbyname('tplant').value+';'+tblshedule.fieldbyname('pline').value+';'+wwip+';'+formatdatetime('yyyy-MM-dd',ksrq-30)+';'
        else str2:='"Joew" "123" "EN" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.cQN1,'+tblshedule.fieldbyname('tplant').value+';'+tblshedule.fieldbyname('pline').value+';'+wwip+';'+formatdatetime('yyyy-MM-dd',ksrq-30)+';';
        str2:=str2+formatdatetime('yyyy-MM-dd',ksrq-20)+';1;'+usr1+';'+formatdatetime('yyyy-MM-dd',ksrq-16)+';'+usr2+';'
        +formatdatetime('yyyy-MM-dd',ksrq-16)+';'+usr3+';'+formatdatetime('yyyy-MM-dd',ksrq-16)+'"';
      end else if (cqn=3) then begin
        if tblshedule.FieldByName('tplant').value='KB' then str2:='"Joew" "123" "TH" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.cQN1,'+tblshedule.fieldbyname('tplant').value+';'+tblshedule.fieldbyname('pline').value+';'+wwip+';'+formatdatetime('yyyy-MM-dd',ksrq-30)+';'
        else str2:='"Joew" "123" "EN" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.cQN2,'+tblshedule.fieldbyname('tplant').value+';'+tblshedule.fieldbyname('pline').value+';'+wwip+';'+formatdatetime('yyyy-MM-dd',ksrq-30)+';';
        str2:=str2+formatdatetime('yyyy-MM-dd',ksrq-20)+';1;'+usr1+';'+formatdatetime('yyyy-MM-dd',ksrq-16)+';'+usr2+';'
        +formatdatetime('yyyy-MM-dd',ksrq-16)+';'+usr3+';'+formatdatetime('yyyy-MM-dd',ksrq-16)+'"';
      end;
    //sQN
    end else if chk2.Checked then begin
    //end else if (pos('u',tblshedule.fieldbyname('fccs').value)>0) or (pos('d',tblshedule.fieldbyname('fccs').value)>0) then begin
      sqn:=tblshedule.fieldbyname('fccs').value;
      if pos('u',sqn)>0 then sqn:=copy(sqn,1,length(sqn)-1)
      else sqn:=copy(sqn,1,pos('d',sqn)-1);
      with clientdataset1 do begin
        close;
        params.clear;
        commandtext:='select seq,flag3 from tblshedule where pline<>'''+tblshedule.fieldbyname('pline').value+''' and j2_job='''+tblshedule.fieldbyname('j2_job').value+''' and acol='''+tblshedule.fieldbyname('acol').value+''' and rwo='''+tblshedule.fieldbyname('rwo').value+''' and ((fccs like '''+sqn+'%u'') or (fccs like +'''+sqn+'%d%'')) and yzh=0';// and flag3 like ''%s%''';
        open;
        //if not fieldbyname('seq').isnull then cqn:=1 else cqn:=0;
        if fieldbyname('seq').isnull then cqn:=0 else begin
          if not fieldbyname('flag3').isnull then begin
            if pos('s',fieldbyname('flag3').value)>0 then cqn:=2
            else if pos('x',fieldbyname('flag3').value)>0 then cqn:=2
            else cqn:=1;
          end else cqn:=1;
        end;
      end;
      if cqn=0 then begin
        if tblshedule.FieldByName('tplant').value='KB' then str2:='"Joew" "123" "TH" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.bQN1,'+tblshedule.fieldbyname('j2_job').value+';'+tblshedule.fieldbyname('acol').value+';'+tblshedule.fieldbyname('rwo').value+';'+sqn+';'+wwip+';'+formatdatetime('yyyy-MM-dd',ksrq-40)+';'
        else str2:='"Joew" "123" "EN" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.bQN1,'+tblshedule.fieldbyname('j2_job').value+';'+tblshedule.fieldbyname('acol').value+';'+tblshedule.fieldbyname('rwo').value+';'+sqn+';'+wwip+';'+formatdatetime('yyyy-MM-dd',ksrq-40)+';';
        str2:=str2+formatdatetime('yyyy-MM-dd',ksrq-30)+';1;'+usr1+';'+formatdatetime('yyyy-MM-dd',ksrq-26)+';'+usr2+';'
        +formatdatetime('yyyy-MM-dd',ksrq-26)+';'+usr3+';'+formatdatetime('yyyy-MM-dd',ksrq-26)+'"';
      end else if cqn=1 then begin
        if tblshedule.FieldByName('tplant').value='KB' then str2:='"Joew" "123" "TH" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.bQN1,'+tblshedule.fieldbyname('j2_job').value+';'+tblshedule.fieldbyname('acol').value+';'+tblshedule.fieldbyname('rwo').value+';'+sqn+';'+wwip+';'+formatdatetime('yyyy-MM-dd',ksrq-40)+';'
        else str2:='"Joew" "123" "EN" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.bQN2,'+tblshedule.fieldbyname('j2_job').value+';'+tblshedule.fieldbyname('acol').value+';'+tblshedule.fieldbyname('rwo').value+';'+sqn+';'+wwip+';'+formatdatetime('yyyy-MM-dd',ksrq-40)+';';
        str2:=str2+formatdatetime('yyyy-MM-dd',ksrq-30)+';1;'+usr1+';'+formatdatetime('yyyy-MM-dd',ksrq-26)+';'+usr2+';'
        +formatdatetime('yyyy-MM-dd',ksrq-26)+';'+usr3+';'+formatdatetime('yyyy-MM-dd',ksrq-26)+'"';
      end else if cqn=2 then begin
        if tblshedule.FieldByName('tplant').value='KB' then str2:='"Joew" "123" "TH" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.sQN,'+tblshedule.fieldbyname('j2_job').value+';'+tblshedule.fieldbyname('acol').value+';'+tblshedule.fieldbyname('rwo').value+';'+sqn+';'+wwip+';'+formatdatetime('yyyy-MM-dd',ksrq-40)+';'
        else str2:='"Joew" "123" "EN" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.sQN,'+tblshedule.fieldbyname('j2_job').value+';'+tblshedule.fieldbyname('acol').value+';'+tblshedule.fieldbyname('rwo').value+';'+sqn+';'+wwip+';'+formatdatetime('yyyy-MM-dd',ksrq-40)+';';
        str2:=str2+formatdatetime('yyyy-MM-dd',ksrq-30)+';1;'+usr1+';'+formatdatetime('yyyy-MM-dd',ksrq-26)+';'+usr2+';'
        +formatdatetime('yyyy-MM-dd',ksrq-26)+';'+usr3+';'+formatdatetime('yyyy-MM-dd',ksrq-26)+'"';
      end;
    //eQN
    end else if chk4.Checked then begin
    //end else if (tblshedule.fieldbyname('dta').value='3') or (tblshedule.fieldbyname('dta').value='4') then begin
      if tblshedule.FieldByName('tplant').value='KB' then str2:='"Joew" "123" "TH" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.eQN,'+tblshedule.fieldbyname('j2_job').value+';'+tblshedule.fieldbyname('acol').value+';'+tblshedule.fieldbyname('rwo').value+';'+wwip+';'+formatdatetime('yyyy-MM-dd',ksrq-20)+';'
      else str2:='"Joew" "123" "EN" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.eQN,'+tblshedule.fieldbyname('j2_job').value+';'+tblshedule.fieldbyname('acol').value+';'+tblshedule.fieldbyname('rwo').value+';'+wwip+';'+formatdatetime('yyyy-MM-dd',ksrq-20)+';';
      str2:=str2+formatdatetime('yyyy-MM-dd',ksrq-10)+';1;'+usr1+';'+formatdatetime('yyyy-MM-dd',ksrq-6)+';'+usr2+';'
      +formatdatetime('yyyy-MM-dd',ksrq-6)+';'+usr3+';'+formatdatetime('yyyy-MM-dd',ksrq-6)+'"';
    end;
    shellexecute(0,'open',pchar('PH.Platform.PHWinApp.exe'),PChar(str2),pchar(str1),sw_show);
  //single QN
  end else begin
    {
    a1:='0';b1:='';c1:='';
    if tblshedule.fieldbyname('iecls1').value='2' then begin
      c1:='1';
    end else if tblshedule.fieldbyname('iecls1').value='4' then begin
      c1:='1';b1:='2';
    end else if tblshedule.fieldbyname('iecls1').value='6' then begin
      b1:='2';
    end;
    }
    ct:='0.0000'; bd:='0.0000'; sp:='0.0000';
    with clientdataset1 do begin
      close;
      params.clear;
      commandtext:='select distinct ct,bd,sp from ppc_zygx where cstyle='''+tblshedule.fieldbyname('cstyle').value+'''';
      open;
      if not fieldbyname('ct').isnull then ct:=formatfloat('0.0000',fieldbyname('ct').value);
      if not fieldbyname('bd').isnull then bd:=formatfloat('0.0000',fieldbyname('bd').value);
      if not fieldbyname('sp').isnull then sp:=formatfloat('0.0000',fieldbyname('sp').value);
    end;
    if ksrq<=date+60 then begin
      if tblshedule.FieldByName('tplant').value='KB' then begin
        str2:='"Joew" "123" "TH" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.QNForm,0;'+tblshedule.fieldbyname('pline').value+';'+tblshedule.fieldbyname('j2_job').value+';'+tblshedule.fieldbyname('acol').value+';'+tblshedule.fieldbyname('rwo').value+';'+tblshedule.fieldbyname('fccs').value+';'+wwip+';'+formatdatetime('yyyy-MM-dd',ksrq-60)+';';
        str2:=str2+formatdatetime('yyyy-MM-dd',ksrq-40)+';2;'+usr1+';'+formatdatetime('yyyy-MM-dd',ksrq-26)+';'+usr2+';'
        +formatdatetime('yyyy-MM-dd',ksrq-26)+';'+usr3+';'+formatdatetime('yyyy-MM-dd',ksrq-26)+';'+ct+';'+sp+';'+bd+'"';
        shellexecute(0,'open',pchar('PH.Platform.PHWinApp.exe'),PChar(str2),pchar(str1),sw_show);
        {
        if c1='1' then begin
          str2:='"Joew" "123" "TH" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.QNForm,1;'+tblshedule.fieldbyname('pline').value+';'+tblshedule.fieldbyname('j2_job').value+';'+tblshedule.fieldbyname('acol').value+';'+tblshedule.fieldbyname('rwo').value+';'+tblshedule.fieldbyname('fccs').value+';'+wwip+';'+formatdatetime('yyyy-MM-dd',ksrq-60)+';';
          str2:=str2+formatdatetime('yyyy-MM-dd',ksrq-40)+';2;'+usr1+';'+formatdatetime('yyyy-MM-dd',ksrq-26)+';'+usr2+';'
          +formatdatetime('yyyy-MM-dd',ksrq-26)+';'+usr3+';'+formatdatetime('yyyy-MM-dd',ksrq-26)+';'+ct+';'+sp+';'+bd+'"';
          shellexecute(0,'open',pchar('PH.Platform.PHWinApp.exe'),PChar(str2),pchar(str1),sw_show);
        end;
        if b1='2' then begin
          str2:='"Joew" "123" "TH" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.QNForm,2;'+tblshedule.fieldbyname('pline').value+';'+tblshedule.fieldbyname('j2_job').value+';'+tblshedule.fieldbyname('acol').value+';'+tblshedule.fieldbyname('rwo').value+';'+tblshedule.fieldbyname('fccs').value+';'+wwip+';'+formatdatetime('yyyy-MM-dd',ksrq-60)+';';
          str2:=str2+formatdatetime('yyyy-MM-dd',ksrq-40)+';2;'+usr1+';'+formatdatetime('yyyy-MM-dd',ksrq-26)+';'+usr2+';'
          +formatdatetime('yyyy-MM-dd',ksrq-26)+';'+usr3+';'+formatdatetime('yyyy-MM-dd',ksrq-26)+';'+ct+';'+sp+';'+bd+'"';
          shellexecute(0,'open',pchar('PH.Platform.PHWinApp.exe'),PChar(str2),pchar(str1),sw_show);
        end;
        }
      end else begin
        str2:='"Joew" "123" "EN" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.QNForm,0;'+tblshedule.fieldbyname('pline').value+';'+tblshedule.fieldbyname('j2_job').value+';'+tblshedule.fieldbyname('acol').value+';'+tblshedule.fieldbyname('rwo').value+';'+tblshedule.fieldbyname('fccs').value+';'+wwip+';'+formatdatetime('yyyy-MM-dd',ksrq-60)+';';
        str2:=str2+formatdatetime('yyyy-MM-dd',ksrq-40)+';2;'+usr1+';'+formatdatetime('yyyy-MM-dd',ksrq-26)+';'+usr2+';'
        +formatdatetime('yyyy-MM-dd',ksrq-26)+';'+usr3+';'+formatdatetime('yyyy-MM-dd',ksrq-26)+';'+ct+';'+sp+';'+bd+'"';
        shellexecute(0,'open',pchar('PH.Platform.PHWinApp.exe'),PChar(str2),pchar(str1),sw_show);
        {
        if c1='1' then begin
          str2:='"Joew" "123" "EN" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.QNForm,1;'+tblshedule.fieldbyname('pline').value+';'+tblshedule.fieldbyname('j2_job').value+';'+tblshedule.fieldbyname('acol').value+';'+tblshedule.fieldbyname('rwo').value+';'+tblshedule.fieldbyname('fccs').value+';'+wwip+';'+formatdatetime('yyyy-MM-dd',ksrq-60)+';';
          str2:=str2+formatdatetime('yyyy-MM-dd',ksrq-40)+';2;'+usr1+';'+formatdatetime('yyyy-MM-dd',ksrq-26)+';'+usr2+';'
          +formatdatetime('yyyy-MM-dd',ksrq-26)+';'+usr3+';'+formatdatetime('yyyy-MM-dd',ksrq-26)+';'+ct+';'+sp+';'+bd+'"';
          shellexecute(0,'open',pchar('PH.Platform.PHWinApp.exe'),PChar(str2),pchar(str1),sw_show);
        end;
        if b1='2' then begin
          str2:='"Joew" "123" "EN" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.QNForm,2;'+tblshedule.fieldbyname('pline').value+';'+tblshedule.fieldbyname('j2_job').value+';'+tblshedule.fieldbyname('acol').value+';'+tblshedule.fieldbyname('rwo').value+';'+tblshedule.fieldbyname('fccs').value+';'+wwip+';'+formatdatetime('yyyy-MM-dd',ksrq-60)+';';
          str2:=str2+formatdatetime('yyyy-MM-dd',ksrq-40)+';2;'+usr1+';'+formatdatetime('yyyy-MM-dd',ksrq-26)+';'+usr2+';'
          +formatdatetime('yyyy-MM-dd',ksrq-26)+';'+usr3+';'+formatdatetime('yyyy-MM-dd',ksrq-26)+';'+ct+';'+sp+';'+bd+'"';
          shellexecute(0,'open',pchar('PH.Platform.PHWinApp.exe'),PChar(str2),pchar(str1),sw_show);
        end;
        }
      end;
    end else begin
      if tblshedule.FieldByName('tplant').value='KB' then begin
        str2:='"Joew" "123" "TH" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.QNForm,0;'+tblshedule.fieldbyname('pline').value+';'+tblshedule.fieldbyname('j2_job').value+';'+tblshedule.fieldbyname('acol').value+';'+tblshedule.fieldbyname('rwo').value+';'+tblshedule.fieldbyname('fccs').value+';'+wwip+';'+ct+';'+sp+';'+bd+'"';
        {
        if c1='1' then
        str2:='"Joew" "123" "TH" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.QNForm,1;'+tblshedule.fieldbyname('pline').value+';'+tblshedule.fieldbyname('j2_job').value+';'+tblshedule.fieldbyname('acol').value+';'+tblshedule.fieldbyname('rwo').value+';'+tblshedule.fieldbyname('fccs').value+';'+wwip+';'+ct+';'+sp+';'+bd+'"';
        if b1='2' then
        str2:='"Joew" "123" "TH" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.QNForm,2;'+tblshedule.fieldbyname('pline').value+';'+tblshedule.fieldbyname('j2_job').value+';'+tblshedule.fieldbyname('acol').value+';'+tblshedule.fieldbyname('rwo').value+';'+tblshedule.fieldbyname('fccs').value+';'+wwip+';'+ct+';'+sp+';'+bd+'"';
        }
      end else begin
        str2:='"Joew" "123" "EN" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.QNForm,0;'+tblshedule.fieldbyname('pline').value+';'+tblshedule.fieldbyname('j2_job').value+';'+tblshedule.fieldbyname('acol').value+';'+tblshedule.fieldbyname('rwo').value+';'+tblshedule.fieldbyname('fccs').value+';'+wwip+';'+ct+';'+sp+';'+bd+'"';
        {
        if c1='1' then
        str2:='"Joew" "123" "EN" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.QNForm,1;'+tblshedule.fieldbyname('pline').value+';'+tblshedule.fieldbyname('j2_job').value+';'+tblshedule.fieldbyname('acol').value+';'+tblshedule.fieldbyname('rwo').value+';'+tblshedule.fieldbyname('fccs').value+';'+wwip+';'+ct+';'+sp+';'+bd+'"';
        if b1='2' then
        str2:='"Joew" "123" "EN" "PH.QNReport.UI.dll" "PH.QNReport.UI.ExReport" "PH.QNReport.BackEnd.dll,PH.QNReport.BackEnd.Job.QNForm,2;'+tblshedule.fieldbyname('pline').value+';'+tblshedule.fieldbyname('j2_job').value+';'+tblshedule.fieldbyname('acol').value+';'+tblshedule.fieldbyname('rwo').value+';'+tblshedule.fieldbyname('fccs').value+';'+wwip+';'+ct+';'+sp+';'+bd+'"';
        //+formatdatetime('yyyy-MM-dd',ksrq-60)+';'
        //+formatdatetime('yyyy-MM-dd',ksrq-40)+';2;'+usr1+';'+formatdatetime('yyyy-MM-dd',ksrq-26)+';'+usr2+';'
        //+formatdatetime('yyyy-MM-dd',ksrq-26)+';'+usr3+';'+formatdatetime('yyyy-MM-dd',ksrq-26)+'"';
        }
      end;
      shellexecute(0,'open',pchar('PH.Platform.PHWinApp.exe'),PChar(str2),pchar(str1),sw_show);
    end;
  end;
  //showmessage(str2);
end;

procedure Tworksheet1.PrintTicketforFJ1Click(Sender: TObject);
begin
  if (tblshedule.FieldByName('tplant').value<>'KB') then begin
    if frmprintfjticket=nil then frmprintfjticket:=tfrmprintfjticket.Create(nil);
    frmprintfjticket.Show;
  end;
end;

procedure Tworksheet1.RecalculateQN1Click(Sender: TObject);
begin
  with ROQuery1 do begin
    close;
    params.clear;
    params.createparam(ftstring,'x1',ptinput);
    params.createparam(ftstring,'x2',ptinput);
    params.createparam(ftstring,'x3',ptinput);
    params.createparam(ftstring,'x4',ptinput);
    commandtext:='execute procedure sp_updfccs_rwo_new(:x1,:x2,:x3,:x4)';
    params[0].asstring:=tblshedule.fieldbyname('j_no').value;
    params[1].asstring:=tblshedule.fieldbyname('j2_job').value;
    params[2].asstring:=tblshedule.fieldbyname('rwo').value;
    params[3].asstring:=tblshedule.fieldbyname('acol').value;
    execute;
  end;
end;

procedure Tworksheet1.cxView1IECLS1GetCellHint(
  Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord;
  ACellViewInfo: TcxGridTableDataCellViewInfo; const AMousePos: TPoint;
  var AHintText: TCaption; var AIsHintMultiLine: Boolean;
  var AHintTextRect: TRect);
begin
  AHintText:='Code 0 = GSD SAH is equal to line SAH';
  AHintText:=AHintText+chr(13)+chr(20)+'Code 1 = Line SAH (exclude miscellaneous parts making, like shoulder straps making, pad print label and transfer flock label, etc.)';
  AHintText:=AHintText+chr(13)+chr(20)+'Code 2 = Line SAH (same as code 1 plus core tech)';
  AHintText:=AHintText+chr(13)+chr(20)+'Code 3 = Line SAH (same as code 1 plus bonding)';
  AHintText:=AHintText+chr(13)+chr(20)+'Code 4 = Line SAH (same as code 2 plus bonding)';
  AHintText:=AHintText+chr(13)+chr(20)+'Code 5 = Line SAH (exclude core tech only)';
  AHintText:=AHintText+chr(13)+chr(20)+'Code 6 = Line SAH (exclude bonding only)';
  AHintTextRect.Left:=AHintTextRect.Left-50;
  AHintTextRect.Top:=AHintTextRect.Top+20;
  AHintTextRect.Right:=AHintTextRect.Right+250;
  AIsHintMultiLine:=True;
end;

procedure Tworksheet1.ClassbySize1Click(Sender: TObject);
begin
  with clientdataset1 do begin
    close;
    params.clear;
    commandtext:='select distinct cls,psiz from ppc_zygx_sz where cstyle='''+tblshedule.fieldbyname('cstyle').value+'''';
    open;
    if not fieldbyname('cls').isnull then begin
      if frmieclass=nil then frmieclass:=tfrmieclass.Create(nil);
      frmieclass.pagecontrol1.ActivePageIndex:=0;
      with frmieclass.ClientDataSet1 do begin
        close;
        params.clear;
        commandtext:='select distinct cls,acol as psiz from ppc_zygx_clr where cstyle='''+tblshedule.fieldbyname('cstyle').value+'''';
        open;
      end;
      frmieclass.Show;
    end else showmessage('There is no records for this style!');
  end;
end;

procedure Tworksheet1.tblsheduleIECLSChange(Sender: TField);
var
  sah,sah1,sah2,sah3:double;
begin
  if not tblshedule.fieldbyname('iecls').isnull then begin
    if not tblshedule.fieldbyname('iecls1').isnull then begin
      with clientdataset1 do begin
        close;
        params.clear;
        if (length(trim(tblshedule.fieldbyname('iecls1').value))=2)
        and (copy(trim(tblshedule.fieldbyname('iecls1').value),length(trim(tblshedule.fieldbyname('iecls1').value)),1)='+') then
        commandtext:='select lstrs,trs,tmu,flag2,tbu,suf_a,suf_b,suf_c from ppc_zygx where cstyle='''+tblshedule.fieldbyname('cstyle').value+''' and cls='''+tblshedule.fieldbyname('iecls').value+''' and cls1='''+copy(tblshedule.fieldbyname('iecls1').value,1,2)+''''
        else commandtext:='select lstrs,trs,tmu,flag2,tbu,suf_a,suf_b,suf_c from ppc_zygx where cstyle='''+tblshedule.fieldbyname('cstyle').value+''' and cls='''+tblshedule.fieldbyname('iecls').value+''' and cls1='''+copy(tblshedule.fieldbyname('iecls1').value,1,1)+'''';
        open;
        if not fieldbyname('lstrs').isnull then begin
          tblshedule.fieldbyname('lstrs').value:=clientdataset1.fieldbyname('lstrs').value;
          tblshedule.fieldbyname('trs').value:=clientdataset1.fieldbyname('trs').value;
          tblshedule.fieldbyname('flag2').value:=clientdataset1.fieldbyname('flag2').value;
          tblshedule.fieldbyname('tbu').value:=clientdataset1.fieldbyname('tbu').value;
          if (length(trim(tblshedule.fieldbyname('iecls1').value))=2) then begin
            if uppercase(copy(trim(tblshedule.fieldbyname('iecls1').value),length(trim(tblshedule.fieldbyname('iecls1').value)),1))='A' then
            tblshedule.fieldbyname('tmu').value:=clientdataset1.fieldbyname('tmu').value-clientdataset1.fieldbyname('suf_a').value
            else if uppercase(copy(trim(tblshedule.fieldbyname('iecls1').value),length(trim(tblshedule.fieldbyname('iecls1').value)),1))='B' then
            tblshedule.fieldbyname('tmu').value:=clientdataset1.fieldbyname('tmu').value+clientdataset1.fieldbyname('suf_b').value
            else if uppercase(copy(trim(tblshedule.fieldbyname('iecls1').value),length(trim(tblshedule.fieldbyname('iecls1').value)),1))='C' then
            tblshedule.fieldbyname('tmu').value:=clientdataset1.fieldbyname('tmu').value+clientdataset1.fieldbyname('suf_c').value
            else if copy(trim(tblshedule.fieldbyname('iecls1').value),length(trim(tblshedule.fieldbyname('iecls1').value)),1)='+' then
            tblshedule.fieldbyname('tmu').value:=clientdataset1.fieldbyname('tmu').value;
          end else if (length(trim(tblshedule.fieldbyname('iecls1').value))=3) then begin
            sah:=clientdataset1.fieldbyname('tmu').value;
            if uppercase(copy(trim(tblshedule.fieldbyname('iecls1').value),length(trim(tblshedule.fieldbyname('iecls1').value))-1,1))='A' then
            sah1:=clientdataset1.fieldbyname('suf_a').value
            else if uppercase(copy(trim(tblshedule.fieldbyname('iecls1').value),length(trim(tblshedule.fieldbyname('iecls1').value))-1,1))='B' then
            sah1:=clientdataset1.fieldbyname('suf_b').value*(-1.00)
            else if uppercase(copy(trim(tblshedule.fieldbyname('iecls1').value),length(trim(tblshedule.fieldbyname('iecls1').value))-1,1))='C' then
            sah1:=clientdataset1.fieldbyname('suf_c').value*(-1.00);
            if uppercase(copy(trim(tblshedule.fieldbyname('iecls1').value),length(trim(tblshedule.fieldbyname('iecls1').value)),1))='B' then
            sah2:=clientdataset1.fieldbyname('suf_b').value*(-1.00)
            else if uppercase(copy(trim(tblshedule.fieldbyname('iecls1').value),length(trim(tblshedule.fieldbyname('iecls1').value)),1))='C' then
            sah2:=clientdataset1.fieldbyname('suf_c').value*(-1.00);
            tblshedule.fieldbyname('tmu').value:=sah-sah1-sah2;
          end else if (length(trim(tblshedule.fieldbyname('iecls1').value))=4) then begin
            sah:=clientdataset1.fieldbyname('tmu').value;
            if uppercase(copy(trim(tblshedule.fieldbyname('iecls1').value),length(trim(tblshedule.fieldbyname('iecls1').value))-2,1))='A' then
            sah1:=clientdataset1.fieldbyname('suf_a').value
            else if uppercase(copy(trim(tblshedule.fieldbyname('iecls1').value),length(trim(tblshedule.fieldbyname('iecls1').value))-2,1))='B' then
            sah1:=clientdataset1.fieldbyname('suf_b').value*(-1.00)
            else if uppercase(copy(trim(tblshedule.fieldbyname('iecls1').value),length(trim(tblshedule.fieldbyname('iecls1').value))-2,1))='C' then
            sah1:=clientdataset1.fieldbyname('suf_c').value*(-1.00);
            if uppercase(copy(trim(tblshedule.fieldbyname('iecls1').value),length(trim(tblshedule.fieldbyname('iecls1').value))-1,1))='B' then
            sah2:=clientdataset1.fieldbyname('suf_b').value*(-1.00)
            else if uppercase(copy(trim(tblshedule.fieldbyname('iecls1').value),length(trim(tblshedule.fieldbyname('iecls1').value))-1,1))='C' then
            sah2:=clientdataset1.fieldbyname('suf_c').value*(-1.00);
            sah3:=clientdataset1.fieldbyname('suf_c').value*(-1.00);
            tblshedule.fieldbyname('tmu').value:=sah-sah1-sah2-sah3;
          end else
          tblshedule.fieldbyname('tmu').value:=clientdataset1.fieldbyname('tmu').value;
        end;
      end;
    end;
  end;
end;

procedure Tworksheet1.SpeedButton2Click(Sender: TObject);
begin
  with clientdataset1 do begin
    close;
    params.clear;
    commandtext:='select * from tbluser where usr='''+frmmain.ComboBox1.text+'''';
    open;
    if fieldbyname('r12').value=true then begin
      if frmqnpii=nil then frmqnpii:=tfrmqnpii.create(nil);
      frmqnpii.show;
    end else showmessage('You have no right!');
  end;
end;

procedure Tworksheet1.SpeedButton3Click(Sender: TObject);
begin
  if frmapprovalprocessing=nil then frmapprovalprocessing:=tfrmapprovalprocessing.Create(nil);
  frmapprovalprocessing.show;
end;

procedure Tworksheet1.chk7Click(Sender: TObject);
var
  cust,pline,styleno,tshop,cstyle,tplant:string;
begin
  screen.Cursor:=crSQLWait;
  if tblshedule.state=dsedit then tblshedule.post;
  if chk7.Checked then begin
    if chk1.Checked then chk1.Checked:=false;
    if chk5.Checked then chk5.Checked:=false;
    if chk8.Checked then chk8.Checked:=false;
    if chk9.Checked then chk9.Checked:=false;
    if chk10.Checked then chk10.Checked:=false;
    speedbutton1click(self);
  end;
  screen.cursor:=crdefault;
end;

procedure Tworksheet1.chk8Click(Sender: TObject);
var
  cust,pline,styleno,tshop,cstyle,tplant:string;
begin
  screen.Cursor:=crSQLWait;
  if tblshedule.state=dsedit then tblshedule.post;
  if chk8.Checked then begin
    if chk1.Checked then chk1.Checked:=false;
    if chk7.Checked then chk7.Checked:=false;
    if chk5.Checked then chk5.Checked:=false;
    if chk9.Checked then chk9.Checked:=false;
    if chk10.Checked then chk10.Checked:=false;
    speedbutton1click(self);
  end;
  screen.cursor:=crdefault;
end;

procedure Tworksheet1.chk9Click(Sender: TObject);
var
  cust,pline,styleno,tshop,cstyle,tplant:string;
begin
  screen.Cursor:=crSQLWait;
  if tblshedule.state=dsedit then tblshedule.post;
  if chk9.Checked then begin
    if chk1.Checked then chk1.Checked:=false;
    if chk7.Checked then chk7.Checked:=false;
    if chk8.Checked then chk8.Checked:=false;
    if chk5.Checked then chk5.Checked:=false;
    if chk10.Checked then chk10.Checked:=false;
    speedbutton1click(self);
  end;
  screen.cursor:=crdefault;
end;

procedure Tworksheet1.chk10Click(Sender: TObject);
var
  cust,pline,styleno,tshop,cstyle,tplant:string;
begin
  screen.Cursor:=crSQLWait;
  if tblshedule.state=dsedit then tblshedule.post;
  if chk10.Checked then begin
    if chk1.Checked then chk1.Checked:=false;
    if chk7.Checked then chk7.Checked:=false;
    if chk8.Checked then chk8.Checked:=false;
    if chk9.Checked then chk9.Checked:=false;
    if chk5.Checked then chk5.Checked:=false;
    speedbutton1click(self);
  end;
  screen.cursor:=crdefault;
end;

procedure Tworksheet1.SpeedButton4Click(Sender: TObject);
var
  cust,pline,styleno,tshop,cstyle,tplant:string;
  si:integer;
begin
  screen.cursor:=crSQLWait;

  with clientdataset1 do begin
    close;
    params.clear;
    commandtext:='execute procedure sp_calcflag4';
    execute;
  end;

  if chk6.Checked then begin
    with clientdataset2 do begin
      close;
      params.clear;
      params.createparam(ftstring,'x1',ptinput);
      commandtext:='execute procedure sp_multqns_enddt(:x1)';
      params[0].asstring:=edit6.text;
      execute;
    end;
  end;

  //if cxView1.SortedItemCount>0 then
  for si:=0 to cxView1.SortedItemCount-1 do begin
    cxView1.SortedItems[si].SortOrder:=soNone;
  end;

  if tblshedule.state=dsedit then tblshedule.post;
  cust:=edit1.text;
  pline:=edit2.text;
  //styleno:=edit3.text;
  tshop:=edit4.text;
  cstyle:=edit5.text;
  tplant:=edit6.text;
  {
  if (tshop>'') or (tplant>'') then begin
    with clientdataset2 do begin
      close;
      params.clear;
      params.createparam(ftstring,'x1',ptinput);
      params.createparam(ftstring,'x2',ptinput);
      commandtext:='execute procedure upd_tshop(:x1,:x2)';
      params[0].asstring:=tshop;
      params[1].asstring:=tplant;
      execute;
    end;
  end;
  }
  with tblshedule do begin
    close;
    params.clear;
    if chk7.Checked then params.createparam(ftdate,'x1',ptinput);
    commandtext:='select * from tblshedule where yzh=1';
    if pline>'' then commandtext:=commandtext+' and upper(pline)='''+pline+'''';
    if cust>'' then commandtext:=commandtext+' and j_no='''+cust+'''';
    if tshop>'' then commandtext:=commandtext+' and (tshop like '''+tshop+'%'')';
    if cstyle>'' then commandtext:=commandtext+' and (cstyle like '''+cstyle+'%'')';
    if tplant>'' then commandtext:=commandtext+' and tplant='''+tplant+'''';
    if combobox1.text>'' then commandtext:=commandtext+' and grp='''+combobox1.text+'''';
    if edit7.text>'' then commandtext:=commandtext+' and j_no like '''+edit7.text+'%''';
    if combobox2.text>'' then commandtext:=commandtext+' and flag6 like '''+combobox2.text+'%''';
    if combobox3.text>'' then commandtext:=commandtext+' and flag6='''+combobox3.text+'''';
    if combobox4.text>'' then commandtext:=commandtext+' and dbzs='''+combobox4.text+'''';
    if edit3.text>'' then commandtext:=commandtext+' and acol='''+edit3.text+'''';
    if edit8.text>'' then commandtext:=commandtext+' and jhrs='''+edit8.text+'''';
    if combobox5.text>'' then commandtext:=commandtext+' and flag2='''+combobox5.text+'''';
    //if chk1.Checked then commandtext:=commandtext+' and ((substr(lflag,1,1) in (''!'',''^'')) or (dta in (''1'',''5''))) and (substr(pline,1,2) not in (''SG'',''PS'',''NS'',''RS'',''SB'')) '
    if chk1.Checked then commandtext:=commandtext+' and ((substr(lflag,1,1) in (''!'')) or (dta in (''1''))) and (substr(pline,1,2) not in (''SG'',''PS'',''NS'',''RS'',''SB'')) '
                                     +'and ((fccs not like ''%u%'') and (fccs not like ''%d%'') and (fccs not like ''%D%''))';
    if chk2.Checked then commandtext:=commandtext+' and ((fccs like ''%u%'') or (fccs like ''%d%'') or (fccs like ''%D%''))';
    if chk7.Checked then commandtext:=commandtext+' and tshop in (''3A'',''3B'',''3D'',''3G'',''4A'',''4B'',''4C'',''4D'',''KB1A'',''KB1B'',''KB2'') and flag4 in (''a'') and cfksrq>:x1';//+formatdatetime('yyyy-MM-dd',date+20);
    //if chk3.Checked then commandtext:=commandtext+' and plan_date is null';
    if chk8.Checked then commandtext:=commandtext+' and yzh=1';
    if chk4.Checked then commandtext:=commandtext+' and dta in (''3'',''4'')';
    if chk9.Checked then commandtext:=commandtext+' and ((substr(lflag,1,1) in (''^'')) or (dta in (''5'') and substr(lflag,1,1) not in (''!''))) and (substr(pline,1,2) not in (''SG'',''PS'',''NS'',''RS'',''SB'')) '
                                     +'and ((fccs not like ''%u%'') and (fccs not like ''%d%'') and (fccs not like ''%D%''))';
    if chk5.Checked then commandtext:=commandtext+' and pline like ''%SB%''';
    if chk6.Checked then commandtext:=commandtext+' and substr(flag3,1,2) in (''2s'',''3s'',''4s'',''5s'',''6s'',''7s'',''8s'',''9s'')';
    if chk10.Checked then commandtext:=commandtext+' and (((fccs like ''%u%'') or (fccs like ''%d%'') or (fccs like ''%D%'')) or (dta in (''3'',''4'')) '
                                      //+'or (exists (select seq from tbl_qn_confirm b where tblshedule.pline=b.pline and tblshedule.seq=b.seq and b.qntype=''cQN'')))';
                                      +'or (substr(flag3,1,2) in (''2s'',''3s'',''4s'',''5s'',''6s'',''7s'',''8s'',''9s'')))';
    if edit8.text>'' then commandtext:=commandtext+' and upper(jhrs) like '''+edit8.text+'%''';
    if (chk1.Checked or chk2.Checked or chk4.Checked) then commandtext:=commandtext+' and pline not in (''T056F'',''T057F'')';
    //if (chk1.Checked or chk2.Checked or chk4.Checked) then indexname:='idx7'
    //else indexname:='idx1';
    if chk7.Checked then params[0].asdate:=date+60;
    open;
    editkey;
    if (chk1.Checked or chk2.Checked or chk4.Checked) then indexname:='idx7'
    else indexname:='idx1';
    setkey;
    first;
  end;
  //if chk1.Checked then dbgrideh1.Columns[0].Font.color:=clRed
  //else dbgrideh1.Columns[0].Font.color:=clBlack;
  screen.cursor:=crdefault;
end;

procedure Tworksheet1.UPDIEGRPandCLS1Click(Sender: TObject);
begin
  //
  screen.cursor:=crSQLWait;
  try
  with clientdataset1 do begin
    close;
    params.clear;
    commandtext:='execute procedure sp_updiecls_cls1';
    execute;
  end;
  speedbutton1click(self);
  finally
    screen.Cursor:=crDefault;
  end;
end;

procedure Tworksheet1.UpdateIEdataforQNGAI1Click(Sender: TObject);
begin
  with clientdataset1 do begin
    close;
    params.clear;
    params.createparam(ftstring,'x1',ptinput);
    params.createparam(ftinteger,'x2',ptinput);
    commandtext:='execute procedure sp_updline_shjs_ie(:x1,:x2)';
    params[0].asstring:=tblshedule.fieldbyname('pline').value;
    params[1].asinteger:=tblshedule.fieldbyname('seq').value;
    execute;
  end;
  showmessage('OK!');
end;

end.
