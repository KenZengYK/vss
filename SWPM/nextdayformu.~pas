unit nextdayformu;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, ppCtrls, ppBands, ppClass, ppVar, ppPrnabl, ppCache, ppComm,
  ppRelatv, ppProd, ppReport, ppViewr, Txcomp, ppStrtch, ppSubRpt, myChkBox,
  Db, ppMemo;

type
  Tfrmnextday = class(TForm)
    ppReport1: TppReport;
    ppHeaderBand1: TppHeaderBand;
    ppShape1: TppShape;
    ppLabel1: TppLabel;
    ppLabel2: TppLabel;
    ppLabel4: TppLabel;
    ppSystemVariable1: TppSystemVariable;
    ppLabel5: TppLabel;
    ppSystemVariable2: TppSystemVariable;
    ppLabel8: TppLabel;
    ppLabel9: TppLabel;
    ppLabel10: TppLabel;
    ppLabel11: TppLabel;
    ppLabel12: TppLabel;
    ppLabel16: TppLabel;
    ppLabel17: TppLabel;
    ppLabel18: TppLabel;
    ppLabel19: TppLabel;
    ppLabel21: TppLabel;
    ppLabel22: TppLabel;
    ppLabel23: TppLabel;
    ppLabel36: TppLabel;
    ppLabel37: TppLabel;
    ppLabel38: TppLabel;
    ppLabel40: TppLabel;
    ppLabel41: TppLabel;
    ppLabel56: TppLabel;
    ppLabel57: TppLabel;
    ppLabel58: TppLabel;
    ppLabel59: TppLabel;
    ppLabel77: TppLabel;
    ppLabel78: TppLabel;
    ppLabel81: TppLabel;
    ppLine2: TppLine;
    ppLine4: TppLine;
    ppLine7: TppLine;
    ppLine10: TppLine;
    ppLine11: TppLine;
    ppLine15: TppLine;
    ppLine16: TppLine;
    ppLine19: TppLine;
    ppLine22: TppLine;
    ppLabel3: TppLabel;
    ppLine24: TppLine;
    ppLine25: TppLine;
    ppLabel86: TppLabel;
    ppLabel87: TppLabel;
    ppLine26: TppLine;
    ppLine23: TppLine;
    ppLine27: TppLine;
    ppLine28: TppLine;
    ppLabel20: TppLabel;
    fty001: TppLabel;
    ppLabel24: TppLabel;
    ppLabel32: TppLabel;
    ppLine29: TppLine;
    ppLabel49: TppLabel;
    ppLabel53: TppLabel;
    ppLine30: TppLine;
    ppLabel67: TppLabel;
    ppLine31: TppLine;
    ppLine32: TppLine;
    ppLine33: TppLine;
    ppLabel72: TppLabel;
    ppLabel75: TppLabel;
    ppLabel82: TppLabel;
    ppLabel83: TppLabel;
    ppLabel84: TppLabel;
    title001: TppLabel;
    ppLabel88: TppLabel;
    ppLine34: TppLine;
    ppLabel90: TppLabel;
    ppLine35: TppLine;
    ppLabel91: TppLabel;
    ppLabel92: TppLabel;
    ppLabel94: TppLabel;
    ppLine20: TppLine;
    ppLabel13: TppLabel;
    ppLabel62: TppLabel;
    ppLabel73: TppLabel;
    ppLine1: TppLine;
    ppLabel74: TppLabel;
    ppLabel76: TppLabel;
    ppLabel96: TppLabel;
    ppLabel97: TppLabel;
    ppDetailBand1: TppDetailBand;
    ppShape12: TppShape;
    ppShape11: TppShape;
    ppShape3: TppShape;
    ppShape13: TppShape;
    ppDBText4: TppDBText;
    ppDBText5: TppDBText;
    ppDBText7: TppDBText;
    ppDBText8: TppDBText;
    ppDBText9: TppDBText;
    ppDBText14: TppDBText;
    ppDBText19: TppDBText;
    ppDBText25: TppDBText;
    ppDBText31: TppDBText;
    ppDBText29: TppDBText;
    ppDBText30: TppDBText;
    ppDBText3: TppDBText;
    ppDBText6: TppDBText;
    ppLabel15: TppLabel;
    ppDBText27: TppDBText;
    ppDBText28: TppDBText;
    ppDBText32: TppDBText;
    ppDBText34: TppDBText;
    ppDBText35: TppDBText;
    ppShape14: TppShape;
    ppDBText1: TppDBText;
    date1001: TppLabel;
    ppDBText24: TppDBText;
    lst1001: TppDBText;
    ppDBText38: TppDBText;
    ppFooterBand1: TppFooterBand;
    ppSummaryBand1: TppSummaryBand;
    ppGroup1: TppGroup;
    ppGroupHeaderBand1: TppGroupHeaderBand;
    ppGroupFooterBand1: TppGroupFooterBand;
    ppShape2: TppShape;
    ppDBCalc4: TppDBCalc;
    total001: TppLabel;
    ppLabel93: TppLabel;
    ppDBCalc10: TppDBCalc;
    ppDBCalc11: TppDBCalc;
    ppDBCalc12: TppDBCalc;
    ppLabel6: TppLabel;
    x002: TppLabel;
    ppDBCalc13: TppDBCalc;
    ppDBText10: TppDBText;
    ppDBCalc1: TppDBCalc;
    shop001: TppLabel;
    date001: TppLabel;
    ppLine3: TppLine;
    ppLabel26: TppLabel;
    ppLabel27: TppLabel;
    ppLabel28: TppLabel;
    ppLabel29: TppLabel;
    ppLabel30: TppLabel;
    ppLabel31: TppLabel;
    ppLine5: TppLine;
    ppLine8: TppLine;
    ppLabel33: TppLabel;
    ppLabel35: TppLabel;
    ppLine12: TppLine;
    ppLabel39: TppLabel;
    ppLabel42: TppLabel;
    ppLabel43: TppLabel;
    ppLabel44: TppLabel;
    ppLabel45: TppLabel;
    ppLabel46: TppLabel;
    ppLabel47: TppLabel;
    ppLine13: TppLine;
    ppDBText2: TppDBText;
    ppDBText11: TppDBText;
    ppDBText12: TppDBText;
    ppDBText13: TppDBText;
    lx01: TppDBText;
    lx02: TppDBText;
    ppDBText18: TppDBText;
    ppDBText20: TppDBText;
    ppLabel48: TppLabel;
    ppLabel50: TppLabel;
    ppLabel34: TppLabel;
    ppLabel51: TppLabel;
    ppDBCalc2: TppDBCalc;
    ppShape4: TppShape;
    ppMemo1: TppMemo;
    c_last001: TppLabel;
    ppLabel52: TppLabel;
    ppLabel54: TppLabel;
    ppLine6: TppLine;
    ppLine9: TppLine;
    ppLabel14: TppLabel;
    ppDBText17: TppDBText;
    ppLabel25: TppLabel;
    ppLabel55: TppLabel;
    ppLabel60: TppLabel;
    ppDBText23: TppDBText;
    ppLabel61: TppLabel;
    x003: TppLabel;
    ppLabel63: TppLabel;
    ppLabel64: TppLabel;
    ppLabel65: TppLabel;
    ppLabel66: TppLabel;
    zhjs01: TppLabel;
    eot01: TppLabel;
    pk001: TppLabel;
    ppShape5: TppShape;
    ppDBText22: TppDBText;
    pcflag1: TppLabel;
    ppLabel68: TppLabel;
    ppShape6: TppShape;
    ppShape7: TppShape;
    ppLine14: TppLine;
    ppLine17: TppLine;
    ppLine18: TppLine;
    ppLine21: TppLine;
    ppLine36: TppLine;
    ppLine37: TppLine;
    ppLine38: TppLine;
    ppShape8: TppShape;
    ppMemo2: TppMemo;
    procedure ppReport1PreviewFormCreate(Sender: TObject);
    procedure ppDetailBand1BeforePrint(Sender: TObject);
    procedure ppSummaryBand1BeforePrint(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  frmnextday: Tfrmnextday;

implementation

uses mainformu, achievingformu;

{$R *.dfm}

procedure Tfrmnextday.ppReport1PreviewFormCreate(Sender: TObject);
begin
  ppReport1.PreviewForm.WindowState:=wsMaximized;
  TppViewer(ppReport1.PreviewForm.Viewer).ZoomSetting:=zs100percent;
end;

procedure Tfrmnextday.ppDetailBand1BeforePrint(Sender: TObject);
var
  pc001:string;
  sc001,ba001:double;
begin
  //if frmachieving.query6.fieldbyname('eff2').value>0 then eff2002.Caption:=formatfloat('0.00',frmachieving.query6.fieldbyname('eff2').value)
  //else eff2002.Caption:='--';
  //if not frmachieving.query6.fieldbyname('date1').isnull then date1001.Caption:=formatdatetime('yy/MM/dd',frmachieving.query6.fieldbyname('date1').value)
  //else date1001.Caption:='--';
  if lst1001.Caption='x' then c_last001.Caption:=''
  else c_last001.Caption:='c';
  date1001.Caption:=formatdatetime('yy/MM/dd',frmachieving.Query6.fieldbyname('dt1').value);

  with frmachieving.Query2 do begin
    close;
    params.clear;
    params.createparam(ftstring,'x1',ptinput);
    commandtext:='select lbact from tblline where pline=:x1';
    params[0].asstring:=frmachieving.Query6.fieldbyname('pline').value;
    open;
    if fieldbyname('lbact').value=false then ppDBText29.Font.Style:=[fsBold]
    else ppDBText29.Font.Style:=[];
  end;
  if frmachieving.Query6.fieldbyname('psect').value>0.0 then begin
    zhjs01.Caption:='0.00';
    eot01.Caption:=formatfloat('0.00',frmachieving.Query6.fieldbyname('eot').value);
  end else begin
    zhjs01.Caption:='--';
    eot01.Caption:='--';
  end;
  if frmachieving.Query6.fieldbyname('aqty1').value>0 then ppdbtext13.Font.Color:=clRed else ppdbtext13.Font.Color:=clBlack;
  if not frmachieving.Query6.fieldbyname('eff2').IsNull then begin
    with frmachieving.query3 do begin
      close;
      params.clear;
      params.createparam(ftstring,'x1',ptinput);
      params.createparam(ftinteger,'x2',ptinput);
      params.createparam(ftdate,'x3',ptinput);
      commandtext:='select sum(eff1*csect)/sum(csect) as e1,sum(eff2*csect)/sum(csect) as e2 from line_shjs where pline=:x1 and seq=:x2 and dt1<:x3 and flag=''0''';
      params[0].asstring:=frmachieving.Query6.fieldbyname('pline').value;
      params[1].asinteger:=frmachieving.query6.fieldbyname('seq').value;
      params[2].asdate:=frmachieving.query6.fieldbyname('dt1').value;
      open;
      if not fieldbyname('e1').isnull then begin
        if not fieldbyname('e2').isnull then begin
          if fieldbyname('e2').value<fieldbyname('e1').value then ppdbtext17.Font.Color:=clRed else ppdbtext17.Font.Color:=clBlack;
        end else ppdbtext17.Font.Color:=clBlack;
      end else ppdbtext17.Font.Color:=clBlack;
    end;
  end;
  {
  if frmachieving.query6.fieldbyname('scqty').value>0 then
  pk001.Caption:=formatfloat('#0',frmachieving.query6.fieldbyname('scqty').value) else pk001.Caption:='--';}
  //ppDBText29.Font.Style:=[fsBold];
  //if frmachieving.query6.fieldbyname('dbxl').value=0 then dbxl01.Caption:='--'
  //else dbxl01.caption:=formatfloat('0.00',frmachieving.query6.fieldbyname('dbxl').value);
  //pcflag1 & scqty1 & bal001
  with frmachieving.query2 do begin
    close;
    params.clear;
    params.createparam(ftstring,'x1',ptinput);
    params.createparam(ftinteger,'x2',ptinput);
    commandtext:='select cfmd from tbl_lwo_dt where pline=:x1 and seq=:x2';
    params[0].asstring:=frmachieving.Query6.fieldbyname('pline').value;
    params[1].asinteger:=frmachieving.Query6.fieldbyname('seq').value;
    open;
    if fieldbyname('cfmd').isnull then pc001:='0'
    else if fieldbyname('cfmd').value=true then pc001:='1'
    else pc001:='0';
  end;
  with frmachieving.query2 do begin
    close;
    params.clear;
    params.createparam(ftstring,'x1',ptinput);
    params.createparam(ftinteger,'x2',ptinput);
    commandtext:='select sum(pqty) as q1,sum(tqty) as q2 from tbl_lwo where pline=:x1 and seq=:x2';
    params[0].asstring:=frmachieving.Query6.fieldbyname('pline').value;
    params[1].asinteger:=frmachieving.Query6.fieldbyname('seq').value;
    open;
    if not fieldbyname('q1').isnull then begin
      if pc001='0' then sc001:=fieldbyname('q1').value
      else sc001:=fieldbyname('q2').value;
    end else sc001:=frmachieving.Query6.fieldbyname('scqty').value;
  end;
  if pc001='0' then pcflag1.Caption:='p'
  else pcflag1.Caption:='C';
  pk001.Caption:=formatfloat('#0',sc001);
  if frmachieving.query6.FieldByName('sjrs1').value<frmachieving.query6.fieldbyname('sjrs2').value then
  lx01.Font.Color:=clRed else lx01.Font.Color:=clBlack;
end;

procedure Tfrmnextday.ppSummaryBand1BeforePrint(Sender: TObject);
var
  s1,s2,s3,s4,s5:string;
  str1,str2:string;
begin
  s1:='';s2:='';s3:='';s4:='';s5:='';
  with frmachieving.query2 do begin
    close;
    params.clear;
    params.createparam(ftdatetime,'x1',ptinput);
    params.createparam(ftdate,'x2',ptinput);
    commandtext:='select count(distinct cstyle) as c1,count(distinct pline) as p1,count(distinct j_no) as p2,count(*) as s4,count(distinct acol) as s5 from line_shjs_next where flag=''0'' and tm=:x1 and dt1>=:x2';
    params[0].asdatetime:=frmachieving.Query6.fieldbyname('tm').value;
    params[1].asdate:=frmachieving.Query6.fieldbyname('dt1').value;
    open;
    if not fieldbyname('p2').isnull then s1:='project :  '+fieldbyname('p2').asstring+'    ';
    if not fieldbyname('c1').IsNull then s2:='cust style :  '+fieldbyname('c1').asstring+'    ';
    if not fieldbyname('p1').isnull then s3:='line :  '+fieldbyname('p1').asstring+'    ';
    if not fieldbyname('s4').isnull then s4:='QN :  '+fieldbyname('s4').asstring+'    ';
    if not fieldbyname('s5').isnull then s4:='Clr :  '+fieldbyname('s5').asstring+'    ';
  end;
  //x003.Caption:='0.00';
  with frmachieving.query2 do begin
    close;
    params.clear;
    params.createparam(ftdatetime,'x1',ptinput);
    params.createparam(ftdate,'x2',ptinput);
    commandtext:='select sum(eff1*psect)/sum(psect) as s1,sum(dbxl*psect)/sum(psect) as s2 from line_shjs_next where flag=''0'' and tm=:x1 and dt1>=:x2';
    params[0].asdatetime:=frmachieving.Query6.fieldbyname('tm').value;
    params[1].asdate:=frmachieving.Query6.fieldbyname('dt1').value;
    open;
    if not fieldbyname('s1').isnull then x002.Caption:=formatfloat('0.00',fieldbyname('s1').value)
    else x002.Caption:='0.00';
    //if not fieldbyname('s2').isnull then dbxl02.Caption:=formatfloat('0.00',fieldbyname('s2').value)
    //else dbxl02.Caption:='0.00';
    //if not fieldbyname('s3').isnull then x003.caption:=formatfloat('0.00',fieldbyname('s3').Value)
    //else x003.Caption:='0.00';
  end;
  with frmachieving.query2 do begin
    close;
    params.clear;
    params.createparam(ftdatetime,'x1',ptinput);
    params.createparam(ftdate,'x2',ptinput);
    commandtext:='select sum(eff2*psect)/sum(psect) as s3 from line_shjs_next where flag=''0'' and tm=:x1 and dt1>=:x2 and psect>0 and (lst='''' or lst is null)';
    params[0].asdatetime:=frmachieving.Query6.fieldbyname('tm').value;
    params[1].asdate:=frmachieving.Query6.fieldbyname('dt1').value;
    open;
    if not fieldbyname('s3').isnull then x003.caption:=formatfloat('0.00',fieldbyname('s3').Value)
    else x003.Caption:='0.00';
  end;
  total001.Caption:=s1+s2+s3+s4+s5;
  ppMemo1.Lines.Clear;
  ppMemo1.Lines.Add('Linkage Time(LT):');
  //try
  with frmachieving.query2 do begin
    close;
    params.clear;
    params.createparam(ftdate,'x0',ptinput);
    params.createparam(ftdate,'x1',ptinput);
    params.createparam(ftdate,'x2',ptinput);
    commandtext:='select distinct pline,seq from tblshedule where ltc_ksrq=:x0';
    if frmachieving.combobox1.text>'' then commandtext:=commandtext+' and tplant='''+frmachieving.combobox1.text+'''';
    if frmachieving.combobox2.Text>'' then commandtext:=commandtext+' and tshop='''+frmachieving.combobox2.text+'''';
    commandtext:=commandtext+' union select distinct pline,max(seq) as seq from tblshedule b where ((cfwcrq=:x1) or (ltc_ksrq=:x2))';
    if frmachieving.combobox1.text>'' then commandtext:=commandtext+' and tplant='''+frmachieving.combobox1.text+'''';
    if frmachieving.combobox2.Text>'' then commandtext:=commandtext+' and tshop='''+frmachieving.combobox2.text+'''';
    commandtext:=commandtext+' and (ltc_ksrq is not null) group by pline';
    params[0].asdate:=frmachieving.Query6.fieldbyname('dt1').value;//frmachieving.dateedit1.Date+1;
    params[1].asdate:=frmachieving.Query6.fieldbyname('dt1').value;//frmachieving.dateedit1.date+1;
    params[2].asdate:=frmachieving.Query6.fieldbyname('dt1').value;//frmachieving.dateedit1.date+1;
    open;
    first;
    while not eof do begin
      with frmachieving.Query3 do begin
        close;
        params.clear;
        params.createparam(ftstring,'x1',ptinput);
        params.createparam(ftinteger,'x2',ptinput);
        //commandtext:='select a.ltc_d,a.cfwcrq,a.cfwcjs,a.ltc_ksrq,a.ltc_ksjs,a.flag3,b.lst1 from tblshedule a,line_shjs b where a.pline=b.pline and a.seq=b.seq and a.pline=:x1 and seq=:x2';// and b.lst1>=''x''';
        params.Createparam(ftdate,'x3',ptinput);
        commandtext:='select a.ltc_d,a.cfwcrq,a.cfwcjs,a.ltc_ksrq,a.ltc_ksjs,a.flag3,b.lst1 from tblshedule a,line_shjs b '
                    +'where a.pline=b.pline and a.seq=b.seq and a.pline=:x1 and seq=:x2 and b.flag=''0'' '
                    +'and b.dt1=:x3 and ((a.ltc_ksrq=b.dt1) or (a.ltc_ksrq<b.dt1 and a.cfwcrq=b.dt1))';
        params[0].asstring:=frmachieving.query2.fieldbyname('pline').value;
        params[1].asinteger:=frmachieving.query2.fieldbyname('seq').value;
        params[2].asdate:=frmachieving.Query6.fieldbyname('dt1').value;
        open;
        if not fieldbyname('lst1').isnull then str2:=fieldbyname('lst1').value else str2:='c';
        if not fieldbyname('flag3').isnull then begin
          if pos('x',fieldbyname('flag3').value)>0 then str2:='c';
        end;
        if not fieldbyname('ltc_d').isnull then begin
          str1:=frmachieving.query2.fieldbyname('pline').value+':  LT'+str2+' = '+formatfloat('0.0',fieldbyname('ltc_d').value)+' sect hr';
          str1:=str1+'  (from '+formatdatetime('yy/MM/dd',fieldbyname('cfwcrq').value)+'  '+formatfloat('0.0',fieldbyname('cfwcjs').value)+' sect hr';
          str1:=str1+'  to '+formatdatetime('yy/MM/dd',fieldbyname('ltc_ksrq').value)+'  '+formatfloat('0.0',fieldbyname('ltc_ksjs').value)+' sect hr)';
        end;
        ppmemo1.Lines.add(str1);
      end;
      application.ProcessMessages;
      next;
    end;
  end;
  {
  with frmachieving.query3 do begin
    close;
    params.clear;
    params.createparam(ftdate,'x1',ptinput);
    params.createparam(ftdate,'x2',ptinput);
    commandtext:='select pline,seq,ltc_d,cfwcrq,cfwcjs,ltc_ksrq,ltc_ksjs from tblshedule where ((cfwcrq=:x1) or (ltc_ksrq=:x2)) and (ltc_ksrq is not null)';
    params[0].asdate:=frmachieving.Query6.fieldbyname('dt1').value;//frmachieving.dateedit1.Date+1;
    params[1].asdate:=frmachieving.Query6.fieldbyname('dt1').value;//frmachieving.dateedit1.date+1;
    open;
    first;
    while not eof do begin
      with frmachieving.query2 do begin
        close;
        params.createparam(ftstring,'x1',ptinput);
        params.createparam(ftinteger,'x2',ptinput);
        commandtext:='select lst1 from line_shjs where pline=:x1 and seq=:x2';
        params[0].asstring:=frmachieving.query3.fieldbyname('pline').value;
        params[1].asinteger:=frmachieving.query3.fieldbyname('seq').value;
        open;
        if not fieldbyname('lst1').isnull then str2:=fieldbyname('lst1').value else str2:='c';
      end;
      str1:=fieldbyname('pline').value+':  LTC'+str2+' = '+formatfloat('0.0',fieldbyname('ltc_d').value);
      str1:=str1+'  from '+formatdatetime('yy/MM/dd',fieldbyname('cfwcrq').value)+'  '+formatfloat('0.0',fieldbyname('cfwcjs').value);
      str1:=str1+'  to '+formatdatetime('yy/MM/dd',fieldbyname('ltc_ksrq').value)+'  '+formatfloat('0.0',fieldbyname('ltc_ksjs').value);
      ppmemo1.Lines.add(str1);
      //ppmemo1.Lines.Add(fieldbyname('pline').value+' :  LTC = '+formatfloat('0.0',fieldbyname('ltc_d').value)+'  from '+formatdatetime('yy);
      application.ProcessMessages;
      next;
    end;
  end;
  }
  //except
  //end;
end;

end.
