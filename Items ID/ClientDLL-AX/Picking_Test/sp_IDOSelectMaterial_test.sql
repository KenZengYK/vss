
drop PROCEDURE ZPHLIB_AUL.sp_IDOSelectMaterial_Test;

CREATE PROCEDURE ZPHLIB_AUL.sp_IDOSelectMaterial_Test(
  IN i_CONO char(2),IN i_Prjno varchar(20),IN i_Worder varchar(7)
)LANGUAGE SQL
DYNAMIC RESULT SETS 1
BEGIN
        DECLARE CUR CURSOR WITH RETURN FOR
	
        SELECT DISTINCT B.CUSO40 AS PRJNO,A.W1RF40 AS SOPNO,ODSC41 AS OPERDESC,OPCD41 AS OPCD,
           WORD42 AS WORDER,OPSQ42 AS OPER,CATN71 AS MCODE,SUM(IFNULL(CORQ42,0)-IFNULL(COIS42,0)) AS QTY,
           WUOM42 AS UOM,AQTY71 AS QTY_ALLOC,SREF71 AS IDNO,OPSQ42 AS ISCHECK,STRC60 AS STOCKROOM,
           CH0T84,CH6T84,CH8V84,CH5T84,CH4T84,CH9T84,SPC235,IUNT35,CAST('' AS VARCHAR(10)) AS PGMN35,
	   C.TLIN40,VCAT01 AS PHISM,CAST('' AS VARCHAR(50)) as LOCKBH
        FROM TSTT5F1.MSP42,TSTT5F1.MSP41,TSTT5F1.MSP40 A,TSTT4F1.OEP40 B,
	TSTT2F1.INP60
	  LEFT JOIN TSTT4F1.PMP01 ON (CONO01=CONO60 AND ITEM01=PNUM60 AND VNDR01=SUC160),
	AULT4F1.INP71 
          LEFT JOIN  TSTT4F1.APP84   ON (CONO84=CONO71 AND LOTN84=SREF71 AND PNUM84=CATN71)
          LEFT JOIN  TSTT2F1.INP35   ON (CONO35=CONO71 AND PNUM35=CATN71)
          LEFT JOIN  TSTT2F1.INP40 C ON (C.CONO40=CONO71 AND C.TREF40=SUBSTR(CATN71,1,9) AND C.USGC40='1' AND C.TLNO40=2)
        WHERE CONO42=A.CONO40 AND WORD42=A.WORD40 AND CONO42=CONO41 AND WORD42=WORD41 
          AND OPSQ42=OPSQ41 AND CONO71=CONO42 AND SUBSTR(DREF71,1,7)=WORD42 AND COMP42=CATN71 
          AND SUBSTR(DREF71,8,4)=SUBSTR('000'||CAST(OPSQ42 AS VARCHAR(4)),LENGTH('000'||CAST(OPSQ42 AS VARCHAR(4)))-3,4) 
          AND A.CONO40=B.CONO40 AND SUBSTR(A.W1RF40,1,7)=B.ORDN40 AND B.DTLC40=0
	  AND CONO42=CONO60 AND COMP42=PNUM60 AND LOCD71=STRC60 AND LOCD71<>'SC' AND LOCD71<>'ST'/*ISTR42=STRC60*/
          AND CONO42=I_CONO 
	  and (i_Prjno='' or (i_Prjno<>'' and B.CUSO40=i_Prjno))
	  and (i_Worder='' or (i_Worder<>'' and WORD42=i_Worder))

	GROUP BY B.CUSO40,A.W1RF40,ODSC41,OPCD41,WORD42,OPSQ42,CATN71,WUOM42,AQTY71,SREF71,STRC60,
	         CH0T84,CH6T84,CH8V84,CH5T84,CH4T84,CH9T84,SPC235,IUNT35,CH8T84,C.TLIN40,VCAT01 
        ORDER BY WORDER,OPER,MCODE;

        OPEN CUR ;

 END; 